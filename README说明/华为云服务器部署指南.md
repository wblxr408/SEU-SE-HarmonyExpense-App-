# 华为云服务器部署指南

## 1. 概述

本文档详细说明如何在华为云上部署 HarmonyOS 应用的后端服务，包括服务器选型、环境配置、数据库部署、应用部署、安全配置和运维监控等完整流程。

## 2. 华为云产品选型

### 2.1 计算服务

#### 2.1.1 弹性云服务器 ECS（推荐）

**适用场景**：中小型应用、可预测负载

**推荐配置**：
- **入门级**：通用计算型 s6.large.2（2核4GB）
  - 适合：开发测试环境
  - 价格：约 ¥0.3/小时
  
- **标准级**：通用计算型 s6.xlarge.2（4核8GB）
  - 适合：生产环境（1000-5000 用户）
  - 价格：约 ¥0.6/小时
  
- **高性能级**：通用计算型 s6.2xlarge.2（8核16GB）
  - 适合：大规模生产环境（5000+ 用户）
  - 价格：约 ¥1.2/小时

**操作系统选择**：
- Ubuntu 22.04 LTS（推荐）
- CentOS 8 Stream
- openEuler 22.03 LTS

#### 2.1.2 云容器引擎 CCE（可选）

**适用场景**：微服务架构、需要弹性伸缩

**优势**：
- 自动扩缩容
- 容器编排
- 服务网格
- CI/CD 集成

### 2.2 数据库服务

#### 2.2.1 云数据库 RDS for MySQL（推荐）

**推荐配置**：
- **入门级**：通用型 rds.mysql.s1.medium（1核2GB）
  - 存储：100GB SSD
  - 价格：约 ¥0.4/小时
  
- **标准级**：通用型 rds.mysql.s1.large（2核4GB）
  - 存储：200GB SSD
  - 价格：约 ¥0.8/小时

**特性**：
- 自动备份
- 主从复制
- 读写分离
- 监控告警

#### 2.2.2 云数据库 RDS for PostgreSQL（可选）

适合需要复杂查询和 JSON 支持的场景。

#### 2.2.3 文档数据库 DDS（MongoDB）（可选）

适合非结构化数据存储。

### 2.3 存储服务

#### 2.3.1 对象存储服务 OBS

**用途**：
- 用户上传文件（头像、附件）
- 数据备份文件
- 静态资源（图片、视频）

**推荐配置**：
- 标准存储类
- 100GB 起步
- 价格：约 ¥0.099/GB/月

#### 2.3.2 云硬盘 EVS

**用途**：
- 应用数据存储
- 数据库数据盘
- 日志存储

**推荐配置**：
- 高IO型（SSD）
- 100-500GB
- 价格：约 ¥0.8/GB/月

### 2.4 网络服务

#### 2.4.1 弹性公网IP EIP

**推荐配置**：
- 带宽：5-10 Mbps（按需）
- 计费模式：按流量计费
- 价格：约 ¥0.8/GB

#### 2.4.2 弹性负载均衡 ELB

**用途**：
- 流量分发
- 高可用保障
- SSL 卸载

**推荐配置**：
- 应用型负载均衡
- 价格：约 ¥0.05/小时 + 流量费

### 2.5 安全服务

#### 2.5.1 Web 应用防火墙 WAF

**功能**：
- SQL 注入防护
- XSS 攻击防护
- CC 攻击防护

#### 2.5.2 DDoS 高防

**功能**：
- DDoS 攻击防护
- 流量清洗

## 3. 服务器环境搭建

### 3.1 创建 ECS 实例

#### 3.1.1 通过控制台创建

1. 登录华为云控制台
2. 进入 **弹性云服务器 ECS** 服务
3. 点击 **购买弹性云服务器**
4. 配置参数：
   - 区域：华南-广州（或就近选择）
   - 可用区：随机分配
   - 规格：s6.xlarge.2（4核8GB）
   - 镜像：Ubuntu 22.04 server 64bit
   - 系统盘：高IO 100GB
   - 网络：自动创建 VPC
   - 安全组：开放 22、80、443、3000 端口
   - 弹性公网IP：自动分配
   - 登录方式：密钥对（推荐）

5. 确认配置并购买

#### 3.1.2 通过 CLI 创建

```bash
# 安装华为云 CLI
pip install huaweicloudcli

# 配置认证
hcloud configure

# 创建 ECS 实例
hcloud ecs create \
  --name harmony-app-server \
  --flavor s6.xlarge.2 \
  --image Ubuntu-22.04-server-64bit \
  --vpc-id <vpc-id> \
  --subnet-id <subnet-id> \
  --security-group-id <sg-id> \
  --key-name <key-pair-name> \
  --eip-bandwidth 5
```

### 3.2 连接服务器

```bash
# 使用密钥对连接
ssh -i ~/.ssh/harmony-key.pem root@<EIP地址>

# 首次连接后更新系统
apt update && apt upgrade -y
```

### 3.3 安装基础软件

#### 3.3.1 安装 Node.js

```bash
# 安装 Node.js 20.x LTS
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt install -y nodejs

# 验证安装
node --version  # v20.x.x
npm --version   # 10.x.x

# 安装 pnpm（推荐）
npm install -g pnpm
```

#### 3.3.2 安装 Nginx

```bash
# 安装 Nginx
apt install -y nginx

# 启动 Nginx
systemctl start nginx
systemctl enable nginx

# 验证
systemctl status nginx
```

#### 3.3.3 安装 PM2（进程管理）

```bash
# 安装 PM2
npm install -g pm2

# 设置开机自启
pm2 startup systemd
```

#### 3.3.4 安装 Git

```bash
apt install -y git

# 配置 Git
git config --global user.name "Your Name"
git config --global user.email "your@email.com"
```


#### 3.3.5 安装 Docker（可选）

```bash
# 安装 Docker
curl -fsSL https://get.docker.com | bash

# 启动 Docker
systemctl start docker
systemctl enable docker

# 验证
docker --version
```

### 3.4 配置防火墙

```bash
# 安装 UFW
apt install -y ufw

# 配置规则
ufw allow 22/tcp    # SSH
ufw allow 80/tcp    # HTTP
ufw allow 443/tcp   # HTTPS
ufw allow 3000/tcp  # Node.js 应用（可选，建议通过 Nginx 代理）

# 启用防火墙
ufw enable

# 查看状态
ufw status
```

## 4. 数据库部署

### 4.1 使用华为云 RDS（推荐）

#### 4.1.1 创建 RDS 实例

1. 登录华为云控制台
2. 进入 **云数据库 RDS** 服务
3. 点击 **购买数据库实例**
4. 配置参数：
   - 数据库引擎：MySQL 8.0
   - 实例规格：通用型 rds.mysql.s1.large（2核4GB）
   - 存储类型：SSD 云盘
   - 存储空间：200GB
   - VPC：选择与 ECS 相同的 VPC
   - 安全组：允许 ECS 

#### 3.3.5 安装 Docker（可选）

```bash
# 安装 Docker
curl -fsSL https://get.docker.com | sh

# 启动 Docker
systemctl start docker
systemctl enable docker

# 验证
docker --version
```

### 3.4 配置防火墙

```bash
# 安装 UFW
apt install -y ufw

# 配置规则
ufw allow 22/tcp    # SSH
ufw allow 80/tcp    # HTTP
ufw allow 443/tcp   # HTTPS
ufw allow 3000/tcp  # 应用端口

# 启用防火墙
ufw enable

# 查看状态
ufw status
```

## 4. 数据库部署

### 4.1 使用云数据库 RDS（推荐）

#### 4.1.1 创建 RDS 实例

1. 进入 **云数据库 RDS** 服务
2. 点击 **购买数据库实例**
3. 配置参数：
   - 数据库引擎：MySQL 8.0
   - 实例规格：通用型 2核4GB
   - 存储类型：SSD 云盘
   - 存储空间：200GB
   - VPC：选择与 ECS 相同的 VPC
   - 安全组：允许 ECS 访问 3306 端口
   - 数据库名称：harmony_expense
   - 管理员账号：admin
   - 管理员密码：设置强密码

4. 确认并购买

#### 4.1.2 配置数据库

```bash
# 在 ECS 上安装 MySQL 客户端
apt install -y mysql-client

# 连接到 RDS
mysql -h <RDS内网地址> -u admin -p

# 创建数据库
CREATE DATABASE harmony_expense CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建应用用户
CREATE USER 'app_user'@'%' IDENTIFIED BY 'strong_password';
GRANT ALL PRIVILEGES ON harmony_expense.* TO 'app_user'@'%';
FLUSH PRIVILEGES;

# 退出
EXIT;
```

### 4.2 自建 MySQL（备选方案）

```bash
# 安装 MySQL
apt install -y mysql-server

# 安全配置
mysql_secure_installation

# 配置远程访问（谨慎）
nano /etc/mysql/mysql.conf.d/mysqld.cnf
# 修改 bind-address = 0.0.0.0

# 重启 MySQL
systemctl restart mysql
```

## 5. 应用部署

### 5.1 准备应用代码

#### 5.1.1 创建应用目录

```bash
# 创建应用目录
mkdir -p /opt/harmony-app
cd /opt/harmony-app

# 克隆代码（假设使用 Git）
git clone https://github.com/your-repo/harmony-backend.git .

# 或者上传代码
# scp -r ./backend root@<EIP>:/opt/harmony-app/
```

#### 5.1.2 安装依赖

```bash
# 安装项目依赖
pnpm install --production

# 或使用 npm
npm install --production
```

### 5.2 配置环境变量

```bash
# 创建环境配置文件
nano .env
```

```env
# 应用配置
NODE_ENV=production
PORT=3000
APP_NAME=HarmonyExpense

# 数据库配置
DB_HOST=<RDS内网地址>
DB_PORT=3306
DB_NAME=harmony_expense
DB_USER=app_user
DB_PASSWORD=strong_password

# Redis 配置（如果使用）
REDIS_HOST=<Redis地址>
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT 配置
JWT_SECRET=your-super-secret-key-change-this
JWT_EXPIRES_IN=7d

# 华为云 OBS 配置
OBS_ENDPOINT=https://obs.cn-south-1.myhuaweicloud.com
OBS_ACCESS_KEY=<AccessKey>
OBS_SECRET_KEY=<SecretKey>
OBS_BUCKET=harmony-app-files

# 日志配置
LOG_LEVEL=info
LOG_DIR=/var/log/harmony-app
```

### 5.3 使用 PM2 部署

#### 5.3.1 创建 PM2 配置文件

```bash
nano ecosystem.config.js
```

```javascript
module.exports = {
  apps: [{
    name: 'harmony-app',
    script: './dist/main.js',  // 或 './src/index.js'
    instances: 2,              // 进程数量（建议 CPU 核心数）
    exec_mode: 'cluster',      // 集群模式
    watch: false,              // 生产环境不监听文件变化
    max_memory_restart: '1G',  // 内存超过 1GB 自动重启
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: '/var/log/harmony-app/error.log',
    out_file: '/var/log/harmony-app/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    autorestart: true,
    max_restarts: 10,
    min_uptime: '10s'
  }]
};
```

#### 5.3.2 启动应用

```bash
# 创建日志目录
mkdir -p /var/log/harmony-app

# 启动应用
pm2 start ecosystem.config.js

# 查看状态
pm2 status

# 查看日志
pm2 logs harmony-app

# 保存 PM2 配置
pm2 save
```

### 5.4 配置 Nginx 反向代理

#### 5.4.1 创建 Nginx 配置

```bash
nano /etc/nginx/sites-available/harmony-app
```

```nginx
# HTTP 配置（重定向到 HTTPS）
server {
    listen 80;
    server_name api.yourdomain.com;
    
    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

# HTTPS 配置
server {
    listen 443 ssl http2;
    server_name api.yourdomain.com;
    
    # SSL 证书配置
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    
    # SSL 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 日志配置
    access_log /var/log/nginx/harmony-app-access.log;
    error_log /var/log/nginx/harmony-app-error.log;
    
    # 客户端上传大小限制
    client_max_body_size 50M;
    
    # 反向代理配置
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        
        # 请求头配置
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 缓存配置
        proxy_cache_bypass $http_upgrade;
    }
    
    # 静态文件缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        proxy_pass http://127.0.0.1:3000;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # 健康检查
    location /health {
        proxy_pass http://127.0.0.1:3000/health;
        access_log off;
    }
}
```

#### 5.4.2 启用配置

```bash
# 创建软链接
ln -s /etc/nginx/sites-available/harmony-app /etc/nginx/sites-enabled/

# 测试配置
nginx -t

# 重启 Nginx
systemctl restart nginx
```

## 6. SSL 证书配置

### 6.1 使用 Let's Encrypt 免费证书

```bash
# 安装 Certbot
apt install -y certbot python3-certbot-nginx

# 申请证书
certbot --nginx -d api.yourdomain.com

# 自动续期（Certbot 会自动配置）
certbot renew --dry-run
```

### 6.2 使用华为云 SSL 证书服务

1. 进入 **SSL证书管理** 服务
2. 购买或申请免费证书
3. 下载 Nginx 格式证书
4. 上传到服务器

```bash
# 创建证书目录
mkdir -p /etc/nginx/ssl

# 上传证书文件
scp fullchain.pem root@<EIP>:/etc/nginx/ssl/
scp privkey.pem root@<EIP>:/etc/nginx/ssl/

# 设置权限
chmod 600 /etc/nginx/ssl/*.pem
```

## 7. 对象存储 OBS 配置

### 7.1 创建 OBS 桶

1. 进入 **对象存储服务 OBS**
2. 点击 **创建桶**
3. 配置参数：
   - 桶名称：harmony-app-files
   - 区域：华南-广州
   - 存储类别：标准存储
   - 桶策略：私有
   - 版本控制：关闭

### 7.2 配置访问密钥

1. 进入 **我的凭证** > **访问密钥**
2. 点击 **新增访问密钥**
3. 下载并保存 AccessKey 和 SecretKey
4. 配置到应用的 .env 文件

### 7.3 配置 CORS（跨域）

```json
[
  {
    "allowedOrigin": ["https://yourdomain.com"],
    "allowedMethod": ["GET", "POST", "PUT", "DELETE"],
    "allowedHeader": ["*"],
    "maxAgeSeconds": 3600
  }
]
```

## 8. 数据库备份策略

### 8.1 RDS 自动备份

1. 进入 RDS 实例详情
2. 点击 **备份恢复** > **备份策略**
3. 配置：
   - 自动备份：开启
   - 备份时间：凌晨 2:00-3:00
   - 备份保留天数：7天
   - 备份周期：每天

### 8.2 手动备份脚本

```bash
# 创建备份脚本
nano /opt/scripts/backup-db.sh
```

```bash
#!/bin/bash

# 配置
DB_HOST="<RDS地址>"
DB_USER="admin"
DB_PASS="password"
DB_NAME="harmony_expense"
BACKUP_DIR="/opt/backups/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/${DB_NAME}_${DATE}.sql.gz"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -h $DB_HOST -u $DB_USER -p$DB_PASS $DB_NAME | gzip > $BACKUP_FILE

# 上传到 OBS
obsutil cp $BACKUP_FILE obs://harmony-app-backups/mysql/

# 删除 7 天前的本地备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "Backup completed: $BACKUP_FILE"
```

```bash
# 设置执行权限
chmod +x /opt/scripts/backup-db.sh

# 配置定时任务
crontab -e

# 添加：每天凌晨 3 点执行备份
0 3 * * * /opt/scripts/backup-db.sh >> /var/log/backup.log 2>&1
```

## 9. 监控与日志

### 9.1 使用华为云 CES（云监控服务）

1. 进入 **云监控服务 CES**
2. 自动监控 ECS 指标：
   - CPU 使用率
   - 内存使用率
   - 磁盘使用率
   - 网络流量

3. 配置告警规则：
   - CPU > 80% 持续 5 分钟
   - 内存 > 85% 持续 5 分钟
   - 磁盘 > 90%

### 9.2 应用日志管理

```bash
# 安装日志轮转工具
apt install -y logrotate

# 配置日志轮转
nano /etc/logrotate.d/harmony-app
```

```
/var/log/harmony-app/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 root root
    sharedscripts
    postrotate
        pm2 reloadLogs
    endscript
}
```

### 9.3 使用 PM2 监控

```bash
# 安装 PM2 Plus（可选）
pm2 link <secret_key> <public_key>

# 查看实时监控
pm2 monit

# 查看详细信息
pm2 show harmony-app
```

## 10. 安全加固

### 10.1 SSH 安全配置

```bash
# 编辑 SSH 配置
nano /etc/ssh/sshd_config
```

```
# 禁用 root 密码登录
PermitRootLogin prohibit-password

# 禁用密码认证（仅使用密钥）
PasswordAuthentication no

# 修改 SSH 端口（可选）
Port 2222

# 限制登录尝试
MaxAuthTries 3
```

```bash
# 重启 SSH 服务
systemctl restart sshd
```

### 10.2 配置 Fail2Ban

```bash
# 安装 Fail2Ban
apt install -y fail2ban

# 配置
nano /etc/fail2ban/jail.local
```

```ini
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5

[sshd]
enabled = true
port = 22
logpath = /var/log/auth.log

[nginx-http-auth]
enabled = true
port = http,https
logpath = /var/log/nginx/error.log
```

```bash
# 启动 Fail2Ban
systemctl start fail2ban
systemctl enable fail2ban
```

### 10.3 定期更新系统

```bash
# 创建更新脚本
nano /opt/scripts/system-update.sh
```

```bash
#!/bin/bash
apt update
apt upgrade -y
apt autoremove -y
apt autoclean
```

```bash
chmod +x /opt/scripts/system-update.sh

# 每周日凌晨 4 点自动更新
crontab -e
0 4 * * 0 /opt/scripts/system-update.sh >> /var/log/system-update.log 2>&1
```

## 11. CI/CD 自动化部署

### 11.1 使用 GitHub Actions

创建 `.github/workflows/deploy.yml`：

```yaml
name: Deploy to Huawei Cloud

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    - name: Install dependencies
      run: pnpm install
    
    - name: Build
      run: pnpm build
    
    - name: Deploy to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "dist/*,package.json,ecosystem.config.js"
        target: "/opt/harmony-app"
    
    - name: Restart application
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /opt/harmony-app
          pnpm install --production
          pm2 reload ecosystem.config.js
```

### 11.2 使用华为云 CodeArts

1. 进入 **CodeArts** 服务
2. 创建项目并关联代码仓库
3. 配置构建任务
4. 配置部署任务
5. 设置自动触发

## 12. 性能优化

### 12.1 启用 Gzip 压缩

```nginx
# 在 Nginx 配置中添加
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml text/javascript 
           application/json application/javascript application/xml+rss;
```

### 12.2 配置 Redis 缓存

```bash
# 安装 Redis
apt install -y redis-server

# 配置 Redis
nano /etc/redis/redis.conf

# 修改：
bind 127.0.0.1
maxmemory 256mb
maxmemory-policy allkeys-lru

# 重启 Redis
systemctl restart redis-server
```

### 12.3 使用 CDN 加速

1. 进入 **CDN** 服务
2. 添加加速域名
3. 配置源站（OBS 或 ECS）
4. 配置缓存规则
5. 配置 HTTPS

## 13. 成本优化建议

### 13.1 使用包年包月

- ECS、RDS 使用包年包月可节省 30-50%
- 长期使用建议购买 1-3 年

### 13.2 使用竞价实例

- 开发测试环境可使用竞价实例
- 成本可降低 80-90%

### 13.3 合理配置资源

- 根据实际负载调整规格
- 使用弹性伸缩自动调整
- 定期清理无用资源

## 14. 故障排查

### 14.1 常见问题

**应用无法启动**：
```bash
# 查看 PM2 日志
pm2 logs harmony-app --lines 100

# 查看系统日志
journalctl -u nginx -n 50
```

**数据库连接失败**：
```bash
# 测试数据库连接
mysql -h <RDS地址> -u app_user -p

# 检查安全组规则
# 确保 ECS 可以访问 RDS 的 3306 端口
```

**Nginx 502 错误**：
```bash
# 检查应用是否运行
pm2 status

# 检查端口占用
netstat -tlnp | grep 3000

# 查看 Nginx 错误日志
tail -f /var/log/nginx/harmony-app-error.log
```

### 14.2 性能问题排查

```bash
# 查看系统资源
htop

# 查看磁盘 IO
iotop

# 查看网络连接
netstat -an | grep ESTABLISHED | wc -l

# 查看慢查询
mysql -h <RDS地址> -u admin -p -e "SHOW FULL PROCESSLIST;"
```

## 15. 总结

本指南涵盖了在华为云上部署 HarmonyOS 应用后端服务的完整流程，包括：

- ✅ 服务器选型与创建
- ✅ 环境配置与软件安装
- ✅ 数据库部署与配置
- ✅ 应用部署与进程管理
- ✅ Nginx 反向代理配置
- ✅ SSL 证书配置
- ✅ 对象存储配置
- ✅ 备份策略
- ✅ 监控与日志
- ✅ 安全加固
- ✅ CI/CD 自动化
- ✅ 性能优化
- ✅ 成本优化

**推荐架构**：
- ECS（4核8GB）+ RDS MySQL（2核4GB）+ OBS（100GB）
- 月成本约：¥500-800

**联系支持**：
- 华为云技术支持：400-xxx-xxxx
- 工单系统：https://console.huaweicloud.com/ticket

---

**文档版本**: v1.0  
**最后更新**: 2025-11-10  
**适用平台**: 华为云
