# é¸¿è’™è®°è´¦åº”ç”¨ - é¡¹ç›®æ¶æ„è¯´æ˜æ–‡æ¡£

##  é¡¹ç›®æ¦‚è§ˆ

**é¡¹ç›®åç§°**: HarmonyExpense (å¥åº·è®°è´¦)  
**åº”ç”¨åŒ…å**: com.example.healthydiet  
**æŠ€æœ¯æ ˆ**: HarmonyOS + ArkTS + RelationalStore  
**æ¶æ„æ¨¡å¼**: åˆ†å±‚æ¶æ„ (Layered Architecture)  
**æ•°æ®åº“**: SQLite (é€šè¿‡ RelationalStore API)  
**ç‰ˆæœ¬**: 1.2.0

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„è®¾è®¡

### æ¶æ„åˆ†å±‚

é¡¹ç›®é‡‡ç”¨ç»å…¸çš„**å››å±‚æ¶æ„**è®¾è®¡ï¼ŒèŒè´£æ¸…æ™°ï¼Œä¾èµ–å•å‘ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Presentation Layer (è¡¨ç¤ºå±‚)            â”‚
â”‚              pages/ (UIç»„ä»¶)                     â”‚
â”‚         - Index.ets (é¦–é¡µ)                       â”‚
â”‚         - AddBill.ets (æ·»åŠ è´¦å•)                 â”‚
â”‚         - CategoryManagement.ets (åˆ†ç±»ç®¡ç†)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“ ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Business Logic Layer (ä¸šåŠ¡å±‚)           â”‚
â”‚              service/ (ä¸šåŠ¡æœåŠ¡)                  â”‚
â”‚         - export/ (å¯¼å‡ºå¤‡ä»½æœåŠ¡)                  â”‚
â”‚           Â· ExportService                       â”‚
â”‚           Â· ImportService                       â”‚
â”‚           Â· EncryptionModule                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“ ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Data Access Layer (æ•°æ®è®¿é—®å±‚)             â”‚
â”‚              dao/ (æ•°æ®è®¿é—®å¯¹è±¡)                  â”‚
â”‚         - UserDAO, AccountDAO, BillDAO          â”‚
â”‚         - CategoryDAO, BudgetDAO, TagDAO        â”‚
â”‚         - StatisticsDAO                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“ ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Infrastructure Layer (åŸºç¡€è®¾æ–½å±‚)            â”‚
â”‚         database/ (æ•°æ®åº“åŸºç¡€è®¾æ–½)                 â”‚
â”‚         - DatabaseManager (æ•°æ®åº“ç®¡ç†)            â”‚
â”‚         - IndexManager (ç´¢å¼•ç®¡ç†)                 â”‚
â”‚         - BatchQueryHelper (æ‰¹é‡æŸ¥è¯¢)             â”‚
â”‚         - CacheManager (ç¼“å­˜ç®¡ç†)                 â”‚
â”‚         - PerformanceMonitor (æ€§èƒ½ç›‘æ§)           â”‚
â”‚         - DatabaseConfigOptimizer (é…ç½®ä¼˜åŒ–)      â”‚
â”‚                                                 â”‚
â”‚         model/ (æ•°æ®æ¨¡å‹)                        â”‚
â”‚         - User, Account, Bill, Category         â”‚
â”‚         - Budget, Tag, Statistics               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶æ„åŸåˆ™

#### 1. **å•ä¸€èŒè´£åŸåˆ™ (SRP)**
- **DAOå±‚**: ä»…è´Ÿè´£å•è¡¨çš„CRUDæ“ä½œï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
- **Serviceå±‚**: å¤„ç†è·¨è¡¨ä¸šåŠ¡é€»è¾‘å’Œå¤æ‚æ“ä½œ
- **Databaseå±‚**: ä¸“æ³¨äºæ•°æ®åº“è¿æ¥ã€äº‹åŠ¡ã€ç´¢å¼•ç­‰åŸºç¡€è®¾æ–½

#### 2. **ä¾èµ–å€’ç½®åŸåˆ™ (DIP)**
- ä¸Šå±‚ä¾èµ–ä¸‹å±‚çš„æŠ½è±¡æ¥å£ï¼Œè€Œéå…·ä½“å®ç°
- æ‰€æœ‰DAOé€šè¿‡ `DatabaseManager.getDatabase()` è·å–æ•°æ®åº“å®ä¾‹
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•æœºåˆ¶

#### 3. **å¼€é—­åŸåˆ™ (OCP)**
- é€šè¿‡ç»§æ‰¿å’Œç»„åˆæ‰©å±•åŠŸèƒ½ï¼Œè€Œéä¿®æ”¹ç°æœ‰ä»£ç 
- æ–°å¢DAOåªéœ€å®ç°æ ‡å‡†æ¥å£ï¼Œæ— éœ€ä¿®æ”¹DatabaseManager

---

##  æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. Modelå±‚ (æ•°æ®æ¨¡å‹)

**ä½ç½®**: `entry/src/main/ets/model/`

#### æ ¸å¿ƒæ¨¡å‹

| æ¨¡å‹ | æ–‡ä»¶ | èŒè´£ | å…³é”®å­—æ®µ |
|------|------|------|---------|
| User | User.ets | ç”¨æˆ·ä¿¡æ¯ | userId, username, email, passwordHash |
| Account | Account.ets | è´¦æˆ·ç®¡ç† | accountId, userId, name, type, balance |
| Category | Category.ets | åˆ†ç±»ç®¡ç† | categoryId, userId, name, type, parentCategoryId, sortOrder |
| Bill | Bill.ets | è´¦å•è®°å½• | billId, userId, accountId, categoryId, amount, type |
| Budget | Budget.ets | é¢„ç®—ç®¡ç† | budgetId, userId, categoryId, amount, period |
| Tag | Tag.ets | æ ‡ç­¾ç®¡ç† | tagId, userId, name, usageCount |
| BillTag | BillTag.ets | è´¦å•-æ ‡ç­¾å…³è” | billId, tagId |
| Statistics | Statistics.ets | ç»Ÿè®¡æ•°æ® | MonthlyStatistics, CategoryStatistics |

#### è®¾è®¡ç‰¹ç‚¹
- æ‰€æœ‰æ¨¡å‹éµå¾ªç»Ÿä¸€è§„èŒƒ
- æ„é€ å‡½æ•°æ”¯æŒå®Œæ•´åˆå§‹åŒ–
- æ•°æ®éªŒè¯æ–¹æ³•
- JSONåºåˆ—åŒ–æ”¯æŒ

**å…³é”®è®¾è®¡å†³ç­–**:
-  æ‰€æœ‰æ—¥æœŸä½¿ç”¨å­—ç¬¦ä¸²æ ¼å¼ (é¿å…Dateå¯¹è±¡å…¼å®¹æ€§é—®é¢˜)
-  å¸ƒå°”å€¼ä½¿ç”¨æ•°å­— (1/0ï¼Œç¬¦åˆSQLiteä¹ æƒ¯)
-  æšä¸¾å€¼ä½¿ç”¨å­—ç¬¦ä¸²å­—é¢é‡ç±»å‹ (ç±»å‹å®‰å…¨)
-  æ‰€æœ‰å­—æ®µéƒ½æœ‰é»˜è®¤å€¼ (é¿å…undefined)

---

### 2. DAOå±‚ (æ•°æ®è®¿é—®)

**ä½ç½®**: `entry/src/main/ets/dao/`

#### DAOèŒè´£çŸ©é˜µ

| DAO | ä¸»è¦åŠŸèƒ½ | ç‰¹æ®Šèƒ½åŠ› |
|-----|---------|---------|
| UserDAO | ç”¨æˆ·CRUDã€ç™»å½•éªŒè¯ | é‚®ç®±å”¯ä¸€æ€§æ£€æŸ¥ |
| AccountDAO | è´¦æˆ·CRUDã€ä½™é¢ç®¡ç† | æ‰¹é‡æ“ä½œã€ä½™é¢èŒƒå›´æŸ¥è¯¢ |
| CategoryDAO | åˆ†ç±»CRUDã€æ ‘å½¢ç»“æ„ | é€’å½’æŸ¥è¯¢ã€åˆ†ç±»æ ‘æ„å»ºã€èšåˆç»Ÿè®¡ |
| BillDAO | è´¦å•CRUDã€å¤–é”®éªŒè¯ | æ—¥æœŸèŒƒå›´æŸ¥è¯¢ã€åˆ†é¡µæŸ¥è¯¢ |
| BudgetDAO | é¢„ç®—CRUDã€æ´»è·ƒçŠ¶æ€ | å‘¨æœŸæŸ¥è¯¢ã€é¢„ç®—æ£€æŸ¥ |
| TagDAO | æ ‡ç­¾CRUDã€å…³è”ç®¡ç† | çƒ­é—¨æ ‡ç­¾ã€ä½¿ç”¨è®¡æ•°ã€è´¦å•-æ ‡ç­¾å…³è” |
| StatisticsDAO | ç»Ÿè®¡æ•°æ®CRUD | æœˆåº¦ç»Ÿè®¡ã€åˆ†ç±»ç»Ÿè®¡ |

#### DAOæ ‡å‡†æ¨¡å¼

```typescript
export class CategoryDAO {
  // 1. åŸºç¡€CRUD
  static async insert(category: Category): Promise<void>
  static async getById(userId: number, categoryId: number): Promise<Category | null>
  static async getAll(userId: number): Promise<Category[]>
  static async update(category: Category): Promise<void>
  static async softDelete(userId: number, categoryId: number): Promise<void>

  // 2. æ‰¹é‡æ“ä½œ
  static async bulkInsert(categories: Category[]): Promise<void>

  // 3. ä¸šåŠ¡æŸ¥è¯¢
  static async getByType(userId: number, type: 'expense' | 'income'): Promise<Category[]>
  static async getChildren(userId: number, parentId: number): Promise<Category[]>

  // 4. é«˜çº§åŠŸèƒ½
  static async getCategoryTree(userId: number, type: string): Promise<CategoryTreeNode[]>
  static async aggregateByCategory(userId: number, startDate: string, endDate: string): Promise<CategoryAggregation[]>

  // 5. è¾…åŠ©æ–¹æ³•
  static async exists(categoryId: number): Promise<boolean>
  private static mapRowToCategory(resultSet: relationalStore.ResultSet): Category
  private static toError(message: string, err: any): Error
}
```

**å…³é”®è®¾è®¡æ¨¡å¼**:
-  é™æ€æ–¹æ³• (æ— éœ€å®ä¾‹åŒ–)
-  ç»Ÿä¸€é”™è¯¯å¤„ç† (toErroræ–¹æ³•)
-  ResultSetèµ„æºç®¡ç† (finallyå—å…³é—­)
-  äº‹åŠ¡æ”¯æŒ (æ‰¹é‡æ“ä½œ)
-  å‚æ•°éªŒè¯ (validateè°ƒç”¨)

---

### 3. Databaseå±‚ (æ•°æ®åº“åŸºç¡€è®¾æ–½)

**ä½ç½®**: `entry/src/main/ets/database/`

#### æ ¸å¿ƒç»„ä»¶

##### 3.1 DatabaseManager (æ•°æ®åº“ç®¡ç†å™¨)

**èŒè´£**: ç»Ÿä¸€æ•°æ®åº“åˆå§‹åŒ–ã€è¿æ¥ç®¡ç†ã€è¡¨åˆ›å»º

```typescript
export class DatabaseManager {
  private static db: relationalStore.RdbStore | null = null
  private static isInitialized: boolean = false

  // å•ä¾‹æ¨¡å¼åˆå§‹åŒ–
  static async initDatabase(context: common.Context): Promise<void>

  // è·å–æ•°æ®åº“å®ä¾‹
  static getDatabase(): relationalStore.RdbStore

  // åˆ›å»ºæ‰€æœ‰è¡¨ï¼ˆæŒ‰ä¾èµ–é¡ºåºï¼‰
  private static async createAllTables(): Promise<void>

  // äº‹åŠ¡å°è£…
  static async transaction(fn: () => Promise<void>): Promise<void>
}
```

**è¡¨åˆ›å»ºé¡ºåº** (éµå¾ªå¤–é”®ä¾èµ–):
1. users (ç‹¬ç«‹è¡¨)
2. accounts, categories (ä¾èµ–users)
3. bills (ä¾èµ–accounts, categories)
4. budgets (ä¾èµ–users, categories)
5. tags (ä¾èµ–users)
6. bill_tags (ä¾èµ–bills, tags)
7. monthly_statistics, category_statistics (ç»Ÿè®¡è¡¨)

##### 3.2 IndexManager (ç´¢å¼•ç®¡ç†å™¨)

**èŒè´£**: åˆ›å»ºå’Œç®¡ç†æ•°æ®åº“ç´¢å¼•ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

```typescript
export class IndexManager {
  // åˆ›å»ºæ‰€æœ‰ä¼˜åŒ–ç´¢å¼•
  static async createAllIndexes(): Promise<void>

  // ç´¢å¼•ç±»å‹
  // - å¤åˆç´¢å¼•: (user_id, type)
  // - éƒ¨åˆ†ç´¢å¼•: WHERE is_deleted = 0
  // - æ’åºç´¢å¼•: (user_id, sort_order)
  // - è¦†ç›–ç´¢å¼•: (account_id, type, transaction_date, amount)
}
```

**ç´¢å¼•ç­–ç•¥**:
-  é«˜é¢‘æŸ¥è¯¢å­—æ®µå»ºç´¢å¼•
-  å¤–é”®å­—æ®µå»ºç´¢å¼•
-  æ’åºå­—æ®µå»ºç´¢å¼•
-  éƒ¨åˆ†ç´¢å¼•å‡å°‘ç´¢å¼•å¤§å°
-  å¤åˆç´¢å¼•éµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™

##### 3.3 BatchQueryHelper (æ‰¹é‡æŸ¥è¯¢åŠ©æ‰‹)

**èŒè´£**: ä¼˜åŒ–æ‰¹é‡æ“ä½œæ€§èƒ½

```typescript
export class BatchQueryHelper {
  // æ‰¹é‡æ’å…¥ (äº‹åŠ¡ + å¤šè¡ŒVALUES)
  static async bulkInsert<T>(items: T[], insertFn: (item: T) => Promise<void>): Promise<void>

  // æ‰¹é‡æ›´æ–°
  static async bulkUpdate<T>(items: T[], updateFn: (item: T) => Promise<void>): Promise<void>

  // INæŸ¥è¯¢ä¼˜åŒ–
  static async queryByIds<T>(ids: number[], queryFn: (id: number) => Promise<T>): Promise<T[]>
}
```

##### 3.4 CacheManager (ç¼“å­˜ç®¡ç†å™¨)

**èŒè´£**: å†…å­˜ç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“è®¿é—®

```typescript
export class CacheManager {
  private static cache: Map<string, CacheEntry> = new Map()
  private static readonly DEFAULT_TTL = 5 * 60 * 1000 // 5åˆ†é’Ÿ

  static get<T>(key: string): T | null
  static set<T>(key: string, value: T, ttl?: number): void
  static clear(pattern?: string): void
}
```

**ç¼“å­˜ç­–ç•¥**:
-  åˆ†ç±»åˆ—è¡¨ç¼“å­˜ (é«˜é¢‘è¯»å–)
-  ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
-  TTLè¿‡æœŸæœºåˆ¶
-  æ¨¡å¼åŒ¹é…æ¸…é™¤

##### 3.5 PerformanceMonitor (æ€§èƒ½ç›‘æ§)

**èŒè´£**: ç›‘æ§æŸ¥è¯¢æ€§èƒ½ï¼Œè¯†åˆ«æ…¢æŸ¥è¯¢

```typescript
export class PerformanceMonitor {
  // è®°å½•æŸ¥è¯¢æ—¶é—´
  static async measureQuery<T>(name: string, fn: () => Promise<T>): Promise<T>

  // è·å–æ€§èƒ½æŠ¥å‘Š
  static getReport(): PerformanceReport

  // æ…¢æŸ¥è¯¢é˜ˆå€¼: 100ms
}
```

##### 3.6 DatabaseConfigOptimizer (é…ç½®ä¼˜åŒ–å™¨)

**èŒè´£**: ä¼˜åŒ–æ•°æ®åº“é…ç½®å‚æ•°

```typescript
export class DatabaseConfigOptimizer {
  static async applyOptimizations(): Promise<void> {
    // WALæ¨¡å¼ (Write-Ahead Logging)
    await store.executeSql('PRAGMA journal_mode=WAL')

    // åŒæ­¥æ¨¡å¼
    await store.executeSql('PRAGMA synchronous=NORMAL')

    // ç¼“å­˜å¤§å° (40MB)
    await store.executeSql('PRAGMA cache_size=10000')

    // ä¸´æ—¶å­˜å‚¨åœ¨å†…å­˜
    await store.executeSql('PRAGMA temp_store=MEMORY')

    // å¯ç”¨å¤–é”®çº¦æŸ
    await store.executeSql('PRAGMA foreign_keys=ON')
  }
}
```

---

### 4. Serviceå±‚ (ä¸šåŠ¡æœåŠ¡)

**ä½ç½®**: `entry/src/main/ets/service/`

#### å¯¼å‡ºå¤‡ä»½æœåŠ¡

##### 4.1 ExportService (å¯¼å‡ºæœåŠ¡)

**èŒè´£**: å¯¼å‡ºç”¨æˆ·æ•°æ®ä¸ºJSONæ–‡ä»¶

```typescript
export class ExportService {
  static async exportUserData(
    userId: number,
    options: ExportOptions
  ): Promise<string> {
    // 1. æ”¶é›†æ‰€æœ‰æ•°æ®
    const data = await this.collectUserData(userId)

    // 2. åºåˆ—åŒ–ä¸ºJSON
    const jsonData = JSON.stringify(data, null, 2)

    // 3. è®¡ç®—æ ¡éªŒå’Œ
    const checksum = await ChecksumHelper.generateChecksum(jsonData)

    // 4. å¯é€‰åŠ å¯†
    let finalData = jsonData
    if (options.encrypt && options.password) {
      finalData = await EncryptionModule.encryptData(jsonData, options.password)
    }

    // 5. ä¿å­˜æ–‡ä»¶
    const filePath = await FileHelper.saveFile(finalData, options)

    return filePath
  }
}
```

##### 4.2 ImportService (å¯¼å…¥æœåŠ¡)

**èŒè´£**: å¯¼å…¥å¤‡ä»½æ•°æ®ï¼Œæ¢å¤ç”¨æˆ·æ•°æ®

```typescript
export class ImportService {
  static async importUserData(
    filePath: string,
    password?: string
  ): Promise<ImportResult> {
    // 1. è¯»å–æ–‡ä»¶
    let fileContent = await FileHelper.readFile(filePath)

    // 2. è§£å¯† (å¦‚æœéœ€è¦)
    if (password) {
      fileContent = await EncryptionModule.decryptData(fileContent, password)
    }

    // 3. æ ¡éªŒå’ŒéªŒè¯
    const isValid = await ChecksumHelper.verifyChecksum(fileContent)

    // 4. è§£æJSON
    const data = JSON.parse(fileContent)

    // 5. äº‹åŠ¡åŒ–å¯¼å…¥
    await DatabaseManager.transaction(async () => {
      await this.importAccounts(data.accounts)
      await this.importCategories(data.categories)
      await this.importBills(data.bills)
      // ...
    })

    return { success: true, imported: stats }
  }
}
```

##### 4.3 EncryptionModule (åŠ å¯†æ¨¡å—)

**èŒè´£**: AES-256-GCMåŠ å¯†/è§£å¯†

```typescript
export class EncryptionModule {
  // AES-256-GCMåŠ å¯†
  static async encryptData(plaintext: string, password: string): Promise<string>

  // AES-256-GCMè§£å¯†
  static async decryptData(ciphertext: string, password: string): Promise<string>

  // PBKDF2å¯†é’¥æ´¾ç”Ÿ (100,000æ¬¡è¿­ä»£)
  private static async deriveKey(password: string, salt: Uint8Array): Promise<CryptoKey>
}
```

**å®‰å…¨ç‰¹æ€§**:
-  AES-256-GCMè®¤è¯åŠ å¯†
-  PBKDF2å¯†é’¥æ´¾ç”Ÿ
-  éšæœºç›å€¼å’ŒIV
-  é˜²ç¯¡æ”¹æ£€æµ‹

---

### 5. Pageså±‚ (UIç•Œé¢)

**ä½ç½®**: `entry/src/main/ets/pages/`

#### é¡µé¢ç»„ä»¶

| é¡µé¢ | æ–‡ä»¶ | åŠŸèƒ½ | çŠ¶æ€ç®¡ç† |
|------|------|------|---------|
| é¦–é¡µ | Index.ets | è´¦å•åˆ—è¡¨ã€ç»Ÿè®¡å±•ç¤º | @State transactions, totalIncome, totalExpense |
| æ·»åŠ è´¦å• | AddBill.ets | è´¦å•å½•å…¥è¡¨å• | @State amount, category, account |
| åˆ†ç±»ç®¡ç† | CategoryManagement.ets | åˆ†ç±»CRUDã€æ ‘å½¢å±•ç¤º | @State categories, selectedCategory |

#### UIæ¶æ„æ¨¡å¼

```typescript
@Entry
@Component
struct Index {
  // çŠ¶æ€ç®¡ç†
  @State transactions: Array<Bill> = []
  @State allCategories: Array<Category> = []
  @State allAccounts: Array<Account> = []

  // ç”Ÿå‘½å‘¨æœŸ
  async aboutToAppear() {
    await this.loadData()
  }

  // æ•°æ®åŠ è½½
  private async loadData() {
    this.transactions = await BillDAO.getAll(userId)
    this.allCategories = await CategoryDAO.getAll(userId)
    this.allAccounts = await AccountDAO.getAll(userId)
  }

  // æ¸²æŸ“
  build() {
    Column() {
      // UIç»„ä»¶
    }
  }
}
```

---

##  å…³é”®æŠ€æœ¯ç‰¹æ€§

### 1. åˆ†ç±»æ ‘å½¢ç»“æ„

**æ•°æ®ç»“æ„**: å¤šå‰æ ‘ (N-ary Tree)

```typescript
interface CategoryTreeNode {
  category: Category
  children: CategoryTreeNode[]
}

// æ ‘æ„å»ºç®—æ³• (O(n)å¤æ‚åº¦)
private static buildCategoryTree(categories: Category[]): CategoryTreeNode[] {
  const map = new Map<number, CategoryTreeNode>()  // å“ˆå¸Œè¡¨ä¼˜åŒ–
  const roots: CategoryTreeNode[] = []

  // åˆå§‹åŒ–èŠ‚ç‚¹
  categories.forEach(cat => {
    map.set(cat.categoryId, { category: cat, children: [] })
  })

  // å»ºç«‹çˆ¶å­å…³ç³»
  categories.forEach(cat => {
    const node = map.get(cat.categoryId)
    if (cat.parentCategoryId === 0) {
      roots.push(node)
    } else {
      const parent = map.get(cat.parentCategoryId)
      parent?.children.push(node)
    }
  })

  return roots
}
```

**åº”ç”¨åœºæ™¯**:
- åˆ†ç±»å±‚çº§å±•ç¤º
- é€’å½’æŸ¥è¯¢å­åˆ†ç±»
- åˆ†ç±»èšåˆç»Ÿè®¡

### 2. æ ‡ç­¾ç³»ç»Ÿ

**å¤šå¯¹å¤šå…³ç³»**: Bill â†” Tag (é€šè¿‡bill_tagså…³è”è¡¨)

```typescript
// ä¸ºè´¦å•æ·»åŠ æ ‡ç­¾
await TagDAO.addTagToBill(billId, tagId)

// æ‰¹é‡è®¾ç½®æ ‡ç­¾
await TagDAO.setTagsForBill(billId, [1, 2, 3])

// æŸ¥è¯¢è´¦å•çš„æ‰€æœ‰æ ‡ç­¾
const tags = await TagDAO.getTagsByBillId(billId)

// æ ‡ç­¾èšåˆç»Ÿè®¡
const stats = await TagDAO.aggregateByTag(userId, startDate, endDate)
```

### 3. ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

#### å¤åˆç´¢å¼•
```sql
-- è´¦å•æ—¥æœŸèŒƒå›´æŸ¥è¯¢ (æœ€é«˜é¢‘)
CREATE INDEX idx_bills_date 
ON bills (transaction_date DESC, bill_id DESC) 
WHERE is_deleted = 0;

-- è´¦æˆ·+æ—¥æœŸå¤åˆç´¢å¼•
CREATE INDEX idx_bills_account_date 
ON bills (account_id, transaction_date DESC, type) 
WHERE is_deleted = 0;
```

#### è¦†ç›–ç´¢å¼•
```sql
-- é‡‘é¢ç»Ÿè®¡æŸ¥è¯¢ (é¿å…å›è¡¨)
CREATE INDEX idx_bills_stat 
ON bills (account_id, type, transaction_date, amount) 
WHERE is_deleted = 0;
```

#### éƒ¨åˆ†ç´¢å¼•
```sql
-- åªç´¢å¼•æœªåˆ é™¤æ•°æ®
CREATE INDEX idx_categories_user_type 
ON categories (user_id, type) 
WHERE is_deleted = 0;
```

### 4. æ‰¹é‡æ“ä½œä¼˜åŒ–

```typescript
// æ‰¹é‡æ’å…¥ (äº‹åŠ¡ + å¤šè¡ŒVALUES)
static async bulkInsert(bills: Bill[]): Promise<void> {
  const BATCH_SIZE = 100
  await store.beginTransaction()

  try {
    for (let i = 0; i < bills.length; i += BATCH_SIZE) {
      const batch = bills.slice(i, i + BATCH_SIZE)
      const placeholders = batch.map(() => '(?, ?, ?, ...)').join(', ')
      const sql = `INSERT INTO bills (...) VALUES ${placeholders}`
      await store.executeSql(sql, params)
    }
    await store.commit()
  } catch (error) {
    await store.rollBack()
    throw error
  }
}
```

### 5. ç¼“å­˜æœºåˆ¶

```typescript
// åˆ†ç±»åˆ—è¡¨ç¼“å­˜
static async getAll(userId: number): Promise<Category[]> {
  const cacheKey = `categories:${userId}`

  // å°è¯•ä»ç¼“å­˜è·å–
  let categories = CacheManager.get<Category[]>(cacheKey)
  if (categories) return categories

  // ä»æ•°æ®åº“æŸ¥è¯¢
  categories = await this.queryFromDatabase(userId)

  // å†™å…¥ç¼“å­˜
  CacheManager.set(cacheKey, categories, 5 * 60 * 1000)  // 5åˆ†é’Ÿ

  return categories
}
```

---

##  æ•°æ®æµå‘

### æŸ¥è¯¢æµç¨‹

```
User Action (UI)
    â†“
Page Component (@State)
    â†“
DAO Layer (static methods)
    â†“
CacheManager (check cache)
    â†“ (cache miss)
DatabaseManager (getDatabase)
    â†“
RelationalStore API
    â†“
SQLite Database
    â†“
ResultSet â†’ Model Object
    â†“
Cache Update
    â†“
Return to Page
    â†“
UI Update (@State change)
```

### æ’å…¥æµç¨‹

```
User Input (UI)
    â†“
Page Component (form data)
    â†“
Model Validation (validate())
    â†“
DAO Layer (insert method)
    â†“
Foreign Key Validation
    â†“
DatabaseManager (transaction)
    â†“
RelationalStore.executeSql()
    â†“
SQLite Database
    â†“
Cache Invalidation
    â†“
Success/Error Response
    â†“
UI Feedback
```

---

##  å®‰å…¨è®¾è®¡

### 1. æ•°æ®åŠ å¯†
- AES-256-GCMè®¤è¯åŠ å¯†
- PBKDF2å¯†é’¥æ´¾ç”Ÿ (100,000æ¬¡è¿­ä»£)
- éšæœºç›å€¼å’ŒIV
- é˜²ç¯¡æ”¹æ£€æµ‹ (GCMè®¤è¯æ ‡ç­¾)

### 2. SQLæ³¨å…¥é˜²æŠ¤
- å‚æ•°åŒ–æŸ¥è¯¢ (PreparedStatement)
- ä¸¥æ ¼ç±»å‹æ£€æŸ¥
- è¾“å…¥éªŒè¯

### 3. æ•°æ®å®Œæ•´æ€§
- å¤–é”®çº¦æŸ
- CHECKçº¦æŸ
- UNIQUEçº¦æŸ
- äº‹åŠ¡ä¿è¯åŸå­æ€§

---

##  æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“å±‚é¢
- WALæ¨¡å¼ (Write-Ahead Logging)
- ç´¢å¼•ä¼˜åŒ– (å¤åˆç´¢å¼•ã€éƒ¨åˆ†ç´¢å¼•ã€è¦†ç›–ç´¢å¼•)
- æ‰¹é‡æ“ä½œ (äº‹åŠ¡ + å¤šè¡Œæ’å…¥)
- ç¼“å­˜å¤§å°ä¼˜åŒ– (40MB)

### 2. åº”ç”¨å±‚é¢
- å†…å­˜ç¼“å­˜ (CacheManager)
- æ‡’åŠ è½½ (åˆ†é¡µæŸ¥è¯¢)
- æ¸¸æ ‡åˆ†é¡µ (Cursor-based Pagination)
- æŸ¥è¯¢ç»“æœå¤ç”¨

### 3. ç®—æ³•ä¼˜åŒ–
- æ ‘æ„å»ºä½¿ç”¨Map (O(nÂ²) â†’ O(n))
- æ‰¹é‡æ“ä½œé¿å…å¾ªç¯æŸ¥è¯¢
- é€’å½’æ·±åº¦é™åˆ¶

---

##  æµ‹è¯•æ¶æ„

### æµ‹è¯•åˆ†å±‚

```
entry/ohosTest/ets/test/
â”œâ”€â”€ model/          # æ¨¡å‹å±‚æµ‹è¯• (6ä¸ª)
â”‚   â”œâ”€â”€ User.test.ets
â”‚   â”œâ”€â”€ Account.test.ets
â”‚   â”œâ”€â”€ Category.test.ets
â”‚   â”œâ”€â”€ Bill.test.ets
â”‚   â”œâ”€â”€ Budget.test.ets
â”‚   â””â”€â”€ Statistics.test.ets
â”‚
â”œâ”€â”€ dao/            # DAOå±‚æµ‹è¯• (6ä¸ª)
â”‚   â”œâ”€â”€ UserDAO.test.ets
â”‚   â”œâ”€â”€ AccountDAO.test.ets
â”‚   â”œâ”€â”€ CategoryDAO.test.ets
â”‚   â”œâ”€â”€ BillDAO.test.ets
â”‚   â”œâ”€â”€ BudgetDAO.test.ets
â”‚   â””â”€â”€ StatisticsDAO.test.ets
â”‚
â”œâ”€â”€ pages/          # UIå±‚æµ‹è¯• (3ä¸ª)
â”‚   â”œâ”€â”€ IndexPage.test.ets
â”‚   â”œâ”€â”€ AddBillPage.test.ets
â”‚   â””â”€â”€ CategoryManagementPage.test.ets
â”‚
â””â”€â”€ services/       # æœåŠ¡å±‚æµ‹è¯• (1ä¸ª)
    â””â”€â”€ Transaction.test.ets
```

**æµ‹è¯•è¦†ç›–**: 16ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œè¦†ç›–æ ¸å¿ƒåŠŸèƒ½

---

##  æ¶æ„ä¼˜åŠ¿

###  ä¼˜ç‚¹

1. **æ¸…æ™°çš„åˆ†å±‚**: èŒè´£æ˜ç¡®ï¼Œæ˜“äºç»´æŠ¤
2. **ç»Ÿä¸€ç®¡ç†**: DatabaseManagerç»Ÿä¸€æ•°æ®åº“åˆå§‹åŒ–
3. **æ€§èƒ½ä¼˜åŒ–**: ç´¢å¼•ã€ç¼“å­˜ã€æ‰¹é‡æ“ä½œ
4. **å®‰å…¨å¯é **: åŠ å¯†ã€äº‹åŠ¡ã€å¤–é”®çº¦æŸ
5. **å¯æ‰©å±•æ€§**: æ–°å¢åŠŸèƒ½åªéœ€æ·»åŠ DAOå’ŒService
6. **æµ‹è¯•å‹å¥½**: åˆ†å±‚æµ‹è¯•ï¼Œè¦†ç›–å…¨é¢

###  æ”¹è¿›ç©ºé—´

1. **DAOåˆå§‹åŒ–å†—ä½™**: EntryAbilityä¸­ä»ä¿ç•™æ—§çš„DAOåˆå§‹åŒ–ä»£ç 
2. **ç¼“å­˜ç­–ç•¥**: ç¼“å­˜å¤±æ•ˆç­–ç•¥å¯ä»¥æ›´ç²¾ç»†
3. **é”™è¯¯å¤„ç†**: å¯ä»¥ç»Ÿä¸€é”™è¯¯ç å’Œé”™è¯¯ç±»å‹
4. **æ—¥å¿—ç³»ç»Ÿ**: å¯ä»¥å¼•å…¥ç»“æ„åŒ–æ—¥å¿—
5. **é…ç½®ç®¡ç†**: å¯ä»¥å¤–éƒ¨åŒ–é…ç½®å‚æ•°

---

## æŠ€æœ¯æ ˆæ€»ç»“

| å±‚æ¬¡ | æŠ€æœ¯ | ç”¨é€” |
|------|------|------|
| UIå±‚ | ArkTS + ArkUI | å£°æ˜å¼UIæ¡†æ¶ |
| ä¸šåŠ¡å±‚ | TypeScript | ä¸šåŠ¡é€»è¾‘ |
| æ•°æ®å±‚ | RelationalStore API | å…³ç³»å‹æ•°æ®åº“ |
| å­˜å‚¨å±‚ | SQLite | æœ¬åœ°æ•°æ®åº“ |
| åŠ å¯† | AES-256-GCM | æ•°æ®åŠ å¯† |
| æµ‹è¯• | Hypium | å•å…ƒæµ‹è¯•æ¡†æ¶ |

---
