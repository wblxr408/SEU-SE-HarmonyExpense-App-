## 数据流向总览

```
┌─────────────────────────────────────────────────────────────┐
│                    Page 层 (UI界面)                          │
│  Index, AddBill, StatisticsPage, BudgetManagement...       │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│                  Service 层 (业务逻辑)                       │
│  SmartCategoryService, AnomalyDetectionService...          │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│                   DAO 层 (数据访问)                          │
│  BillDAO, CategoryDAO, AccountDAO, BudgetDAO...            │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│              DatabaseManager (数据库管理器)                  │
│              relationalStore (关系型数据库)                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 核心数据流程示例

### **添加账单的完整流程**

```
用户操作 (AddBill Page)
  ↓
① 输入金额、分类、备注等信息
  ↓
② SmartCategoryService.suggestCategory(备注)
   → 分析关键词 → 推荐最佳分类
  ↓
③ AnomalyDetectionService.detectAnomaly(金额)
   → 检测异常消费 → 返回警告（如果有）
  ↓
④ BillDAO.insert(bill)
   → DatabaseManager 验证外键
   → 写入 bills 表
   → 返回新的 bill_id
  ↓
⑤ 连锁更新：
   - AccountDAO.updateBalance() - 更新账户余额
   - StatisticsDAO.updateStats() - 更新统计数据
   - SmartCategoryTrainingDAO.record() - 记录训练数据
  ↓
⑥ EventSourcingDAO.recordEvent() - 记录事件（可追溯）
  ↓
⑦ NotificationService.notify() - 发送通知
```

### **首页数据加载流程**

```
Index Page 加载
  ↓
并行查询：
├─ BillDAO.getByPage(userId, page=1, size=20)
│   → 获取当月账单列表（分页）
│
├─ CategoryDAO.getAll(userId)
│   → 优先从缓存获取（5分钟TTL）
│   → 缓存未命中才查数据库
│
├─ AccountDAO.getByUserId(userId)
│   → 获取所有账户及余额
│
└─ BillDAO.getTotalStats(userId)
    → 计算本月总收入/总支出
  ↓
渲染界面显示
```

---

## 核心数据实体 (Model)

| 实体               | 核心字段                                                  | 关系                            |
| ------------------ | --------------------------------------------------------- | ------------------------------- |
| **User**     | userId, username, email, avatarPath                       | 一对多：Account, Category, Bill |
| **Account**  | accountId, userId, name, type, balance                    | 一对多：Bill                    |
| **Category** | categoryId, userId, name, type(收入/支出), parentId       | 一对多：Bill, Budget            |
| **Bill**     | billId, userId, accountId, categoryId, amount, type, date | 多对多：Tag                     |
| **Budget**   | budgetId, userId, categoryId, amount, period              | 一对一：SmartBudgetPlan         |
| **Tag**      | tagId, userId, name, color, usageCount                    | 多对多：Bill                    |

---

## 主要 DAO 接口

### **BillDAO** (账单数据访问)

```typescript
// 基础 CRUD
insert(bill: Bill): Promise<number>
getById(billId: number, userId: number): Promise<Bill | null>
update(bill: Bill): Promise<boolean>
softDelete(billId: number, userId: number): Promise<boolean>

// 查询接口
getByUserId(userId: number): Promise<Bill[]>
getByFilters(userId, dateRange, categoryId?, accountId?): Promise<Bill[]>
getByPage(userId, page, pageSize): Promise<Bill[]>

// 统计接口
getTotalStats(userId, dateRange): Promise<{income, expense}>
getMonthlyStats(userId, startMonth, endMonth): Promise<MonthlyStats[]>
getCategoryStats(userId, dateRange): Promise<CategoryStats[]>

// 批量操作
bulkInsert(bills: Bill[]): Promise<number[]>
bulkSoftDelete(billIds: number[]): Promise<boolean>
```

### **CategoryDAO** (分类数据访问，带缓存)

```typescript
insert(category: Category): Promise<number>
getAll(userId: number): Promise<Category[]>  // 5分钟缓存
update(category: Category): Promise<boolean>  // 自动清缓存

// 树形结构
buildCategoryTree(userId: number): Promise<CategoryNode[]>
getCategoryPath(categoryId: number): Promise<Category[]>

// 统计聚合
aggregateByCategory(userId, dateRange): Promise<CategoryAggregation[]>
```

### **AccountDAO** (账户数据访问)

```typescript
insert(account: Account): Promise<number>
getByUserId(userId: number): Promise<Account[]>
updateBalance(accountId, amount, type): Promise<boolean>

// 转账操作
transfer(fromAccountId, toAccountId, amount): Promise<boolean>
```

---

## 主要 Service 业务逻辑

### **SmartCategoryService** (智能分类)

```typescript
// 分类推荐
suggestCategory(description: string, amount: number): Promise<Category>

// 规则管理
addCategoryRule(rule: SmartCategoryRule): Promise<void>
matchRules(bill: Bill): Promise<Category | null>

// 学习训练
learnFromUserBehavior(bill: Bill, selectedCategory: Category): Promise<void>
```

### **AnomalyDetectionService** (异常检测)

```typescript
// 异常检测（6种类型）
detectAnomaly(bill: Bill): Promise<AnomalyRecord | null>

// 异常类型：
// - UNUSUAL_AMOUNT: 异常金额
// - DUPLICATE_TRANSACTION: 重复交易
// - UNUSUAL_TIME: 异常时间
// - UNUSUAL_MERCHANT: 异常商户
// - CATEGORY_MISMATCH: 分类不匹配
// - BUDGET_EXCEEDED: 预算超支

// 基线管理
updateSpendingBaseline(userId: number): Promise<void>
```

### **SmartBudgetService** (智能预算)

```typescript
// 预算预测（5种算法）
generateSmartBudget(userId, categoryId, months): Promise<SmartBudgetPlan>

// 预测算法：
// - SIMPLE_MOVING_AVERAGE: 简单移动平均
// - WEIGHTED_MOVING_AVERAGE: 加权移动平均
// - EXPONENTIAL_SMOOTHING: 指数平滑
// - HOLT_WINTERS: Holt-Winters 季节性
// - LINEAR_REGRESSION: 线性回归

// 健康评分
calculateBudgetHealthScore(userId): Promise<number>
```

### **SharedLedgerService** (共享账本)

```typescript
// 账本管理
createSharedLedger(ledger: SharedLedger): Promise<number>
inviteMember(ledgerId, userId, permissions): Promise<void>
approveBill(billId, memberId): Promise<boolean>

// 账单分割
splitBill(billId, splitMethod, members): Promise<SharedBill[]>
```

---

## 数据库表结构 (26张表)

### 核心表

* `users` - 用户表
* `accounts` - 账户表
* `categories` - 分类表
* `bills` - 账单表
* `budgets` - 预算表
* `tags` / `bill_tags` - 标签及关联表

### 统计表

* `monthly_statistics` - 月度统计
* `category_statistics` - 分类统计

### 智能功能表

* `smart_category_training` - 智能分类训练数据
* `smart_category_rules` - 智能分类规则
* `anomaly_records` - 异常检测记录
* `user_spending_baselines` - 用户消费基线
* `ocr_recognition_records` - OCR识别记录

### 共享账本表

* `shared_ledgers` - 共享账本
* `ledger_members` - 成员表
* `ledger_invitations` - 邀请表
* `shared_bills` - 共享账单
* `approval_records` - 审批记录
* `member_activities` - 成员活动日志

### 高级功能表

* `domain_events` - 领域事件（事件溯源）
* `commands` - 命令表（CQRS）
* `aggregate_snapshots` - 聚合快照
* `read_models` - 读模型
* `notifications` - 通知表
* `reminders` - 提醒表
* `cloud_sync_records` - 云同步记录

---

## 总结

**数据流向核心规则：**

1. **UI 层不直接操作数据库** - 必须通过 Service 或 DAO
2. **Service 负责业务逻辑** - 可能调用多个 DAO，协调复杂操作
3. **DAO 负责数据访问** - 只做 CRUD，不包含业务逻辑
4. **DatabaseManager 统一管理** - 所有数据库操作都通过它
5. **缓存在 DAO 层** - CategoryDAO 使用 5 分钟 TTL 缓存
6. **事件溯源记录所有变更** - 支持完整的操作历史追溯

这份文档涵盖了应用的核心数据流向和接口设计，足以理解整个应用的数据架构
