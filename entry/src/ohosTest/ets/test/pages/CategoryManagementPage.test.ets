import { describe, beforeAll, it, expect } from '@ohos/hypium';
import { CategoryDAO } from '../../../../src/main/ets/dao/CategoryDAO';
import { Category } from '../../../../src/main/ets/model/Category';
import { DatabaseManager } from '../../../../src/main/ets/dao/DatabaseManager';
import common from '@ohos.app.ability.common';

// åœ¨æµ‹è¯•ç¯å¢ƒä¸­è·å– Context çš„è¾…åŠ©å‡½æ•°
function getTestContext(): common.Context {
  // åœ¨ stageMode ä¸­ï¼ŒgetContext æ˜¯å…¨å±€å‡½æ•°
  return getContext() as common.Context;
}

export default function CategoryManagementPageTest(): void {
  describe('CategoryManagement Page', () => {
    const testUserId: number = 1;

    beforeAll(async () => {
      const ctx: common.Context = getTestContext();
      await DatabaseManager.initDatabase(ctx);
    });

    it('should load categories successfully', 0, async () => {
      // æµ‹è¯•åŠ è½½åˆ†ç±»åˆ—è¡¨
      const categories = await CategoryDAO.getAll(testUserId);
      expect(Array.isArray(categories)).assertTrue();
    });

    it('should create new category', 0, async () => {
      // æµ‹è¯•åˆ›å»ºæ–°åˆ†ç±»
      const now = new Date().toISOString();
      const newCategory = new Category(
        0,
        testUserId,
        'æµ‹è¯•åˆ†ç±»',
        'expense',
        'ğŸ§ª',
        '#FF6B6B',
        0,
        0,
        now,
        now,
        0
      );

      await CategoryDAO.insert(newCategory);
      const categories = await CategoryDAO.getAll(testUserId);
      const found = categories.find(c => c.name === 'æµ‹è¯•åˆ†ç±»');
      expect(found !== undefined).assertTrue();
    });

    it('should update category', 0, async () => {
      // æµ‹è¯•æ›´æ–°åˆ†ç±»
      const categories = await CategoryDAO.getAll(testUserId);
      if (categories.length > 0) {
        const category = categories[0];
        const originalName = category.name;
        category.name = 'æ›´æ–°åçš„åˆ†ç±»';
        await CategoryDAO.update(category);

        const updated = await CategoryDAO.getById(testUserId, category.categoryId);
        expect(updated !== null).assertTrue();
        if (updated) {
          expect(updated.name).assertEqual('æ›´æ–°åçš„åˆ†ç±»');
        }

        // æ¢å¤åŸåç§°
        category.name = originalName;
        await CategoryDAO.update(category);
      }
    });

    it('should delete category (soft delete)', 0, async () => {
      // æµ‹è¯•è½¯åˆ é™¤åˆ†ç±»
      const now = new Date().toISOString();
      const tempCategory = new Category(
        0,
        testUserId,
        'ä¸´æ—¶åˆ†ç±»',
        'expense',
        'ğŸ—‘ï¸',
        '#999999',
        0,
        0,
        now,
        now,
        0
      );

      await CategoryDAO.insert(tempCategory);
      const categories = await CategoryDAO.getAll(testUserId);
      const found = categories.find(c => c.name === 'ä¸´æ—¶åˆ†ç±»');

      if (found) {
        await CategoryDAO.softDelete(testUserId, found.categoryId);
        const afterDelete = await CategoryDAO.getById(testUserId, found.categoryId);
        expect(afterDelete === null).assertTrue();
      }
    });

    it('should filter categories by type', 0, async () => {
      // æµ‹è¯•æŒ‰ç±»å‹ç­›é€‰åˆ†ç±»
      const expenseCategories = await CategoryDAO.getByType(testUserId, 'expense');
      const incomeCategories = await CategoryDAO.getByType(testUserId, 'income');

      expect(Array.isArray(expenseCategories)).assertTrue();
      expect(Array.isArray(incomeCategories)).assertTrue();

      // éªŒè¯ç±»å‹æ­£ç¡®
      for (const cat of expenseCategories) {
        expect(cat.type).assertEqual('expense');
      }
      for (const cat of incomeCategories) {
        expect(cat.type).assertEqual('income');
      }
    });

    it('should validate category name is required', 0, () => {
      // æµ‹è¯•åˆ†ç±»åç§°éªŒè¯
      const invalidCategory = new Category(
        0,
        testUserId,
        '', // ç©ºåç§°
        'expense',
        'ğŸ§ª',
        '#FF6B6B',
        0,
        0,
        '',
        '',
        0
      );

      expect(invalidCategory.validate()).assertFalse();
    });

    it('should clone category correctly', 0, () => {
      // æµ‹è¯•åˆ†ç±»å…‹éš†åŠŸèƒ½
      const original = new Category(
        1,
        testUserId,
        'åŸå§‹åˆ†ç±»',
        'expense',
        'ğŸ§ª',
        '#FF6B6B',
        0,
        0,
        '2025-11-08',
        '2025-11-08',
        0
      );

      const cloned = original.clone();
      expect(cloned.categoryId).assertEqual(original.categoryId);
      expect(cloned.name).assertEqual(original.name);
      expect(cloned.type).assertEqual(original.type);

      // ä¿®æ”¹å…‹éš†å¯¹è±¡ä¸åº”å½±å“åŸå¯¹è±¡
      cloned.name = 'ä¿®æ”¹åçš„åˆ†ç±»';
      expect(original.name).assertEqual('åŸå§‹åˆ†ç±»');
    });
  });
}
