/**
 * æ•°æ®åº“ç®¡ç†å™¨ - ç»Ÿä¸€ç®¡ç†æ•°æ®åº“åˆå§‹åŒ–å’Œè¿æ¥
 * è§£å†³å¤šä¸ª DAO é‡å¤åˆå§‹åŒ–æ•°æ®åº“çš„é—®é¢˜
 */
import relationalStore from '@ohos.data.relationalStore';
import common from '@ohos.app.ability.common';
import { IndexManager } from './IndexManager';
import { DatabaseConfigOptimizer } from './DatabaseConfigOptimizer';

export class DatabaseManager {
  private static db: relationalStore.RdbStore | null = null;
  private static isInitialized: boolean = false;
  
  // æ•°æ®åº“é…ç½®å¸¸é‡
  static readonly DB_NAME: string = 'harmony_expense.db';
  static readonly DB_VERSION: number = 1;
  static readonly SECURITY_LEVEL = relationalStore.SecurityLevel.S1;

  /**
   * åˆå§‹åŒ–æ•°æ®åº“ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
   * @param context åº”ç”¨ä¸Šä¸‹æ–‡
   */
  static async initDatabase(context: common.Context): Promise<void> {
    if (DatabaseManager.isInitialized && DatabaseManager.db) {
      console.log('[DatabaseManager] æ•°æ®åº“å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
      return;
    }

    try {
      const storeConfig: relationalStore.StoreConfig = {
        name: DatabaseManager.DB_NAME,
        securityLevel: DatabaseManager.SECURITY_LEVEL
      };
      
      DatabaseManager.db = await relationalStore.getRdbStore(context, storeConfig);
      console.log('[DatabaseManager] æ•°æ®åº“è¿æ¥æˆåŠŸ');
      
      // åº”ç”¨æ•°æ®åº“é…ç½®ä¼˜åŒ–
      await DatabaseConfigOptimizer.applyOptimizations();
      
      // æŒ‰é¡ºåºåˆ›å»ºæ‰€æœ‰è¡¨
      await DatabaseManager.createAllTables();
      
      // åˆ›å»ºä¼˜åŒ–ç´¢å¼•
      await IndexManager.createAllIndexes();
      
      DatabaseManager.isInitialized = true;
      console.log('[DatabaseManager] æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ');
      
      // æ‰“å°æ•°æ®åº“é…ç½®ä¿¡æ¯
      await DatabaseConfigOptimizer.printConfig();
    } catch (error) {
      DatabaseManager.isInitialized = false;
      throw DatabaseManager.toError('[DatabaseManager] æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥', error);
    }
  }

  /**
   * è·å–æ•°æ®åº“å®ä¾‹
   */
  static getDatabase(): relationalStore.RdbStore {
    if (!DatabaseManager.db) {
      throw new Error('[DatabaseManager] æ•°æ®åº“æœªåˆå§‹åŒ–ï¼Œè¯·å…ˆè°ƒç”¨ initDatabase()');
    }
    return DatabaseManager.db;
  }

  /**
   * æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²åˆå§‹åŒ–
   */
  static isDbInitialized(): boolean {
    return DatabaseManager.isInitialized && DatabaseManager.db !== null;
  }

  /**
   * åˆ›å»ºæ‰€æœ‰æ•°æ®è¡¨ï¼ˆæŒ‰ä¾èµ–é¡ºåºï¼‰
   */
  private static async createAllTables(): Promise<void> {
    const store = DatabaseManager.getDatabase();
    
    try {
      // 1. åˆ›å»ºç”¨æˆ·è¡¨ï¼ˆç‹¬ç«‹è¡¨ï¼Œæ— å¤–é”®ä¾èµ–ï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS users (
          user_id INTEGER PRIMARY KEY AUTOINCREMENT,
          username TEXT NOT NULL,
          email TEXT UNIQUE NOT NULL,
          password_hash TEXT NOT NULL,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0
        );
      `);
      console.log('[DatabaseManager] è¡¨ users åˆ›å»ºæˆåŠŸ');

      // 2. åˆ›å»ºè´¦æˆ·è¡¨ï¼ˆä¾èµ– usersï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS accounts (
          account_id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          name TEXT NOT NULL,
          type TEXT NOT NULL,
          balance REAL NOT NULL DEFAULT 0,
          color TEXT NOT NULL DEFAULT '#1890FF',
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0,
          FOREIGN KEY (user_id) REFERENCES users(user_id)
        );
      `);
      console.log('[DatabaseManager] è¡¨ accounts åˆ›å»ºæˆåŠŸ');

      // 3. åˆ›å»ºåˆ†ç±»è¡¨ï¼ˆä¾èµ– usersï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS categories (
          category_id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          name TEXT NOT NULL,
          type TEXT NOT NULL CHECK (type IN ('expense', 'income')),
          icon TEXT NOT NULL DEFAULT 'ğŸ“¦',
          color TEXT NOT NULL DEFAULT '#1890FF',
          parent_category_id INTEGER DEFAULT 0,
          sort_order INTEGER DEFAULT 0,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0 CHECK (is_deleted IN (0, 1)),
          FOREIGN KEY (user_id) REFERENCES users(user_id),
          UNIQUE(user_id, name, type)
        );
      `);
      
      // åˆ›å»ºåˆ†ç±»è¡¨ç´¢å¼•
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_category_user_type 
        ON categories(user_id, type) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_category_user_parent 
        ON categories(user_id, parent_category_id) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_category_sort 
        ON categories(user_id, sort_order, category_id);
      `);
      console.log('[DatabaseManager] è¡¨ categories åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 4. åˆ›å»ºè´¦å•è¡¨ï¼ˆä¾èµ– accounts å’Œ categoriesï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS bills (
          bill_id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          account_id INTEGER NOT NULL,
          category_id INTEGER NOT NULL,
          amount REAL NOT NULL,
          type TEXT NOT NULL,
          note TEXT,
          transaction_date TEXT NOT NULL,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0,
          FOREIGN KEY (user_id) REFERENCES users(user_id),
          FOREIGN KEY (account_id) REFERENCES accounts(account_id),
          FOREIGN KEY (category_id) REFERENCES categories(category_id)
        );
      `);
      console.log('[DatabaseManager] è¡¨ bills åˆ›å»ºæˆåŠŸ');

      // 5. åˆ›å»ºé¢„ç®—è¡¨ï¼ˆä¾èµ– users å’Œ categoriesï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS budgets (
          budget_id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          category_id INTEGER NOT NULL,
          amount REAL NOT NULL,
          period TEXT NOT NULL,
          start_date TEXT NOT NULL,
          end_date TEXT,
          is_active INTEGER DEFAULT 1,
          is_deleted INTEGER DEFAULT 0,
          created_at TEXT NOT NULL,
          FOREIGN KEY (user_id) REFERENCES users(user_id),
          FOREIGN KEY (category_id) REFERENCES categories(category_id)
        );
      `);
      console.log('[DatabaseManager] è¡¨ budgets åˆ›å»ºæˆåŠŸ');

      // 6. åˆ›å»ºæœˆåº¦ç»Ÿè®¡è¡¨
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS monthly_statistics (
          user_id INTEGER NOT NULL,
          category_id INTEGER NOT NULL,
          month TEXT NOT NULL,
          total_expense REAL DEFAULT 0,
          total_income REAL DEFAULT 0,
          transaction_count INTEGER DEFAULT 0,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0,
          PRIMARY KEY (user_id, category_id, month)
        );
      `);
      console.log('[DatabaseManager] è¡¨ monthly_statistics åˆ›å»ºæˆåŠŸ');

      // 7. åˆ›å»ºåˆ†ç±»ç»Ÿè®¡è¡¨
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS category_statistics (
          category_id INTEGER NOT NULL,
          category_name TEXT NOT NULL,
          type TEXT NOT NULL,
          total_amount REAL DEFAULT 0,
          transaction_count INTEGER DEFAULT 0,
          percentage REAL DEFAULT 0,
          icon TEXT NOT NULL DEFAULT 'ğŸ“¦',
          color TEXT NOT NULL DEFAULT '#1890FF',
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0,
          PRIMARY KEY (category_id)
        );
      `);
      console.log('[DatabaseManager] è¡¨ category_statistics åˆ›å»ºæˆåŠŸ');

      // 8. åˆ›å»ºæ ‡ç­¾è¡¨ï¼ˆä¾èµ– usersï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS tags (
          tag_id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          name TEXT NOT NULL,
          color TEXT DEFAULT '#52C41A',
          usage_count INTEGER DEFAULT 0,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0 CHECK (is_deleted IN (0, 1)),
          FOREIGN KEY (user_id) REFERENCES users(user_id),
          UNIQUE (user_id, name)
        );
      `);
      
      // åˆ›å»ºæ ‡ç­¾è¡¨ç´¢å¼•
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_tags_user 
        ON tags (user_id) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_tags_usage 
        ON tags (user_id, usage_count DESC) WHERE is_deleted = 0;
      `);
      console.log('[DatabaseManager] è¡¨ tags åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 9. åˆ›å»ºè´¦å•æ ‡ç­¾å…³è”è¡¨ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS bill_tags (
          bill_id INTEGER NOT NULL,
          tag_id INTEGER NOT NULL,
          created_at TEXT NOT NULL,
          PRIMARY KEY (bill_id, tag_id),
          FOREIGN KEY (bill_id) REFERENCES bills(bill_id) ON DELETE CASCADE,
          FOREIGN KEY (tag_id) REFERENCES tags(tag_id) ON DELETE CASCADE
        );
      `);
      
      // åˆ›å»ºå…³è”è¡¨ç´¢å¼•
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_bill_tags_bill 
        ON bill_tags (bill_id);
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_bill_tags_tag 
        ON bill_tags (tag_id);
      `);
      console.log('[DatabaseManager] è¡¨ bill_tags åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 10. åˆ›å»ºæé†’è¡¨ï¼ˆä¾èµ– users, categories, accounts, budgetsï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS reminders (
          reminder_id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          type TEXT NOT NULL CHECK (type IN ('bill', 'budget')),
          title TEXT NOT NULL,
          description TEXT,
          amount REAL,
          category_id INTEGER,
          account_id INTEGER,
          budget_id INTEGER,
          frequency TEXT NOT NULL CHECK (frequency IN ('once', 'daily', 'weekly', 'monthly', 'yearly')),
          reminder_date TEXT NOT NULL,
          next_reminder_date TEXT NOT NULL,
          is_active INTEGER DEFAULT 1 CHECK (is_active IN (0, 1)),
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0 CHECK (is_deleted IN (0, 1)),
          FOREIGN KEY (user_id) REFERENCES users(user_id),
          FOREIGN KEY (category_id) REFERENCES categories(category_id),
          FOREIGN KEY (account_id) REFERENCES accounts(account_id),
          FOREIGN KEY (budget_id) REFERENCES budgets(budget_id)
        );
      `);
      
      // åˆ›å»ºæé†’è¡¨ç´¢å¼•
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_reminders_user 
        ON reminders (user_id) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_reminders_next_date 
        ON reminders (user_id, next_reminder_date) WHERE is_active = 1 AND is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_reminders_type 
        ON reminders (user_id, type) WHERE is_deleted = 0;
      `);
      console.log('[DatabaseManager] è¡¨ reminders åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 11. åˆ›å»ºäº‘ç«¯åŒæ­¥è®°å½•è¡¨ï¼ˆä¾èµ– usersï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS cloud_sync_records (
          sync_id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          sync_type TEXT NOT NULL CHECK (sync_type IN ('full', 'incremental')),
          sync_direction TEXT NOT NULL CHECK (sync_direction IN ('upload', 'download', 'bidirectional')),
          status TEXT NOT NULL CHECK (status IN ('pending', 'in_progress', 'completed', 'failed')),
          data_types TEXT NOT NULL,
          record_count INTEGER DEFAULT 0,
          start_time TEXT NOT NULL,
          end_time TEXT,
          error_message TEXT,
          cloud_provider TEXT NOT NULL CHECK (cloud_provider IN ('huawei', 'custom')),
          last_sync_hash TEXT,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          FOREIGN KEY (user_id) REFERENCES users(user_id)
        );
      `);
      
      // åˆ›å»ºäº‘ç«¯åŒæ­¥è®°å½•è¡¨ç´¢å¼•
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_cloud_sync_user 
        ON cloud_sync_records (user_id);
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_cloud_sync_status 
        ON cloud_sync_records (user_id, status);
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_cloud_sync_time 
        ON cloud_sync_records (user_id, created_at DESC);
      `);
      console.log('[DatabaseManager] è¡¨ cloud_sync_records åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // ==================== é«˜çº§åŠŸèƒ½æ¨¡å—è¡¨åˆ›å»º ====================

      // 12. åˆ›å»ºå¼‚å¸¸è®°å½•è¡¨ï¼ˆå¼‚å¸¸æ£€æµ‹åŠŸèƒ½ï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS anomaly_records (
          anomaly_id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          bill_id INTEGER NOT NULL,
          anomaly_type TEXT NOT NULL CHECK (anomaly_type IN ('high_amount', 'low_amount', 'frequency_spike', 'unusual_time', 'unusual_category', 'pattern_break')),
          severity TEXT NOT NULL CHECK (severity IN ('low', 'medium', 'high', 'critical')),
          algorithm TEXT NOT NULL CHECK (algorithm IN ('sigma_3', 'z_score', 'iqr', 'moving_avg', 'ensemble')),
          score REAL NOT NULL DEFAULT 0,
          threshold REAL NOT NULL DEFAULT 0,
          expected_value REAL NOT NULL DEFAULT 0,
          actual_value REAL NOT NULL DEFAULT 0,
          deviation REAL NOT NULL DEFAULT 0,
          description TEXT,
          is_acknowledged INTEGER DEFAULT 0 CHECK (is_acknowledged IN (0, 1)),
          acknowledged_at TEXT,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0 CHECK (is_deleted IN (0, 1)),
          FOREIGN KEY (user_id) REFERENCES users(user_id),
          FOREIGN KEY (bill_id) REFERENCES bills(bill_id)
        );
      `);

      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_anomaly_user
        ON anomaly_records (user_id) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_anomaly_bill
        ON anomaly_records (bill_id) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_anomaly_severity
        ON anomaly_records (user_id, severity) WHERE is_deleted = 0 AND is_acknowledged = 0;
      `);
      console.log('[DatabaseManager] è¡¨ anomaly_records åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 13. åˆ›å»ºç”¨æˆ·æ¶ˆè´¹åŸºçº¿è¡¨ï¼ˆå¼‚å¸¸æ£€æµ‹åŸºç¡€æ•°æ®ï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS user_spending_baselines (
          baseline_id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          category_id INTEGER DEFAULT 0,
          period TEXT NOT NULL DEFAULT 'monthly',
          mean REAL NOT NULL DEFAULT 0,
          median REAL NOT NULL DEFAULT 0,
          std_dev REAL NOT NULL DEFAULT 0,
          variance REAL NOT NULL DEFAULT 0,
          min REAL NOT NULL DEFAULT 0,
          max REAL NOT NULL DEFAULT 0,
          q1 REAL NOT NULL DEFAULT 0,
          q3 REAL NOT NULL DEFAULT 0,
          iqr REAL NOT NULL DEFAULT 0,
          sample_size INTEGER NOT NULL DEFAULT 0,
          last_calculated_at TEXT NOT NULL,
          sample_start_date TEXT NOT NULL,
          sample_end_date TEXT NOT NULL,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0 CHECK (is_deleted IN (0, 1)),
          FOREIGN KEY (user_id) REFERENCES users(user_id),
          UNIQUE (user_id, category_id, period)
        );
      `);

      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_baseline_user_category
        ON user_spending_baselines (user_id, category_id) WHERE is_deleted = 0;
      `);
      console.log('[DatabaseManager] è¡¨ user_spending_baselines åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 14. åˆ›å»ºé¢†åŸŸäº‹ä»¶è¡¨ï¼ˆäº‹ä»¶æº¯æºåŠŸèƒ½ï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS domain_events (
          event_id TEXT PRIMARY KEY,
          event_type TEXT NOT NULL,
          aggregate_type TEXT NOT NULL CHECK (aggregate_type IN ('bill', 'category', 'account', 'budget', 'user', 'tag', 'ledger')),
          aggregate_id INTEGER NOT NULL,
          user_id INTEGER NOT NULL,
          version INTEGER NOT NULL DEFAULT 1,
          payload_json TEXT NOT NULL DEFAULT '{}',
          metadata_json TEXT NOT NULL DEFAULT '{}',
          occurred_at TEXT NOT NULL,
          created_at TEXT NOT NULL,
          FOREIGN KEY (user_id) REFERENCES users(user_id)
        );
      `);

      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_events_aggregate
        ON domain_events (aggregate_type, aggregate_id, version);
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_events_user
        ON domain_events (user_id, occurred_at DESC);
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_events_type
        ON domain_events (event_type, occurred_at DESC);
      `);
      console.log('[DatabaseManager] è¡¨ domain_events åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 15. åˆ›å»ºå‘½ä»¤è¡¨ï¼ˆCQRSå‘½ä»¤ä¾§ï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS commands (
          command_id TEXT PRIMARY KEY,
          command_type TEXT NOT NULL,
          aggregate_type TEXT NOT NULL CHECK (aggregate_type IN ('bill', 'category', 'account', 'budget', 'user', 'tag', 'ledger')),
          aggregate_id INTEGER NOT NULL DEFAULT 0,
          user_id INTEGER NOT NULL,
          payload_json TEXT NOT NULL DEFAULT '{}',
          status TEXT NOT NULL CHECK (status IN ('pending', 'processing', 'succeeded', 'failed', 'cancelled')),
          metadata_json TEXT NOT NULL DEFAULT '{}',
          expected_version INTEGER NOT NULL DEFAULT 0,
          issued_at TEXT NOT NULL,
          processed_at TEXT,
          error_message TEXT,
          FOREIGN KEY (user_id) REFERENCES users(user_id)
        );
      `);

      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_commands_status
        ON commands (status, issued_at);
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_commands_user
        ON commands (user_id, issued_at DESC);
      `);
      console.log('[DatabaseManager] è¡¨ commands åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 16. åˆ›å»ºèšåˆå¿«ç…§è¡¨ï¼ˆäº‹ä»¶æº¯æºæ€§èƒ½ä¼˜åŒ–ï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS aggregate_snapshots (
          snapshot_id INTEGER PRIMARY KEY AUTOINCREMENT,
          aggregate_type TEXT NOT NULL CHECK (aggregate_type IN ('bill', 'category', 'account', 'budget', 'user', 'tag', 'ledger')),
          aggregate_id INTEGER NOT NULL,
          version INTEGER NOT NULL,
          state_json TEXT NOT NULL DEFAULT '{}',
          created_at TEXT NOT NULL,
          UNIQUE (aggregate_type, aggregate_id, version)
        );
      `);

      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_snapshots_aggregate
        ON aggregate_snapshots (aggregate_type, aggregate_id, version DESC);
      `);
      console.log('[DatabaseManager] è¡¨ aggregate_snapshots åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 17. åˆ›å»ºè¯»æ¨¡å‹è¡¨ï¼ˆCQRSæŸ¥è¯¢ä¾§ï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS read_models (
          model_id INTEGER PRIMARY KEY AUTOINCREMENT,
          model_type TEXT NOT NULL,
          user_id INTEGER NOT NULL,
          data_json TEXT NOT NULL DEFAULT '{}',
          last_event_version INTEGER NOT NULL DEFAULT 0,
          last_updated_at TEXT NOT NULL,
          created_at TEXT NOT NULL,
          FOREIGN KEY (user_id) REFERENCES users(user_id),
          UNIQUE (model_type, user_id)
        );
      `);

      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_read_models_user_type
        ON read_models (user_id, model_type);
      `);
      console.log('[DatabaseManager] è¡¨ read_models åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 18. åˆ›å»ºå…±äº«è´¦æœ¬è¡¨
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS shared_ledgers (
          ledger_id INTEGER PRIMARY KEY AUTOINCREMENT,
          name TEXT NOT NULL,
          description TEXT,
          type TEXT NOT NULL CHECK (type IN ('personal', 'family', 'couple', 'roommate', 'team', 'project')),
          owner_id INTEGER NOT NULL,
          owner_name TEXT NOT NULL,
          currency TEXT NOT NULL DEFAULT 'CNY',
          icon TEXT,
          color TEXT NOT NULL DEFAULT '#2196F3',
          member_count INTEGER NOT NULL DEFAULT 1,
          settings_json TEXT NOT NULL DEFAULT '{}',
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0 CHECK (is_deleted IN (0, 1)),
          FOREIGN KEY (owner_id) REFERENCES users(user_id)
        );
      `);

      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_ledgers_owner
        ON shared_ledgers (owner_id) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_ledgers_type
        ON shared_ledgers (type) WHERE is_deleted = 0;
      `);
      console.log('[DatabaseManager] è¡¨ shared_ledgers åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 19. åˆ›å»ºè´¦æœ¬æˆå‘˜è¡¨
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS ledger_members (
          member_id INTEGER PRIMARY KEY AUTOINCREMENT,
          ledger_id INTEGER NOT NULL,
          user_id INTEGER NOT NULL,
          username TEXT NOT NULL,
          email TEXT NOT NULL,
          avatar TEXT,
          role TEXT NOT NULL CHECK (role IN ('owner', 'admin', 'member', 'viewer')),
          permissions_json TEXT NOT NULL DEFAULT '[]',
          nickname TEXT,
          contribution_amount REAL NOT NULL DEFAULT 0,
          bill_count INTEGER NOT NULL DEFAULT 0,
          joined_at TEXT NOT NULL,
          last_active_at TEXT NOT NULL,
          is_active INTEGER DEFAULT 1 CHECK (is_active IN (0, 1)),
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0 CHECK (is_deleted IN (0, 1)),
          FOREIGN KEY (ledger_id) REFERENCES shared_ledgers(ledger_id) ON DELETE CASCADE,
          FOREIGN KEY (user_id) REFERENCES users(user_id),
          UNIQUE (ledger_id, user_id)
        );
      `);

      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_ledger_members_ledger
        ON ledger_members (ledger_id) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_ledger_members_user
        ON ledger_members (user_id) WHERE is_deleted = 0;
      `);
      console.log('[DatabaseManager] è¡¨ ledger_members åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 20. åˆ›å»ºè´¦æœ¬é‚€è¯·è¡¨
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS ledger_invitations (
          invitation_id INTEGER PRIMARY KEY AUTOINCREMENT,
          ledger_id INTEGER NOT NULL,
          ledger_name TEXT NOT NULL,
          inviter_id INTEGER NOT NULL,
          inviter_name TEXT NOT NULL,
          invitee_email TEXT NOT NULL,
          invitee_user_id INTEGER DEFAULT 0,
          role TEXT NOT NULL CHECK (role IN ('owner', 'admin', 'member', 'viewer')),
          message TEXT,
          status TEXT NOT NULL CHECK (status IN ('pending', 'accepted', 'declined', 'expired', 'cancelled')),
          invitation_code TEXT NOT NULL,
          expires_at TEXT NOT NULL,
          responded_at TEXT,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0 CHECK (is_deleted IN (0, 1)),
          FOREIGN KEY (ledger_id) REFERENCES shared_ledgers(ledger_id) ON DELETE CASCADE,
          FOREIGN KEY (inviter_id) REFERENCES users(user_id),
          UNIQUE (invitation_code)
        );
      `);

      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_invitations_ledger
        ON ledger_invitations (ledger_id) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_invitations_email
        ON ledger_invitations (invitee_email, status) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_invitations_code
        ON ledger_invitations (invitation_code) WHERE is_deleted = 0;
      `);
      console.log('[DatabaseManager] è¡¨ ledger_invitations åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 21. åˆ›å»ºå…±äº«è´¦å•è¡¨
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS shared_bills (
          bill_id INTEGER PRIMARY KEY AUTOINCREMENT,
          ledger_id INTEGER NOT NULL,
          creator_id INTEGER NOT NULL,
          creator_name TEXT NOT NULL,
          account_id INTEGER NOT NULL,
          category_id INTEGER NOT NULL,
          amount REAL NOT NULL,
          note TEXT,
          transaction_date TEXT NOT NULL,
          type TEXT NOT NULL CHECK (type IN ('income', 'expense')),
          approval_status TEXT NOT NULL CHECK (approval_status IN ('pending', 'approved', 'rejected', 'auto_approved')),
          approved_by INTEGER DEFAULT 0,
          approved_at TEXT,
          sync_status TEXT NOT NULL CHECK (sync_status IN ('synced', 'pending', 'conflict', 'failed')),
          last_synced_at TEXT,
          version INTEGER NOT NULL DEFAULT 1,
          split_type TEXT NOT NULL CHECK (split_type IN ('equal', 'custom', 'percentage', 'none')),
          split_details_json TEXT NOT NULL DEFAULT '[]',
          attachments_json TEXT NOT NULL DEFAULT '[]',
          tags_json TEXT NOT NULL DEFAULT '[]',
          location TEXT,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0 CHECK (is_deleted IN (0, 1)),
          FOREIGN KEY (ledger_id) REFERENCES shared_ledgers(ledger_id) ON DELETE CASCADE,
          FOREIGN KEY (creator_id) REFERENCES users(user_id),
          FOREIGN KEY (account_id) REFERENCES accounts(account_id),
          FOREIGN KEY (category_id) REFERENCES categories(category_id)
        );
      `);

      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_shared_bills_ledger
        ON shared_bills (ledger_id, transaction_date DESC) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_shared_bills_creator
        ON shared_bills (creator_id) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_shared_bills_approval
        ON shared_bills (ledger_id, approval_status) WHERE is_deleted = 0;
      `);
      console.log('[DatabaseManager] è¡¨ shared_bills åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 22. åˆ›å»ºå®¡æ‰¹è®°å½•è¡¨
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS approval_records (
          approval_id INTEGER PRIMARY KEY AUTOINCREMENT,
          ledger_id INTEGER NOT NULL,
          bill_id INTEGER NOT NULL,
          requester_id INTEGER NOT NULL,
          requester_name TEXT NOT NULL,
          approver_id INTEGER DEFAULT 0,
          approver_name TEXT,
          status TEXT NOT NULL CHECK (status IN ('pending', 'approved', 'rejected', 'auto_approved')),
          amount REAL NOT NULL,
          reason TEXT,
          comment TEXT,
          requested_at TEXT NOT NULL,
          processed_at TEXT,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0 CHECK (is_deleted IN (0, 1)),
          FOREIGN KEY (ledger_id) REFERENCES shared_ledgers(ledger_id) ON DELETE CASCADE,
          FOREIGN KEY (bill_id) REFERENCES shared_bills(bill_id) ON DELETE CASCADE,
          FOREIGN KEY (requester_id) REFERENCES users(user_id)
        );
      `);

      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_approvals_ledger
        ON approval_records (ledger_id, status) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_approvals_bill
        ON approval_records (bill_id) WHERE is_deleted = 0;
      `);
      console.log('[DatabaseManager] è¡¨ approval_records åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 23. åˆ›å»ºæˆå‘˜æ´»åŠ¨è®°å½•è¡¨
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS member_activities (
          activity_id INTEGER PRIMARY KEY AUTOINCREMENT,
          ledger_id INTEGER NOT NULL,
          user_id INTEGER NOT NULL,
          username TEXT NOT NULL,
          action_type TEXT NOT NULL CHECK (action_type IN ('create', 'update', 'delete', 'approve', 'reject', 'join', 'leave')),
          target_type TEXT NOT NULL CHECK (target_type IN ('bill', 'category', 'budget', 'member', 'settings')),
          target_id INTEGER NOT NULL,
          description TEXT,
          metadata_json TEXT NOT NULL DEFAULT '{}',
          created_at TEXT NOT NULL,
          FOREIGN KEY (ledger_id) REFERENCES shared_ledgers(ledger_id) ON DELETE CASCADE,
          FOREIGN KEY (user_id) REFERENCES users(user_id)
        );
      `);

      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_activities_ledger
        ON member_activities (ledger_id, created_at DESC);
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_activities_user
        ON member_activities (user_id, created_at DESC);
      `);
      console.log('[DatabaseManager] è¡¨ member_activities åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 24. åˆ›å»ºæ™ºèƒ½åˆ†ç±»è®­ç»ƒæ•°æ®è¡¨
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS smart_category_training (
          training_id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          bill_id INTEGER NOT NULL,
          predicted_category_id INTEGER NOT NULL,
          actual_category_id INTEGER NOT NULL,
          confidence REAL NOT NULL DEFAULT 0,
          features_json TEXT NOT NULL DEFAULT '{}',
          is_correct INTEGER DEFAULT 0 CHECK (is_correct IN (0, 1)),
          created_at TEXT NOT NULL,
          FOREIGN KEY (user_id) REFERENCES users(user_id),
          FOREIGN KEY (bill_id) REFERENCES bills(bill_id)
        );
      `);

      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_training_user
        ON smart_category_training (user_id, created_at DESC);
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_training_accuracy
        ON smart_category_training (user_id, is_correct);
      `);
      console.log('[DatabaseManager] è¡¨ smart_category_training åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 25. åˆ›å»ºæ™ºèƒ½åˆ†ç±»è§„åˆ™è¡¨
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS smart_category_rules (
          rule_id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          category_id INTEGER NOT NULL,
          rule_type TEXT NOT NULL CHECK (rule_type IN ('keyword', 'amount_range', 'time_pattern', 'merchant', 'combined')),
          condition_json TEXT NOT NULL DEFAULT '{}',
          priority INTEGER NOT NULL DEFAULT 0,
          confidence REAL NOT NULL DEFAULT 1.0,
          usage_count INTEGER NOT NULL DEFAULT 0,
          success_count INTEGER NOT NULL DEFAULT 0,
          is_active INTEGER DEFAULT 1 CHECK (is_active IN (0, 1)),
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0 CHECK (is_deleted IN (0, 1)),
          FOREIGN KEY (user_id) REFERENCES users(user_id),
          FOREIGN KEY (category_id) REFERENCES categories(category_id)
        );
      `);

      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_rules_user
        ON smart_category_rules (user_id, priority DESC) WHERE is_active = 1 AND is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_rules_category
        ON smart_category_rules (category_id) WHERE is_active = 1 AND is_deleted = 0;
      `);
      console.log('[DatabaseManager] è¡¨ smart_category_rules åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 26. åˆ›å»ºOCRè¯†åˆ«è®°å½•è¡¨
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS ocr_recognition_records (
          recognition_id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          bill_id INTEGER DEFAULT 0,
          image_path TEXT NOT NULL,
          recognition_status TEXT NOT NULL CHECK (recognition_status IN ('pending', 'processing', 'completed', 'failed')),
          confidence REAL NOT NULL DEFAULT 0,
          extracted_data_json TEXT NOT NULL DEFAULT '{}',
          merchant_name TEXT,
          amount REAL DEFAULT 0,
          transaction_date TEXT,
          category_suggestion TEXT,
          error_message TEXT,
          processing_time_ms INTEGER DEFAULT 0,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0 CHECK (is_deleted IN (0, 1)),
          FOREIGN KEY (user_id) REFERENCES users(user_id),
          FOREIGN KEY (bill_id) REFERENCES bills(bill_id)
        );
      `);

      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_ocr_user
        ON ocr_recognition_records (user_id, created_at DESC) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_ocr_status
        ON ocr_recognition_records (recognition_status) WHERE is_deleted = 0;
      `);
      console.log('[DatabaseManager] è¡¨ ocr_recognition_records åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      console.log('[DatabaseManager] æ‰€æœ‰æ•°æ®è¡¨åˆ›å»ºå®Œæˆï¼ˆå…±26å¼ è¡¨ï¼‰');
    } catch (error) {
      throw DatabaseManager.toError('[DatabaseManager] åˆ›å»ºæ•°æ®è¡¨å¤±è´¥', error);
    }
  }

  /**
   * å…³é—­æ•°æ®åº“è¿æ¥
   */
  static async closeDatabase(): Promise<void> {
    if (DatabaseManager.db) {
      // HarmonyOS çš„ RdbStore æ²¡æœ‰æ˜¾å¼çš„ close æ–¹æ³•
      // æ•°æ®åº“ä¼šåœ¨åº”ç”¨é€€å‡ºæ—¶è‡ªåŠ¨å…³é—­
      DatabaseManager.db = null;
      DatabaseManager.isInitialized = false;
      console.log('[DatabaseManager] æ•°æ®åº“è¿æ¥å·²æ¸…ç†');
    }
  }

  /**
   * ç»Ÿä¸€é”™è¯¯å¤„ç†
   */
  private static toError(message: string, err: Error | string | object): Error {
    let details = '';
    try {
      details = typeof err === 'string' ? err : JSON.stringify(err);
    } catch (_) {
      details = String(err);
    }
    return new Error(`${message}${details ? ' -> ' + details : ''}`);
  }

  /**
   * æ‰§è¡Œäº‹åŠ¡
   * @throws
   */
  static async transaction(fn: () => Promise<void>): Promise<void> {
    const store = DatabaseManager.getDatabase();
    await store.beginTransaction();
    try {
      await fn();
      await store.commit();
    } catch (error) {
      await store.rollBack();
      throw DatabaseManager.toError('[DatabaseManager] äº‹åŠ¡æ‰§è¡Œå¤±è´¥', error);
    }
  }
}
