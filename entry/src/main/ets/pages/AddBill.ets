import router from '@ohos.router'
import { Bill } from '../model/Bill'
import { BillDAO } from '../dao/BillDAO'
// 2. å¯¼å…¥ promptAction ç”¨äºæ˜¾ç¤º Toast æç¤º
import { promptAction } from '@kit.ArkUI';
import type { BusinessError } from '@ohos.base';
import { Account } from '../model/Account' //
import { AccountDAO } from '../dao/AccountDAO' //
import { Category } from '../model/Category' //
import { CategoryDAO } from '../dao/CategoryDAO' //
import { hilog } from '@kit.PerformanceAnalysisKit';
import { BreakPointType } from '../common/BreakpointSystem';
import { UserSessionService } from '../service/UserSessionService';
import { SmartCategoryService } from '../service/SmartCategoryService';

const HILOG_DOMAIN = 0x0001
const LOG_TAG = 'AddBill'

class SelectOption {
  value: string; // 'value' æ˜¯ Select ç»„ä»¶è¦æ±‚å¿…é¡»æœ‰çš„

  constructor(value: string) {
    this.value = value;
  }
}
@Entry
@Component
struct AddBill{
  @State amount: string = '';
  @State selectedDate: Date = new Date(); // é»˜è®¤ä¸ºå½“å‰æ—¥æœŸ
  @State notes: string = '';
  @State billType: 'expense' | 'income' = 'expense'; // æ”¯å‡ºæˆ–æ”¶å…¥
  // 2. æ–°å¢ç”¨äºå­˜å‚¨åˆ—è¡¨å’Œå½“å‰é€‰é¡¹
  @State allCategories: Array<Category> = [];
  @State allAccounts: Array<Account> = [];

  @State selectedCategoryId: number = 1;
  @State selectedAccountId: number = 1;

  @State categoryOptions: SelectOption[] = [];
  @State accountOptions: SelectOption[] = []; // Added from MAIN logic requirement

  // æ™ºèƒ½åˆ†ç±»æ¨èç›¸å…³
  @State suggestedCategoryId: number = 0;
  @State suggestedCategoryName: string = '';
  @State showSuggestion: boolean = false;

  @StorageProp('currentBreakpoint') currentBreakpoint: string = 'md';
  // å“åº”å¼é…ç½®
  private inputFontSize = new BreakPointType({ xs: 20, sm: 22, md: 24, lg: 28, xl: 32, xxl: 36 });
  private labelFontSize = new BreakPointType({ xs: 14, sm: 15, md: 16, lg: 18, xl: 20, xxl: 22 });
  private buttonWidth = new BreakPointType({ xs: '95%', sm: '92%', md: '90%', lg: '80%', xl: '70%', xxl: '60%' });
  private contentPadding = new BreakPointType({ xs: 10, sm: 12, md: 15, lg: 18, xl: 20, xxl: 24 });

  async loadData(){
    try{
      const userId = UserSessionService.getCurrentUserId();
      if (!userId) {
         promptAction.showToast({ message: 'è¯·å…ˆç™»å½•' });
         return;
      }
      hilog.info(HILOG_DOMAIN, LOG_TAG, `å¼€å§‹åŠ è½½æ•°æ®ï¼Œç±»å‹: ${this.billType}`);
      //æ·»åŠ æ”¯å‡ºåˆ†è£‚
      const accounts = await AccountDAO.getByUserId(userId);
      const categories = await CategoryDAO.getByType(userId,this.billType);


      this.allCategories = categories;
      this.allAccounts = accounts;
     // tOption æ•°ç»„
      this.categoryOptions = categories.map(cat => new SelectOption(cat.name));
      this.accountOptions = accounts.map(acc => new SelectOption(acc.name));

      //è®¾ç½®é»˜è®¤é€‰ä¸­é¡¹
      // Logic from MAIN: Check existence
      if (categories.length > 0) {
        const exists = categories.some(c => c.categoryId === this.selectedCategoryId);
        if (!exists) {
          this.selectedCategoryId = categories[0].categoryId;
        }
      } else {
        this.selectedCategoryId = 0;
      }

      if (accounts.length > 0) {
         const exists = accounts.some(a => a.accountId === this.selectedAccountId);
         if (!exists) {
          this.selectedAccountId = accounts[0].accountId;
        }
      } else {
        // HEAD Logic: prompt to create account
        promptAction.showToast({ message: 'è¯·å…ˆåˆ›å»ºè‡³å°‘ä¸€ä¸ªè´¦æˆ·' });
        // å»¶æ—¶è·³è½¬
        setTimeout(() => {
           router.pushUrl({ url: 'pages/AccountManagementPage' });
        }, 1000);
        return;
      }
      
      hilog.info(HILOG_DOMAIN, LOG_TAG, 'åˆ†ç±»å’Œè´¦æˆ·åŠ è½½æˆåŠŸ');

    }catch(error){
      hilog.error(HILOG_DOMAIN, LOG_TAG, 'åŠ è½½æ•°æ®å¤±è´¥: %{public}s', JSON.stringify(error));
      promptAction.showToast({ message: 'åŠ è½½åˆ†ç±»/è´¦æˆ·åˆ—è¡¨å¤±è´¥' });
    }

  }
  //åˆ›å»ºä¸€ä¸ªè¾…åŠ©å‡½æ•°:å°†Dateå¯¹è±¡è½¬æ¢æˆç›¸åº”çš„æ ¼å¼
  private formatDate(date:Date):string{
    const y = date.getFullYear();
    const m = (date.getMonth() + 1).toString().padStart(2, '0');
    const d = date.getDate().toString().padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  // æ™ºèƒ½åˆ†ç±»æ¨è
  private async getSmartCategoryRecommendation() {
    if (!this.notes || this.notes.trim().length === 0) {
      this.showSuggestion = false;
      return;
    }

    const userId = UserSessionService.getCurrentUserId();
    if (!userId) return;

    try {
      const amount = parseFloat(this.amount) || 0;
      const recommendations = await SmartCategoryService.recommendCategory(
        userId,
        this.notes,
        amount,
        1
      );

      if (recommendations.length > 0 && recommendations[0].confidence > 0.6) {
        this.suggestedCategoryId = recommendations[0].categoryId;
        this.suggestedCategoryName = recommendations[0].categoryName;
        this.showSuggestion = true;
        hilog.info(HILOG_DOMAIN, LOG_TAG, `æ™ºèƒ½æ¨èåˆ†ç±»: ${this.suggestedCategoryName}`);
      } else {
        this.showSuggestion = false;
      }
    } catch (error) {
      hilog.error(HILOG_DOMAIN, LOG_TAG, 'æ™ºèƒ½åˆ†ç±»æ¨èå¤±è´¥: %{public}s', JSON.stringify(error));
      this.showSuggestion = false;
    }
  }

  // åº”ç”¨æ™ºèƒ½æ¨è
  private applySuggestion() {
    if (this.suggestedCategoryId > 0) {
      this.selectedCategoryId = this.suggestedCategoryId;
      this.showSuggestion = false;
      promptAction.showToast({ message: `å·²åº”ç”¨æ¨èåˆ†ç±»: ${this.suggestedCategoryName}` });
    }
  }

  build() {

    Navigation() {
      // --- æ”¯å‡º/æ”¶å…¥ åˆ‡æ¢å™¨ ---
      Tabs({ index: this.billType === 'expense' ? 0 : 1 }) {
        TabContent().tabBar('æ”¯å‡º')
        TabContent().tabBar('æ”¶å…¥')
      }
      .barMode(BarMode.Fixed)
      .width('60%')
      .height(40)
      .margin(10)
      .onChange((index: number) => {
        this.billType = (index === 0) ? 'expense' : 'income';
        // åˆ‡æ¢ Tab æ—¶ï¼Œå¿…é¡»é‡æ–°è°ƒç”¨ loadData
        this.loadData();
      })

      Column({ space: 15 }) {
        TextInput({ placeholder: '0.00' })
          .type(InputType.Number) // ä½¿ç”¨æ•°å­—è¾“å…¥æ³•
          .fontSize(this.inputFontSize.getValue(this.currentBreakpoint) as number)
          .fontWeight(FontWeight.Bold)
          .onChange((value) => {
            this.amount = value;
          })
          .margin({ top: 20 })
        //ç”»ä¸€æ¡åˆ†å‰²çº¿
        Divider()


        Row() {
          Text('åˆ†ç±»')
            .fontSize(this.labelFontSize.getValue(this.currentBreakpoint) as number)
            .fontWeight(FontWeight.Bold)
            // ä½¿ç”¨Spacer()æ¥å¡«å……å‰©ä½™ç©ºé—´
            .padding(10)
          //ä½¿ç”¨Selectç»„ä»¶

          Select(this.categoryOptions)
            .value(this.allCategories.find(c => c.categoryId === this.selectedCategoryId)?.name ?? 'è¯·é€‰æ‹©åˆ†ç±»')
            .onSelect((index: number) => {
              this.selectedCategoryId = this.allCategories[index].categoryId;
            })
            .fontColor(Color.Gray)

        }
        .width('100%')
        .padding(10)
        .backgroundColor(Color.White)

        Divider()

        // è´¦æˆ·é€‰æ‹©è¡Œ (From MAIN)
        Row() {
          Text('è´¦æˆ·')
            .fontSize(this.labelFontSize.getValue(this.currentBreakpoint) as number)
            .fontWeight(FontWeight.Bold)
            .padding(10)

          if (this.allAccounts.length > 0) {
            Select(this.accountOptions)
              .value(this.allAccounts.find(a => a.accountId === this.selectedAccountId)?.name ?? 'è¯·é€‰æ‹©è´¦æˆ·')
              .onSelect((index: number) => {
                this.selectedAccountId = this.allAccounts[index].accountId;
              })
              .fontColor(Color.Gray)
          } else {
             Text('æš‚æ— è´¦æˆ·ï¼Œå»åˆ›å»º >')
               .fontSize(14)
               .fontColor(Color.Blue)
               .onClick(() => {
                 router.pushUrl({ url: 'pages/AccountManagement' })
               })
          }
        }
        .width('100%')
        .padding(10)
        .backgroundColor(Color.White)

        // æ—¥æœŸé€‰æ‹©å™¨
        DatePicker({
          start: new Date('2020-01-01'),
          end: new Date('2030-12-31'),
          selected: this.selectedDate
        })
          .onChange((value: DatePickerResult) => {
            //ä½¿ç”¨ç©ºå€¼åˆå¹¶??,æ¥æ’é™¤value.yearå½“ä¸­çš„æœªå®šä¹‰çš„æƒ…å†µ
            const now  = new Date();
            const year = value.year ?? now.getFullYear();
            const month = value.month??now.getMonth();
            const day = value.day??now.getDate();

            //è¿™æ ·å°±å¯ä»¥ä¿è¯year,month,dayæ˜¯çº¯æ•°å­—
            this.selectedDate = new Date(year,month,day);

          })

        //å¤‡æ³¨
        TextArea({placeholder:'ç‚¹å‡»æ·»åŠ å¤‡æ³¨...'})
          .onChange((value:string)=>{
            this.notes = value;
            // å®æ—¶è§¦å‘æ™ºèƒ½åˆ†ç±»æ¨è
            this.getSmartCategoryRecommendation();
          })
          .layoutWeight(1)  //å æ®å‰©ä½™ç©ºé—´
          .backgroundColor(Color.White)

        // æ™ºèƒ½æ¨èæç¤ºæ¡†
        if (this.showSuggestion) {
          Row() {
            Text('ğŸ’¡ æ¨èåˆ†ç±»: ')
              .fontSize(14)
              .fontColor(Color.Grey)
            Text(this.suggestedCategoryName)
              .fontSize(14)
              .fontColor(Color.Blue)
              .fontWeight(FontWeight.Bold)
            Button('åº”ç”¨')
              .fontSize(12)
              .height(30)
              .margin({ left: 10 })
              .onClick(() => this.applySuggestion())
          }
          .width('95%')
          .padding(10)
          .backgroundColor('#F0F8FF')
          .borderRadius(8)
        }

        //ä¿å­˜æŒ‰é’®
        Button('ä¿å­˜')
          .width(this.buttonWidth.getValue(this.currentBreakpoint) as string)
          .height(50)
          .type(ButtonType.Capsule)
          .margin(15)
          .onClick(async () => {
            const userId = UserSessionService.getCurrentUserId();
            if (!userId) {
              promptAction.showToast({ message: 'ç™»å½•å¤±æ•ˆ' });
              return;
            }

            const finalAmount = parseFloat(this.amount);
            if (isNaN(finalAmount) || finalAmount <= 0) {
              promptAction.showToast({ message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢' });
              return;
            }
            if (!this.selectedCategoryId ||this.selectedCategoryId <= 0){
              promptAction.showToast({ message: 'è¯·é€‰æ‹©åˆ†ç±»' });
              return;
            }
            if (!this.selectedAccountId ||this.selectedAccountId <= 0){
              promptAction.showToast({ message: 'è¯·é€‰æ‹©è´¦æˆ·' });
              return;
            }


            //åˆ›å»ºè´¦å•å¯¹è±¡
            const now = new Date().toISOString();
            const newBill = new Bill();

            // ä½¿ç”¨ @State ä¸­çš„çœŸå®æ•°æ®
            newBill.userId = userId;
            newBill.accountId = this.selectedAccountId;
            newBill.categoryId = this.selectedCategoryId;
            newBill.type = this.billType;

            // ä»è¡¨å•è·å–çš„æ•°æ®
            newBill.amount = finalAmount;
            newBill.type = this.billType;
            newBill.note = this.notes;
            newBill.transactionDate = this.formatDate(this.selectedDate); // 'YYYY-MM-DD'
            newBill.createdAt = now;
            newBill.updatedAt = now;
            newBill.isDeleted = 0;
            //è°ƒç”¨æ¥å£æ’å…¥æ•°æ®
            // ä½™é¢æ£€æŸ¥ä¸æ›´æ–° (HEAD Logic)
            try {
               const account = await AccountDAO.getById(this.selectedAccountId);
               if (!account) {
                 promptAction.showToast({ message: 'è´¦æˆ·ä¸å­˜åœ¨' });
                 return;
               }
               
               if (this.billType === 'expense') {
                  if (account.balance < finalAmount) {
                     // ä½™é¢ä¸è¶³æé†’ï¼Œä½†å…è®¸è®°è´¦ï¼ˆæˆ–è€…æ ¹æ®éœ€æ±‚æ‹¦æˆªï¼‰
                     promptAction.showToast({ message: `ä½™é¢ä¸è¶³ï¼å½“å‰: ${account.balance}` });
                     // è¿™é‡Œæˆ‘ä»¬æš‚æ—¶å…è®¸ç»§ç»­ï¼Œåªæ˜¯æé†’
                  }
                  account.balance -= finalAmount;
               } else {
                  account.balance += finalAmount;
               }
               
               // æ›´æ–°è´¦æˆ·ä½™é¢
               await AccountDAO.update(account);
               
            } catch (err) {
               console.error('Account update failed: ', err);
            }

            try{
              await BillDAO.insert(newBill);

              // è§¦å‘æ™ºèƒ½å­¦ä¹ æœºåˆ¶
              try {
                const selectedCategory = this.allCategories.find(c => c.categoryId === this.selectedCategoryId);
                if (selectedCategory) {
                  await SmartCategoryService.learnFromUserAction(
                    userId,
                    this.notes,
                    finalAmount,
                    this.selectedCategoryId,
                    selectedCategory.name,
                    this.suggestedCategoryId > 0 ? this.suggestedCategoryId : undefined
                  );
                  hilog.info(HILOG_DOMAIN, LOG_TAG, 'æ™ºèƒ½å­¦ä¹ å®Œæˆ');
                }
              } catch (learnError) {
                hilog.error(HILOG_DOMAIN, LOG_TAG, 'æ™ºèƒ½å­¦ä¹ å¤±è´¥: %{public}s', JSON.stringify(learnError));
                // å­¦ä¹ å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
              }

              promptAction.showToast({ message: 'ä¿å­˜æˆåŠŸï¼Œä½™é¢å·²æ›´æ–°' });

              // TODO: Sprint 1 ä»»åŠ¡,é€šçŸ¥é¦–é¡µåˆ·æ–°
              // (ç›®å‰å…ˆç›´æ¥è¿”å›)
              router.back();
            }catch (error){
              console.error('[æ·»åŠ è´¦å•] ä¿å­˜å¤±è´¥: %{public}s', JSON.stringify(error));
              promptAction.showToast({ message: `ä¿å­˜å¤±è´¥: ${error.message}` });
            }
          })
      }
      .padding(this.contentPadding.getValue(this.currentBreakpoint) as number)
      .width('100%')
      .height('100%')
      .backgroundColor($r('sys.color.point_color_checked'))
    }
    .title('è®°ä¸€ç¬”')
    .titleMode(NavigationTitleMode.Mini)
  }
}
