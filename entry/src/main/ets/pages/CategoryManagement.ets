import router from '@ohos.router';
import { Category } from '../model/Category'
import { CategoryDAO } from '../dao/CategoryDAO'
import { CategoryTreeNode } from '../model/AggregationTypes'
import promptAction from '@ohos.promptAction'
import hilog from '@ohos.hilog'
import type { BusinessError } from '@ohos.base'
import { BreakPointType } from '../common/BreakpointSystem';
import { UserSessionService } from '../service/UserSessionService';

// HILOG å®šä¹‰
const LOG_TAG = 'CategoryManagement'
const HILOG_DOMAIN = 0x0001

// æ‰å¹³åŒ–çš„æ ‘å½¢èŠ‚ç‚¹ï¼ˆç”¨äºåˆ—è¡¨æ¸²æŸ“ï¼‰
interface FlatTreeItem {
  category: Category;
  level: number;       // å±‚çº§æ·±åº¦ï¼ˆ0=é¡¶çº§ï¼Œ1=ä¸€çº§å­åˆ†ç±»...ï¼‰
  hasChildren: boolean; // æ˜¯å¦æœ‰å­åˆ†ç±»
  isExpanded: boolean;  // æ˜¯å¦å±•å¼€
}

// ---------------------------------
// (C/U) æ–°å»º/ç¼–è¾‘åˆ†ç±»çš„å¼¹çª—
// ---------------------------------
@CustomDialog
struct CategoryEditDialog {
  controller: CustomDialogController
  editingCategory: Category | null = null
  // å¯é€‰çˆ¶åˆ†ç±»åˆ—è¡¨ï¼ˆä¸åŒ…å«è‡ªå·±åŠå…¶å­åˆ†ç±»ï¼‰
  availableParents: Category[] = []
  onSave: () => void = () => {}

  build() {
    if (this.editingCategory) {
      Scroll() {
        Column({ space: 15 }) {
          TextInput({
            placeholder: 'åˆ†ç±»åç§°',
            text: this.editingCategory.name
          })
            .onChange((value: string) => {
              if (this.editingCategory) {
                this.editingCategory.name = value
              }
            })

          TextInput({
            placeholder: 'å›¾æ ‡ (å¦‚: ğŸ’ª)',
            text: this.editingCategory.icon
          })
            .onChange((value: string) => {
              if (this.editingCategory) {
                this.editingCategory.icon = value
              }
            })

          TextInput({
            placeholder: 'é¢œè‰² (ä¾‹å¦‚: #FF6B6B)',
            text: this.editingCategory.color
          })
            .onChange((value: string) => {
              if (this.editingCategory) {
                this.editingCategory.color = value
              }
            })

          // ç±»å‹é€‰æ‹©ï¼šæ”¯å‡º / æ”¶å…¥
          Tabs({
            index: this.editingCategory.type === 'expense' ? 0 : 1
          }) {
            TabContent().tabBar('æ”¯å‡º')
            TabContent().tabBar('æ”¶å…¥')
          }
          .barMode(BarMode.Fixed)
          .onChange((index: number) => {
            if (this.editingCategory) {
              this.editingCategory.type = (index === 0) ? 'expense' : 'income'
            }
          })

          // çˆ¶åˆ†ç±»é€‰æ‹©å™¨
          Column({ space: 5 }) {
            Text('çˆ¶åˆ†ç±»')
              .fontSize(14)
              .fontColor('#666')
              .alignSelf(ItemAlign.Start)
            
            Select(this.buildParentOptions())
              .selected(this.getSelectedParentIndex())
              .value(this.getParentDisplayName())
              .font({ size: 16 })
              .fontColor('#333')
              .selectedOptionFont({ size: 16 })
              .optionFont({ size: 16 })
              .onSelect((index: number) => {
                if (this.editingCategory) {
                  if (index === 0) {
                    // é€‰æ‹©"æ— ï¼ˆé¡¶çº§åˆ†ç±»ï¼‰"
                    this.editingCategory.parentCategoryId = 0
                  } else {
                    // é€‰æ‹©æŸä¸ªçˆ¶åˆ†ç±»
                    const parent = this.availableParents[index - 1]
                    this.editingCategory.parentCategoryId = parent.categoryId
                  }
                }
              })
          }
          .width('100%')

          // æ“ä½œæŒ‰é’®
          Row({ space: 10 }) {
            Button('å–æ¶ˆ')
              .onClick(() => {
                this.controller.close()
              })
              .layoutWeight(1)

            Button('ä¿å­˜')
              .onClick(() => {
                this.onSave()
              })
              .layoutWeight(1)
              .type(ButtonType.Capsule)
          }
          .width('100%')
          .margin({ top: 10 })
        }
        .padding(20)
        .width('90%')
      }
      .backgroundColor(Color.White)
      .borderRadius(15)
    } else {
      Column()
    }
  }

  // æ„å»ºçˆ¶åˆ†ç±»ä¸‹æ‹‰é€‰é¡¹
  buildParentOptions(): SelectOption[] {
    const options: SelectOption[] = [{ value: 'æ— ï¼ˆé¡¶çº§åˆ†ç±»ï¼‰' }]
    this.availableParents.forEach((cat: Category) => {
      options.push({ value: `${cat.icon} ${cat.name}` })
    })
    return options
  }

  // è·å–å½“å‰é€‰ä¸­çš„çˆ¶åˆ†ç±»ç´¢å¼•
  getSelectedParentIndex(): number {
    if (!this.editingCategory || this.editingCategory.parentCategoryId === 0) {
      return 0
    }
    const idx = this.availableParents.findIndex((cat: Category) => 
      cat.categoryId === this.editingCategory!.parentCategoryId
    )
    return idx >= 0 ? idx + 1 : 0
  }

  // è·å–çˆ¶åˆ†ç±»æ˜¾ç¤ºåç§°
  getParentDisplayName(): string {
    if (!this.editingCategory || this.editingCategory.parentCategoryId === 0) {
      return 'æ— ï¼ˆé¡¶çº§åˆ†ç±»ï¼‰'
    }
    const parent = this.availableParents.find((cat: Category) => 
      cat.categoryId === this.editingCategory!.parentCategoryId
    )
    return parent ? `${parent.icon} ${parent.name}` : 'æ— ï¼ˆé¡¶çº§åˆ†ç±»ï¼‰'
  }
}


// åˆ†ç±»ç®¡ç†ä¸»é¡µé¢
@Entry
@Component
struct CategoryManagement {
  @State flatItems: FlatTreeItem[] = []           // æ‰å¹³åŒ–çš„æ ‘å½¢åˆ—è¡¨
  @State allCategories: Category[] = []           // æ‰€æœ‰åˆ†ç±»ï¼ˆç”¨äºçˆ¶åˆ†ç±»é€‰æ‹©ï¼‰
  @State expandedIds: Set<number> = new Set()     // å±•å¼€çš„åˆ†ç±» ID
  @State currentEditingCategory: Category | null = null
  @State currentType: 'expense' | 'income' = 'expense'  // å½“å‰æ˜¾ç¤ºçš„åˆ†ç±»ç±»å‹
  @StorageProp('currentBreakpoint') currentBreakpoint: string = 'md';
  
  // å“åº”å¼é…ç½®
  private listPadding = new BreakPointType({ xs: 8, sm: 10, md: 12, lg: 16, xl: 20, xxl: 24 });
  private itemFontSize = new BreakPointType({ xs: 14, sm: 15, md: 16, lg: 18, xl: 20, xxl: 22 });
  private buttonWidth = new BreakPointType({ xs: '95%', sm: '92%', md: '90%', lg: '80%', xl: '70%', xxl: '60%' });

  // è·å–å¯ç”¨çš„çˆ¶åˆ†ç±»åˆ—è¡¨ï¼ˆæ’é™¤è‡ªå·±åŠå…¶å­åˆ†ç±»ï¼‰
  getAvailableParents(): Category[] {
    if (!this.currentEditingCategory) return this.allCategories
    
    const editingId = this.currentEditingCategory.categoryId
    if (editingId === 0) {
      // æ–°å»ºæ—¶ï¼Œåªèƒ½é€‰æ‹©åŒç±»å‹çš„é¡¶çº§åˆ†ç±»
      return this.allCategories.filter((cat: Category) => 
        cat.type === this.currentEditingCategory!.type && cat.parentCategoryId === 0
      )
    }
    
    // ç¼–è¾‘æ—¶ï¼Œæ’é™¤è‡ªå·±å’Œè‡ªå·±çš„å­åˆ†ç±»
    const excludeIds = new Set<number>([editingId])
    this.collectChildIds(editingId, excludeIds)
    
    return this.allCategories.filter((cat: Category) => 
      cat.type === this.currentEditingCategory!.type && 
      !excludeIds.has(cat.categoryId) &&
      cat.parentCategoryId === 0  // åªèƒ½é€‰æ‹©é¡¶çº§åˆ†ç±»ä½œä¸ºçˆ¶åˆ†ç±»
    )
  }

  // é€’å½’æ”¶é›†å­åˆ†ç±» ID
  collectChildIds(parentId: number, ids: Set<number>) {
    this.allCategories.forEach((cat: Category) => {
      if (cat.parentCategoryId === parentId) {
        ids.add(cat.categoryId)
        this.collectChildIds(cat.categoryId, ids)
      }
    })
  }

  // è‡ªå®šä¹‰å¼¹çª—æ§åˆ¶å™¨
  dialogController: CustomDialogController | null = null

  onPageShow() {
    if (!UserSessionService.getCurrentUserId()) {
       promptAction.showToast({ message: 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•' });
       setTimeout(() => {
          router.replaceUrl({ url: 'pages/LoginPage' });
       }, 500);
       return;
    }
    this.loadCategories()
  }

  async loadCategories() {
    try {
      const userId = UserSessionService.getCurrentUserId();
      if (!userId) throw new Error('æœªç™»å½•');
      
      // 1. åŠ è½½æ‰€æœ‰åˆ†ç±»ï¼ˆç”¨äºçˆ¶åˆ†ç±»é€‰æ‹©ï¼‰
      this.allCategories = await CategoryDAO.getAll(userId)
      
      // 2. åŠ è½½æ ‘å½¢ç»“æ„
      const tree = await CategoryDAO.getCategoryTree(userId, this.currentType)
      
      // 3. å°†æ ‘å½¢ç»“æ„æ‰å¹³åŒ–
      this.flatItems = this.flattenTree(tree, 0)
      
      hilog.info(HILOG_DOMAIN, LOG_TAG, `æˆåŠŸåŠ è½½ ${this.flatItems.length} æ¡åˆ†ç±»`)
    } catch (err) {
      const e = err as BusinessError;
      this.showToast(`åŠ è½½åˆ†ç±»å¤±è´¥: ${e.message}`);
    }
  }

  // å°†æ ‘å½¢ç»“æ„æ‰å¹³åŒ–ä¸ºåˆ—è¡¨
  flattenTree(nodes: CategoryTreeNode[], level: number): FlatTreeItem[] {
    const result: FlatTreeItem[] = []
    
    nodes.forEach((node: CategoryTreeNode) => {
      const isExpanded = this.expandedIds.has(node.category.categoryId)
      const hasChildren = node.children.length > 0
      
      result.push({
        category: node.category,
        level: level,
        hasChildren: hasChildren,
        isExpanded: isExpanded
      })
      
      // å¦‚æœå±•å¼€äº†ï¼Œé€’å½’æ·»åŠ å­åˆ†ç±»
      if (isExpanded && hasChildren) {
        const children = this.flattenTree(node.children, level + 1)
        children.forEach((child: FlatTreeItem) => result.push(child))
      }
    })
    
    return result
  }

  // åˆ‡æ¢å±•å¼€/æŠ˜å çŠ¶æ€
  toggleExpand(categoryId: number) {
    if (this.expandedIds.has(categoryId)) {
      this.expandedIds.delete(categoryId)
    } else {
      this.expandedIds.add(categoryId)
    }
    // é‡æ–°æ‰å¹³åŒ–
    this.loadCategories()
  }

  async handleDelete(categoryId: number) {
    try {
      const userId = UserSessionService.getCurrentUserId();
      if (!userId) throw new Error('æœªç™»å½•');
      await CategoryDAO.softDelete(userId, categoryId)
      this.showToast('åˆ é™¤æˆåŠŸ')
      this.loadCategories()
    } catch (err) {
      const e = err as BusinessError;
      this.showToast(`åˆ é™¤å¤±è´¥: ${e.message}`);
    }
  }

  async handleSave() {
    if (!this.currentEditingCategory) return

    if (!this.currentEditingCategory.name) {
      this.showToast('åˆ†ç±»åç§°ä¸èƒ½ä¸ºç©º')
      return
    }

    try {
      const now = new Date().toISOString()
      this.currentEditingCategory.updatedAt = now
      const userId = UserSessionService.getCurrentUserId();
      if (!userId) throw new Error('æœªç™»å½•');

      if (this.currentEditingCategory.categoryId === 0) {
        // æ–°å»º
        this.currentEditingCategory.userId = userId
        this.currentEditingCategory.createdAt = now

        if (!this.currentEditingCategory.icon) {
           this.currentEditingCategory.icon = 'ğŸ“¦';
        }
        if (!this.currentEditingCategory.color) {
           const randomColor = '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
           this.currentEditingCategory.color = randomColor;
        }

        await CategoryDAO.insert(this.currentEditingCategory)
        this.showToast('åˆ›å»ºæˆåŠŸ')
      } else {
        // æ›´æ–°
        await CategoryDAO.update(this.currentEditingCategory)
        this.showToast('æ›´æ–°æˆåŠŸ')
      }

      if (this.dialogController) {
        this.dialogController.close();
      }
      this.currentEditingCategory = null
      this.loadCategories()

    } catch (err) {
      const e = err as BusinessError;
      this.showToast(`ä¿å­˜å¤±è´¥: ${e.message}`)
      hilog.error(HILOG_DOMAIN, LOG_TAG, 'ä¿å­˜å¤±è´¥: %{public}s', `code=${e.code}, msg=${e.message}`)
    }
  }

  showToast(message: string) {
    try {
      promptAction.showToast({ message: message });
    } catch (err) {
      const e = err as BusinessError;
      hilog.error(HILOG_DOMAIN, LOG_TAG, 'showToast å¤±è´¥: %{public}s', `code=${e.code}, msg=${e.message}`);
    }
  }

  // æ‰“å¼€æ–°å»ºåˆ†ç±»å¼¹çª—
  openCreateDialog(parentId: number = 0) {
    const newCategory = new Category()
    newCategory.type = this.currentType
    newCategory.parentCategoryId = parentId
    this.currentEditingCategory = newCategory
    
    // åˆ›å»ºå¼¹çª—
    this.dialogController = new CustomDialogController({
      builder: CategoryEditDialog({
        editingCategory: this.currentEditingCategory,
        availableParents: this.getAvailableParents(),
        onSave: (): void => {
          this.handleSave()
        }
      }),
      autoCancel: false,
      alignment: DialogAlignment.Bottom
    })
    
    if (this.dialogController) {
      this.dialogController.open()
    }
  }

  // æ‰“å¼€ç¼–è¾‘åˆ†ç±»å¼¹çª—
  openEditDialog(category: Category) {
    this.currentEditingCategory = category.clone()
    
    // åˆ›å»ºå¼¹çª—
    this.dialogController = new CustomDialogController({
      builder: CategoryEditDialog({
        editingCategory: this.currentEditingCategory,
        availableParents: this.getAvailableParents(),
        onSave: (): void => {
          this.handleSave()
        }
      }),
      autoCancel: false,
      alignment: DialogAlignment.Bottom
    })
    
    if (this.dialogController) {
      this.dialogController.open()
    }
  }

  build() {
    Navigation() {
      Column() {
        // ç±»å‹åˆ‡æ¢æ ‡ç­¾
        Tabs({ index: this.currentType === 'expense' ? 0 : 1 }) {
          TabContent() {
            this.CategoryList()
          }.tabBar('æ”¯å‡ºåˆ†ç±»')
          
          TabContent() {
            this.CategoryList()
          }.tabBar('æ”¶å…¥åˆ†ç±»')
        }
        .barMode(BarMode.Fixed)
        .onChange((index: number) => {
          this.currentType = index === 0 ? 'expense' : 'income'
          this.loadCategories()
        })
        .layoutWeight(1)

        // æ–°å»ºæŒ‰é’®
        Button('æ–°å»ºåˆ†ç±»')
          .width(this.buttonWidth.getValue(this.currentBreakpoint) as string)
          .height(50)
          .type(ButtonType.Capsule)
          .margin(15)
          .onClick(() => {
            this.openCreateDialog(0)
          })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F1F3F5')
    }
    .title('åˆ†ç±»ç®¡ç†')
    .titleMode(NavigationTitleMode.Mini)
  }

  @Builder
  CategoryList() {
    List({ space: 8 }) {
      ForEach(this.flatItems, (item: FlatTreeItem, index: number) => {
        ListItem() {
          Row() {
            // ç¼©è¿›ï¼ˆæ ¹æ®å±‚çº§ï¼‰
            if (item.level > 0) {
              Blank()
                .width(item.level * 24)
            }
            
            // å±•å¼€/æŠ˜å æŒ‰é’®
            if (item.hasChildren) {
              Text(item.isExpanded ? 'â–¼' : 'â–¶')
                .fontSize(12)
                .fontColor('#666')
                .width(20)
                .textAlign(TextAlign.Center)
                .margin({ right: 8 })
                .onClick(() => {
                  this.toggleExpand(item.category.categoryId)
                })
            } else {
              // å ä½ï¼Œä¿æŒå¯¹é½
              Blank()
                .width(28)
            }
            
            // åˆ†ç±»åç§°
            Text(item.category.name)
              .fontSize(this.itemFontSize.getValue(this.currentBreakpoint) as number)
              .layoutWeight(1)
            
            // æ·»åŠ å­åˆ†ç±»æŒ‰é’®ï¼ˆä»…é¡¶çº§åˆ†ç±»æ˜¾ç¤ºï¼‰
            if (item.level === 0) {
              Button({ type: ButtonType.Circle, stateEffect: true }) {
                Text('+')
                  .fontSize(18)
                  .fontColor('#666')
              }
              .width(28)
              .height(28)
              .backgroundColor('#E8E8E8')
              .margin({ right: 8 })
              .onClick(() => {
                this.openCreateDialog(item.category.categoryId)
              })
            }
          }
          .padding({ left: 12, right: 12, top: 12, bottom: 12 })
          .backgroundColor(Color.White)
          .borderRadius(8)
          .onClick(() => {
            this.openEditDialog(item.category)
          })
        }
        .swipeAction({ end: this.SwipeDeleteButton(item.category.categoryId) })
      })
    }
    .width('100%')
    .layoutWeight(1)
    .padding({ 
      left: this.listPadding.getValue(this.currentBreakpoint) as number, 
      right: this.listPadding.getValue(this.currentBreakpoint) as number,
      top: 10
    })
  }

  @Builder
  SwipeDeleteButton(categoryId: number) {
    Button('åˆ é™¤')
      .type(ButtonType.Circle)
      .backgroundColor(Color.Red)
      .onClick(() => {
        this.handleDelete(categoryId)
      })
  }
}