import router from '@ohos.router';
import { Category } from '../model/Category' //
import { CategoryDAO } from '../dao/CategoryDAO' //
import promptAction from '@ohos.promptAction'
import hilog from '@ohos.hilog'
import type { BusinessError } from '@ohos.base'
import { BreakPointType } from '../common/BreakpointSystem';
import { UserSessionService } from '../service/UserSessionService';


// HILOG å®šä¹‰
const LOG_TAG = 'CategoryManagement'
const HILOG_DOMAIN = 0x0001 // âœ… ä¿®å¤ï¼šhilog éœ€è¦ä¸€ä¸ªæ•°å­— domain

// ---------------------------------
// (C/U) æ–°å»º/ç¼–è¾‘åˆ†ç±»çš„å¼¹çª—
// ---------------------------------
@CustomDialog
struct CategoryEditDialog {
  controller: CustomDialogController
  // âœ… ä¿®å¤ 1 (é—ªé€€): å…è®¸ editingCategory ä¸º nullï¼Œä»¥åŒ¹é…çˆ¶ç»„ä»¶çš„ç±»å‹
  @Link editingCategory: Category | null
  // onSave é»˜è®¤å€¼
  onSave: () => void = () => {}

  build() {
    // å¿…é¡»æ£€æŸ¥ editingCategory æ˜¯å¦ä¸º nullã€‚
    // å½“çˆ¶ç»„ä»¶åœ¨å…³é—­å¼¹çª—æ—¶å°†å…¶è®¾ä¸º nullï¼Œè¿™ä¸ª if ä¼šä¿æŠ¤å¼¹çª—ä¸å´©æºƒã€‚
    if (this.editingCategory) {
      Scroll() {
        Column({ space: 15 }) {
          TextInput({
            placeholder: 'åˆ†ç±»åç§°',
            text: this.editingCategory.name
          })
            .onChange((value: string) => { // âœ… ä¿®å¤ï¼šæ·»åŠ  (value: string)
              if (this.editingCategory) { // å†æ¬¡æ£€æŸ¥ï¼Œç¡®ä¿å®‰å…¨
                this.editingCategory.name = value
              }
            })

          TextInput({
            placeholder: 'å›¾æ ‡ ğŸ½ï¸',
            text: this.editingCategory.icon
          })
            .onChange((value: string) => { // âœ… ä¿®å¤ï¼šæ·»åŠ  (value: string)
              if (this.editingCategory) {
                this.editingCategory.icon = value
              }
            })

          TextInput({
            placeholder: 'é¢œè‰² (ä¾‹å¦‚: #FF6B6B)',
            text: this.editingCategory.color
          })
            .onChange((value: string) => { // âœ… ä¿®å¤ï¼šæ·»åŠ  (value: string)
              if (this.editingCategory) {
                this.editingCategory.color = value
              }
            })

          // âœ… ä¿®å¤ï¼šbarMode æ˜¯é“¾å¼è°ƒç”¨
          Tabs({
            index: this.editingCategory.type === 'expense' ? 0 : 1
          }) {
            TabContent().tabBar('æ”¯å‡º')
            TabContent().tabBar('æ”¶å…¥')
          }
          .barMode(BarMode.Fixed)
          .onChange((index: number) => { // âœ… ä¿®å¤ï¼šæ·»åŠ  (index: number)
            if (this.editingCategory) {
              this.editingCategory.type = (index === 0) ? 'expense' : 'income'
            }
          })

          // æ“ä½œæŒ‰é’®
          Row({ space: 10 }) {
            Button('å–æ¶ˆ')
              .onClick(() => {
                this.controller.close()
              })
              .layoutWeight(1)

            Button('ä¿å­˜')
              .onClick(() => {
                this.onSave()
              })
              .layoutWeight(1)
              .type(ButtonType.Capsule)
          }
          .width('100%')
          .margin({ top: 10 })
        }
        .padding(20)
        .width('90%')
      } // Scroll ç»“æŸ
      .backgroundColor(Color.White)
      .borderRadius(15)
    } else {
      // å½“ editingCategory ä¸º null æ—¶ (ä¾‹å¦‚çˆ¶ç»„ä»¶æ­£åœ¨å…³é—­å®ƒ)
      // æ¸²æŸ“ä¸€ä¸ªç©ºçš„ Column æ¥é¿å…å´©æºƒ
      Column()
    }
  }
}


//  åˆ†ç±»ç®¡ç†ä¸»é¡µé¢
@Entry
@Component
struct CategoryManagement {
  @State categories: Array<Category> = []
  @State currentEditingCategory: Category | null = null
  @StorageProp('currentBreakpoint') currentBreakpoint: string = 'md';
  
  // å“åº”å¼é…ç½®
  private listPadding = new BreakPointType({ xs: 8, sm: 10, md: 12, lg: 16, xl: 20, xxl: 24 });
  private itemFontSize = new BreakPointType({ xs: 14, sm: 15, md: 16, lg: 18, xl: 20, xxl: 22 });
  private buttonWidth = new BreakPointType({ xs: '95%', sm: '92%', md: '90%', lg: '80%', xl: '70%', xxl: '60%' });

  // è‡ªå®šä¹‰å¼¹çª—æ§åˆ¶å™¨
  dialogController: CustomDialogController = new CustomDialogController({
    builder: CategoryEditDialog({
      editingCategory: $currentEditingCategory,
      onSave: () => {
        this.handleSave()
      }
    }),
    autoCancel: false,
    alignment: DialogAlignment.Bottom
  })

  // (R) é¡µé¢æ˜¾ç¤ºæ—¶åŠ è½½æ•°æ®
  onPageShow() {
    if (!UserSessionService.getCurrentUserId()) {
       promptAction.showToast({ message: 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•' });
       setTimeout(() => {
          router.replaceUrl({ url: 'pages/LoginPage' });
       }, 500);
       return;
    }
    this.loadCategories()
  }

  async loadCategories() {
    try {
      const userId = UserSessionService.getCurrentUserId();
      if (!userId) throw new Error('æœªç™»å½•');
      const data = await CategoryDAO.getAll(userId) //
      this.categories = data
      hilog.info(HILOG_DOMAIN, LOG_TAG, `æˆåŠŸåŠ è½½ ${data.length} æ¡åˆ†ç±»`)
    } catch (err) {
      const e = err as BusinessError;
      this.showToast(`åŠ è½½åˆ†ç±»å¤±è´¥: ${e.message}`);
    }
  }

  // (D) åˆ é™¤é€»è¾‘
  async handleDelete(categoryId: number) {
    try {
      const userId = UserSessionService.getCurrentUserId();
      if (!userId) throw new Error('æœªç™»å½•');
      await CategoryDAO.softDelete(userId, categoryId) //
      this.showToast('åˆ é™¤æˆåŠŸ')
      this.loadCategories()
    } catch (err) {
      const e = err as BusinessError;
      this.showToast(`åˆ é™¤å¤±è´¥: ${e.message}`);
    }
  }

  // (C / U) ä¿å­˜é€»è¾‘
  async handleSave() {
    if (!this.currentEditingCategory) return

    // ç®€å•æ ¡éªŒ
    if (!this.currentEditingCategory.name) {
      this.showToast('åˆ†ç±»åç§°ä¸èƒ½ä¸ºç©º')
      return // éªŒè¯å¤±è´¥ï¼Œä¸å…³é—­å¼¹çª—
    }

    try {
      const now = new Date().toISOString()
      this.currentEditingCategory.updatedAt = now
      const userId = UserSessionService.getCurrentUserId();
      if (!userId) throw new Error('æœªç™»å½•');

      if (this.currentEditingCategory.categoryId === 0) {
        // --- (C) Create æ–°å»º ---
        this.currentEditingCategory.userId = userId
        this.currentEditingCategory.createdAt = now

        // é»˜è®¤å€¼å¤„ç†
        if (!this.currentEditingCategory.icon) {
           this.currentEditingCategory.icon = ''; // ä¸éœ€è¦å›¾æ ‡
        }
        if (!this.currentEditingCategory.color) {
           // ç”Ÿæˆéšæœºé¢œè‰²
           const randomColor = '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
           this.currentEditingCategory.color = randomColor;
        }

        await CategoryDAO.insert(this.currentEditingCategory) //
        this.showToast('åˆ›å»ºæˆåŠŸ')
      } else {
        // --- (U) Update æ›´æ–° ---
        await CategoryDAO.update(this.currentEditingCategory) //
        this.showToast('æ›´æ–°æˆåŠŸ')
      }

      // å…³é”®ï¼šåœ¨æ‰€æœ‰ await æ“ä½œæˆåŠŸåï¼Œæ‰åœ¨è¿™é‡Œå…³é—­å¼¹çª—ï¼
      this.dialogController.close();

      // åœ¨å…³é—­åæ‰æ¸…ç©ºçŠ¶æ€
      this.currentEditingCategory = null
      this.loadCategories()

    } catch (err) { //
      const e = err as BusinessError;
      this.showToast(`ä¿å­˜å¤±è´¥: ${e.message}`)
      hilog.error(HILOG_DOMAIN, LOG_TAG, 'ä¿å­˜å¤±è´¥: %{public}s', `code=${e.code}, msg=${e.message}`)
      // å¤±è´¥æ—¶ä¸å…³é—­å¼¹çª—
    }
  }

  // âœ… ä¿®å¤ï¼šå°è£…ä¸€ä¸ªå®‰å…¨çš„ showToast å‡½æ•°
  showToast(message: string) {
    try {
      promptAction.showToast({ message: message });
    } catch (err) {
      const e = err as BusinessError;
      hilog.error(HILOG_DOMAIN, LOG_TAG, 'showToast å¤±è´¥: %{public}s', `code=${e.code}, msg=${e.message}`);
    }
  }

  build() {
    Navigation() {
      Column() {
        // (R) åˆ—è¡¨å±•ç¤º
        List({ space: 10 }) {
          ForEach(this.categories, (item: Category) => {
            // âœ… ä¿®å¤ï¼šä½¿ç”¨ .swipeAction å±æ€§ï¼Œè€Œä¸æ˜¯ SwipeAction() ç»„ä»¶
            ListItem() {
              // (U) åˆ—è¡¨é¡¹
              Row() {
                Image($r(item.icon))
                  .width(30)
                  .height(30)
                  .margin({ right: 10 })
                  .objectFit(ImageFit.Contain)
                Text(item.name)
                  .fontSize(this.itemFontSize.getValue(this.currentBreakpoint) as number)
                  .layoutWeight(1)
                Text(item.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥')
                  .fontSize((this.itemFontSize.getValue(this.currentBreakpoint) as number) - 2)
                  .fontColor(item.type === 'expense' ? Color.Red : Color.Green)
              }
              .padding(15)
              .backgroundColor(Color.White)
              .borderRadius(8)
              .onClick(() => {
                // (U) ç‚¹å‡»æ—¶ï¼Œå¼¹å‡ºç¼–è¾‘çª—å£
                this.currentEditingCategory = item.clone() // å…³é”®ï¼šä½¿ç”¨ clone() é¿å…ç›´æ¥ä¿®æ”¹åˆ—è¡¨
                this.dialogController.open()
              })
            } // ListItem ç»“æŸ
            .swipeAction({ end: this.SwipeDeleteButton(item.categoryId) })
          })
        }
        .layoutWeight(1)
        .width('100%') // âœ… ä¿®å¤ï¼šæ·»åŠ  width æ¶ˆé™¤ List è­¦å‘Š
        .padding({ 
          left: this.listPadding.getValue(this.currentBreakpoint) as number, 
          right: this.listPadding.getValue(this.currentBreakpoint) as number 
        })

        // (C) æ–°å»ºæŒ‰é’®
        Button('æ–°å»ºåˆ†ç±»')
          .width(this.buttonWidth.getValue(this.currentBreakpoint) as string)
          .height(50)
          .type(ButtonType.Capsule)
          .margin(15)
          .onClick(() => {
            // (C) ç‚¹å‡»æ—¶ï¼Œå¼¹å‡ºæ–°å»ºçª—å£
            this.currentEditingCategory = new Category() // å…³é”®ï¼šä¼ å…¥ä¸€ä¸ªç©ºå¯¹è±¡
            this.dialogController.open()
          })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F1F3F5')
    }
    .title('åˆ†ç±»ç®¡ç†')
    .titleMode(NavigationTitleMode.Mini)
  }

  // (D) æ»‘åŠ¨åˆ é™¤çš„æŒ‰é’®
  @Builder
  SwipeDeleteButton(categoryId: number) {
    Button('åˆ é™¤')
      .type(ButtonType.Circle)
      .backgroundColor(Color.Red)
      .onClick(() => {
        this.handleDelete(categoryId)
      })
  }
}