/**
 * æ€§èƒ½ç›‘æŽ§é¡µé¢ - å±•ç¤ºåº”ç”¨æ€§èƒ½æ•°æ®
 *
 * åŠŸèƒ½ï¼š
 * - æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡ï¼ˆæ€»æŸ¥è¯¢æ•°ã€å¹³å‡è€—æ—¶ã€æ…¢æŸ¥è¯¢æ¯”ä¾‹ï¼‰
 * - ç¼“å­˜ç»Ÿè®¡ï¼ˆæœ‰æ•ˆç¼“å­˜æ•°ã€è¿‡æœŸç¼“å­˜æ•°ï¼‰
 * - æ–¹æ³•çº§æ€§èƒ½è¯¦æƒ…åˆ—è¡¨
 * - æ”¯æŒåˆ·æ–°ã€æ¸…é™¤ç»Ÿè®¡ã€æ¸…ç†ç¼“å­˜æ“ä½œ
 */
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { PerformanceMonitor } from '../database/PerformanceMonitor';
import { CacheManager, CacheStats } from '../database/CacheManager';

/**
 * æ–¹æ³•æ€§èƒ½ç»Ÿè®¡é¡¹
 */
interface MethodStats {
  methodName: string;
  count: number;
  avgTime: number;
  maxTime: number;
  minTime: number;
  slowQueryCount: number;
  slowQueryRate: string;
}


@Entry
@Component
struct PerformanceMonitorPage {
  // æ€§èƒ½ç»Ÿè®¡æ•°æ®
  @State methodStatsList: MethodStats[] = [];
  @State totalQueries: number = 0;
  @State totalAvgTime: number = 0;
  @State totalSlowQueries: number = 0;

  // ç¼“å­˜ç»Ÿè®¡æ•°æ®
  @State cacheStats: CacheStats = {
    totalCount: 0,
    validCount: 0,
    expiredCount: 0,
    keys: []
  };

  // åŠ è½½çŠ¶æ€
  @State isLoading: boolean = false;

  aboutToAppear() {
    this.refreshData();
  }

  /**
   * åˆ·æ–°æ‰€æœ‰ç»Ÿè®¡æ•°æ®
   */
  refreshData(): void {
    this.isLoading = true;

    // èŽ·å–æ€§èƒ½ç»Ÿè®¡
    const statsMap = PerformanceMonitor.getStats();
    const methodList: MethodStats[] = [];
    let totalCount = 0;
    let totalTime = 0;
    let slowCount = 0;

    statsMap.forEach((stats, methodName) => {
      const slowRate = stats.count > 0
        ? (stats.slowQueryCount / stats.count * 100).toFixed(1)
        : '0.0';

      methodList.push({
        methodName: methodName,
        count: stats.count,
        avgTime: Number(stats.avgTime.toFixed(2)),
        maxTime: Number(stats.maxTime.toFixed(2)),
        minTime: stats.minTime === Infinity ? 0 : Number(stats.minTime.toFixed(2)),
        slowQueryCount: stats.slowQueryCount,
        slowQueryRate: slowRate
      });

      totalCount += stats.count;
      totalTime += stats.totalTime;
      slowCount += stats.slowQueryCount;
    });

    this.methodStatsList = methodList;
    this.totalQueries = totalCount;
    this.totalAvgTime = totalCount > 0 ? Number((totalTime / totalCount).toFixed(2)) : 0;
    this.totalSlowQueries = slowCount;

    // èŽ·å–ç¼“å­˜ç»Ÿè®¡
    this.cacheStats = CacheManager.getStats();

    this.isLoading = false;
    console.log('[PerformanceMonitorPage] æ•°æ®å·²åˆ·æ–°');
  }

  /**
   * æ¸…é™¤æ€§èƒ½ç»Ÿè®¡
   */
  clearStats(): void {
    PerformanceMonitor.clearStats();
    this.refreshData();
    promptAction.showToast({ message: 'æ€§èƒ½ç»Ÿè®¡å·²æ¸…é™¤' });
  }

  /**
   * æ¸…ç†è¿‡æœŸç¼“å­˜
   */
  cleanExpiredCache(): void {
    const count = CacheManager.cleanExpired();
    this.refreshData();
    promptAction.showToast({ message: `å·²æ¸…ç† ${count} æ¡è¿‡æœŸç¼“å­˜` });
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('â†')
          .fontSize(24)
          .fontColor('#007AFF')
          .margin({ right: 16 })
          .onClick(() => {
            router.back();
          })

        Text('æ€§èƒ½ç›‘æŽ§')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)

        Text('åˆ·æ–°')
          .fontSize(14)
          .fontColor('#007AFF')
          .onClick(() => {
            this.refreshData();
            promptAction.showToast({ message: 'æ•°æ®å·²åˆ·æ–°' });
          })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(Color.White)

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // æ€§èƒ½æ¦‚è§ˆå¡ç‰‡
          this.OverviewCard()

          // ç¼“å­˜ç»Ÿè®¡å¡ç‰‡
          this.CacheCard()

          // æ–¹æ³•æ€§èƒ½åˆ—è¡¨
          this.MethodStatsList()

          // æ“ä½œæŒ‰é’®åŒºåŸŸ
          this.ActionButtons()
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 24 })
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F1F3F5')
  }

  /**
   * æ€§èƒ½æ¦‚è§ˆå¡ç‰‡
   */
  @Builder
  OverviewCard() {
    Column() {
      Text('ðŸ“Š æ€§èƒ½æ¦‚è§ˆ')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 16 })
        .alignSelf(ItemAlign.Start)

      Row() {
        this.StatItem('æ€»æŸ¥è¯¢æ•°', `${this.totalQueries}`, '#007AFF')
        this.StatItem('å¹³å‡è€—æ—¶', `${this.totalAvgTime}ms`, '#34C759')
        this.StatItem('æ…¢æŸ¥è¯¢', `${this.totalSlowQueries}`, this.totalSlowQueries > 0 ? '#FF9500' : '#34C759')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12 })
  }

  /**
   * ç¼“å­˜ç»Ÿè®¡å¡ç‰‡
   */
  @Builder
  CacheCard() {
    Column() {
      Text('ðŸ’¾ ç¼“å­˜ç»Ÿè®¡')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 16 })
        .alignSelf(ItemAlign.Start)

      Row() {
        this.StatItem('æœ‰æ•ˆç¼“å­˜', `${this.cacheStats.validCount}`, '#007AFF')
        this.StatItem('è¿‡æœŸç¼“å­˜', `${this.cacheStats.expiredCount}`, this.cacheStats.expiredCount > 0 ? '#FF9500' : '#8E8E93')
        this.StatItem('æ€»è®¡', `${this.cacheStats.totalCount}`, '#8E8E93')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12 })
  }

  /**
   * ç»Ÿè®¡é¡¹ç»„ä»¶
   */
  @Builder
  StatItem(label: string, value: string, color: string) {
    Column() {
      Text(value)
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(label)
        .fontSize(12)
        .fontColor('#8E8E93')
        .margin({ top: 4 })
    }
    .alignItems(HorizontalAlign.Center)
  }

  /**
   * æ–¹æ³•æ€§èƒ½åˆ—è¡¨
   */
  @Builder
  MethodStatsList() {
    Column() {
      Text('ðŸ“‹ æ–¹æ³•æ€§èƒ½è¯¦æƒ…')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)

      if (this.methodStatsList.length === 0) {
        Column() {
          Text('æš‚æ— æ€§èƒ½æ•°æ®')
            .fontSize(14)
            .fontColor('#8E8E93')
        }
        .width('100%')
        .padding(32)
        .justifyContent(FlexAlign.Center)
      } else {
        ForEach(this.methodStatsList, (item: MethodStats) => {
          this.MethodStatsRow(item)
        })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12 })
  }

  /**
   * æ–¹æ³•ç»Ÿè®¡è¡Œ
   */
  @Builder
  MethodStatsRow(item: MethodStats) {
    Column() {
      // æ–¹æ³•å
      Text(item.methodName)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .width('100%')

      // ç»Ÿè®¡æ•°æ®
      Row() {
        Text(`è°ƒç”¨: ${item.count}`)
          .fontSize(12)
          .fontColor('#8E8E93')

        Text(`å¹³å‡: ${item.avgTime}ms`)
          .fontSize(12)
          .fontColor('#34C759')
          .margin({ left: 12 })

        Text(`æœ€å¤§: ${item.maxTime}ms`)
          .fontSize(12)
          .fontColor(item.maxTime > 100 ? '#FF9500' : '#8E8E93')
          .margin({ left: 12 })

        if (item.slowQueryCount > 0) {
          Text(`æ…¢æŸ¥è¯¢: ${item.slowQueryRate}%`)
            .fontSize(12)
            .fontColor('#FF3B30')
            .margin({ left: 12 })
        }
      }
      .width('100%')
      .margin({ top: 8 })
    }
    .width('100%')
    .padding({ top: 12, bottom: 12 })
    .border({ width: { bottom: 1 }, color: '#F0F0F0' })
  }

  /**
   * æ“ä½œæŒ‰é’®åŒºåŸŸ
   */
  @Builder
  ActionButtons() {
    Row() {
      Button('æ¸…é™¤ç»Ÿè®¡')
        .fontSize(14)
        .fontColor('#FF3B30')
        .backgroundColor('#FFF0F0')
        .borderRadius(8)
        .height(40)
        .layoutWeight(1)
        .onClick(() => {
          this.clearStats();
        })

      Button('æ¸…ç†è¿‡æœŸç¼“å­˜')
        .fontSize(14)
        .fontColor('#007AFF')
        .backgroundColor('#F0F8FF')
        .borderRadius(8)
        .height(40)
        .layoutWeight(1)
        .margin({ left: 12 })
        .onClick(() => {
          this.cleanExpiredCache();
        })
    }
    .width('100%')
    .padding({ top: 8 })
  }
}
