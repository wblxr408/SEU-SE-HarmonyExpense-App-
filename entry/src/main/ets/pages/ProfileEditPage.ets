/**
 * ä¸ªäººä¿¡æ¯ç¼–è¾‘é¡µé¢
 * æ”¯æŒå¤´åƒæ›´æ¢ã€æ˜µç§°ç¼–è¾‘ã€é‚®ç®±ä¿®æ”¹ã€å¯†ç ä¿®æ”¹
 */
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import picker from '@ohos.file.picker';
import { UserSessionService, SessionInfo } from '../service/UserSessionService';

@Entry
@Component
struct ProfileEditPage {
  @State currentUser: SessionInfo | null = null;
  @State nickname: string = '';
  @State email: string = '';
  @State avatarPath: string = '';
  @State isLoading: boolean = false;

  // å¯†ç ä¿®æ”¹
  @State showPasswordDialog: boolean = false;
  @State oldPassword: string = '';
  @State newPassword: string = '';
  @State confirmPassword: string = '';

  aboutToAppear() {
    this.currentUser = UserSessionService.getCurrentSession();
    if (this.currentUser) {
      this.nickname = this.currentUser.username;
      this.email = this.currentUser.email;
    }
  }

  build() {
    Navigation() {
      Scroll() {
        Column() {
          // å¤´åƒåŒºåŸŸ
          Column() {
            Stack() {
              if (this.avatarPath) {
                Image(this.avatarPath)
                  .width(100)
                  .height(100)
                  .borderRadius(50)
                  .objectFit(ImageFit.Cover)
              } else {
                Image($r('app.media.icon'))
                  .width(100)
                  .height(100)
                  .borderRadius(50)
                  .backgroundColor('#E0E0E0')
              }
              // ç¼–è¾‘æŒ‰é’®
              Row() {
                Text('ğŸ“·')
                  .fontSize(16)
              }
              .width(32)
              .height(32)
              .backgroundColor('#2E65F3')
              .borderRadius(16)
              .justifyContent(FlexAlign.Center)
              .position({ x: 70, y: 70 })
            }
            .width(100)
            .height(100)
            .onClick(() => this.selectAvatar())

            Text('ç‚¹å‡»æ›´æ¢å¤´åƒ')
              .fontSize(12)
              .fontColor('#8395A7')
              .margin({ top: 8 })
          }
          .margin({ top: 24, bottom: 24 })

          // è¡¨å•åŒºåŸŸ
          Column() {
            // æ˜µç§°
            this.FormItem('æ˜µç§°', this.nickname, (value: string) => {
              this.nickname = value;
            })

            Divider().color('#F0F0F0')

            // é‚®ç®±
            this.FormItem('é‚®ç®±', this.email, (value: string) => {
              this.email = value;
            })

            Divider().color('#F0F0F0')

            // ä¿®æ”¹å¯†ç 
            Row() {
              Text('ä¿®æ”¹å¯†ç ')
                .fontSize(16)
                .fontColor('#2D3436')
                .layoutWeight(1)
              Text('>')
                .fontSize(18)
                .fontColor('#8395A7')
            }
            .width('100%')
            .height(56)
            .padding({ left: 16, right: 16 })
            .onClick(() => {
              this.showPasswordDialog = true;
            })
          }
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({ left: 16, right: 16 })

          // ä¿å­˜æŒ‰é’®
          Button('ä¿å­˜ä¿®æ”¹')
            .width('90%')
            .height(50)
            .margin({ top: 40 })
            .backgroundColor('#2E65F3')
            .onClick(() => this.saveProfile())
        }
        .width('100%')
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F7F9')

      // å¯†ç ä¿®æ”¹å¼¹çª—
      if (this.showPasswordDialog) {
        this.PasswordDialog()
      }
    }
    .title('ç¼–è¾‘èµ„æ–™')
    .titleMode(NavigationTitleMode.Mini)
  }

  @Builder
  FormItem(label: string, value: string, onChange: (value: string) => void) {
    Row() {
      Text(label)
        .fontSize(16)
        .fontColor('#2D3436')
        .width(80)
      TextInput({ text: value, placeholder: `è¯·è¾“å…¥${label}` })
        .layoutWeight(1)
        .backgroundColor(Color.Transparent)
        .onChange(onChange)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
  }

  @Builder
  PasswordDialog() {
    Column() {
      // é®ç½©å±‚
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .position({ x: 0, y: 0 })
        .onClick(() => {
          this.showPasswordDialog = false;
        })

      // å¼¹çª—å†…å®¹
      Column() {
        Text('ä¿®æ”¹å¯†ç ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 24 })

        TextInput({ placeholder: 'è¯·è¾“å…¥æ—§å¯†ç ' })
          .type(InputType.Password)
          .width('100%')
          .height(44)
          .margin({ bottom: 12 })
          .onChange((value: string) => {
            this.oldPassword = value;
          })

        TextInput({ placeholder: 'è¯·è¾“å…¥æ–°å¯†ç ' })
          .type(InputType.Password)
          .width('100%')
          .height(44)
          .margin({ bottom: 12 })
          .onChange((value: string) => {
            this.newPassword = value;
          })

        TextInput({ placeholder: 'å†æ¬¡ç¡®è®¤æ–°å¯†ç ' })
          .type(InputType.Password)
          .width('100%')
          .height(44)
          .margin({ bottom: 24 })
          .onChange((value: string) => {
            this.confirmPassword = value;
          })

        Row() {
          Button('å–æ¶ˆ')
            .width('45%')
            .height(44)
            .backgroundColor('#F5F7F9')
            .fontColor('#2D3436')
            .onClick(() => {
              this.showPasswordDialog = false;
              this.oldPassword = '';
              this.newPassword = '';
              this.confirmPassword = '';
            })
          Button('ç¡®è®¤')
            .width('45%')
            .height(44)
            .backgroundColor('#2E65F3')
            .onClick(() => this.changePassword())
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .padding(24)
      .backgroundColor(Color.White)
      .borderRadius(16)
      .width('85%')
      .position({ x: '7.5%', y: '30%' })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
  }

  async selectAvatar() {
    try {
      const photoPicker = new picker.PhotoViewPicker();
      const result = await photoPicker.select({
        MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE,
        maxSelectNumber: 1
      });
      if (result.photoUris && result.photoUris.length > 0) {
        this.avatarPath = result.photoUris[0];
        promptAction.showToast({ message: 'å¤´åƒå·²é€‰æ‹©' });
      }
    } catch (error) {
      console.error('[ProfileEditPage] é€‰æ‹©å¤´åƒå¤±è´¥:', error);
      promptAction.showToast({ message: 'é€‰æ‹©å›¾ç‰‡å¤±è´¥' });
    }
  }

  async saveProfile() {
    if (!this.nickname.trim()) {
      promptAction.showToast({ message: 'æ˜µç§°ä¸èƒ½ä¸ºç©º' });
      return;
    }

    this.isLoading = true;
    try {
      // æ›´æ–°èµ„æ–™
      const profileResult = await UserSessionService.updateProfile(this.nickname, this.avatarPath);
      if (!profileResult) {
        promptAction.showToast({ message: 'ä¿å­˜å¤±è´¥' });
        return;
      }

      // å¦‚æœé‚®ç®±æœ‰å˜åŒ–ï¼Œæ›´æ–°é‚®ç®±
      if (this.email !== this.currentUser?.email) {
        const emailResult = await UserSessionService.updateEmail(this.email);
        if (!emailResult.success) {
          promptAction.showToast({ message: emailResult.message });
          return;
        }
      }

      promptAction.showToast({ message: 'ä¿å­˜æˆåŠŸ' });
      router.back();
    } catch (error) {
      console.error('[ProfileEditPage] ä¿å­˜å¤±è´¥:', error);
      promptAction.showToast({ message: 'ä¿å­˜å¤±è´¥' });
    } finally {
      this.isLoading = false;
    }
  }

  async changePassword() {
    if (!this.oldPassword || !this.newPassword || !this.confirmPassword) {
      promptAction.showToast({ message: 'è¯·å¡«å†™å®Œæ•´å¯†ç ä¿¡æ¯' });
      return;
    }
    if (this.newPassword !== this.confirmPassword) {
      promptAction.showToast({ message: 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´' });
      return;
    }
    if (this.newPassword.length < 6) {
      promptAction.showToast({ message: 'æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½' });
      return;
    }

    const result = await UserSessionService.changePassword(this.oldPassword, this.newPassword);
    promptAction.showToast({ message: result.message });
    if (result.success) {
      this.showPasswordDialog = false;
      this.oldPassword = '';
      this.newPassword = '';
      this.confirmPassword = '';
    }
  }
}
