 /**
 * OCRæ‰«æé¡µé¢ - æ‹ç…§è¯†åˆ«å°ç¥¨
 *
 * åŠŸèƒ½ï¼š
 * 1. é€‰æ‹©å›¾ç‰‡/æ‹ç…§
 * 2. OCRè¯†åˆ«å¤„ç†
 * 3. é¢„è§ˆè¯†åˆ«ç»“æœ
 * 4. ç¡®è®¤åè·³è½¬åˆ°è®°è´¦é¡µé¢
 */

import router from '@ohos.router';
import { promptAction } from '@kit.ArkUI';
import { picker } from '@kit.CoreFileKit';
import { OCRRecognitionService, OCRRecognitionResult } from '../service/OCRRecognitionService';
import { UserSessionService } from '../service/UserSessionService';

@Entry
@Component
struct OCRScanPage {
  @State isProcessing: boolean = false;
  @State hasResult: boolean = false;
  @State selectedImagePath: string = '';

  // OCRè¯†åˆ«ç»“æœ
  @State merchantName: string = '';
  @State totalAmount: number = 0;
  @State transactionDate: string = '';
  @State suggestedCategoryId: number = 0;
  @State suggestedCategoryName: string = '';
  @State confidenceScore: number = 0;
  @State errorMessage: string = '';

  // é€‰æ‹©å›¾ç‰‡
  async selectImage() {
    try {
      const photoPicker = new picker.PhotoViewPicker();
      const result = await photoPicker.select({
        MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE,
        maxSelectNumber: 1
      });

      if (result.photoUris && result.photoUris.length > 0) {
        this.selectedImagePath = result.photoUris[0];
        this.hasResult = false;
        this.errorMessage = '';

        // å¼€å§‹è¯†åˆ«
        await this.processOCR();
      }
    } catch (err) {
      let error = err as Error;
      console.error('[OCRScanPage] é€‰æ‹©å›¾ç‰‡å¤±è´¥:', error);
      promptAction.showToast({ message: 'é€‰æ‹©å›¾ç‰‡å¤±è´¥' });
    }
  }

  // æ‰§è¡ŒOCRè¯†åˆ«
  async processOCR() {
    const userId = UserSessionService.getCurrentUserId();
    if (!userId) {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•' });
      return;
    }

    this.isProcessing = true;
    this.errorMessage = '';

    try {
      const result: OCRRecognitionResult = await OCRRecognitionService.recognizeReceipt({
        userId: userId,
        imagePath: this.selectedImagePath,
        provider: 'huawei_ml_kit'
      });

      if (result.success) {
        this.merchantName = result.merchantName;
        this.totalAmount = result.totalAmount;
        this.transactionDate = result.transactionDate;
        this.suggestedCategoryId = result.suggestedCategoryId;
        this.suggestedCategoryName = result.suggestedCategoryName;
        this.confidenceScore = result.confidenceScore;
        this.hasResult = true;
      } else {
        this.errorMessage = result.error || 'è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•';
      }
    } catch (err) {
      let error = err as Error;
      console.error('[OCRScanPage] OCRè¯†åˆ«å¤±è´¥:', error);
      this.errorMessage = 'è¯†åˆ«è¿‡ç¨‹å‡ºé”™ï¼Œè¯·é‡è¯•';
    } finally {
      this.isProcessing = false;
    }
  }

  // ä½¿ç”¨è¯†åˆ«ç»“æœï¼Œè·³è½¬åˆ°è®°è´¦é¡µé¢
  useResult() {
    router.pushUrl({
      url: 'pages/AddBill',
      params: {
        prefilledAmount: this.totalAmount.toString(),
        prefilledNote: this.merchantName,
        prefilledCategoryId: this.suggestedCategoryId,
        prefilledDate: this.transactionDate
      }
    });
  }

  // é‡æ–°é€‰æ‹©å›¾ç‰‡
  retry() {
    this.hasResult = false;
    this.selectedImagePath = '';
    this.errorMessage = '';
  }

  build() {
    Navigation() {
      Column() {
        // ä¸»å†…å®¹åŒºåŸŸ
        if (this.isProcessing) {
          // åŠ è½½ä¸­çŠ¶æ€
          Column() {
            LoadingProgress()
              .width(80)
              .height(80)
              .color('#4A90E2')

            Text('æ­£åœ¨è¯†åˆ«å°ç¥¨...')
              .fontSize(16)
              .fontColor('#666')
              .margin({ top: 20 })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)

        } else if (this.hasResult) {
          // è¯†åˆ«ç»“æœé¢„è§ˆ
          Column({ space: 15 }) {
            Text('è¯†åˆ«ç»“æœ')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 10 })

            // ç»“æœå¡ç‰‡
            Column({ space: 12 }) {
              // å•†å®¶
              Row() {
                Text('å•†å®¶')
                  .fontSize(14)
                  .fontColor('#888')
                  .width(80)
                Text(this.merchantName || 'æœªè¯†åˆ«')
                  .fontSize(16)
                  .fontColor('#333')
                  .layoutWeight(1)
              }
              .width('100%')

              Divider()

              // é‡‘é¢
              Row() {
                Text('é‡‘é¢')
                  .fontSize(14)
                  .fontColor('#888')
                  .width(80)
                Text(`Â¥ ${this.totalAmount.toFixed(2)}`)
                  .fontSize(20)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#E74C3C')
                  .layoutWeight(1)
              }
              .width('100%')

              Divider()

              // æ—¥æœŸ
              Row() {
                Text('æ—¥æœŸ')
                  .fontSize(14)
                  .fontColor('#888')
                  .width(80)
                Text(this.transactionDate || 'ä»Šå¤©')
                  .fontSize(16)
                  .fontColor('#333')
                  .layoutWeight(1)
              }
              .width('100%')

              Divider()

              // æ¨èåˆ†ç±»
              Row() {
                Text('åˆ†ç±»')
                  .fontSize(14)
                  .fontColor('#888')
                  .width(80)
                Text(this.suggestedCategoryName || 'å…¶ä»–')
                  .fontSize(16)
                  .fontColor('#4A90E2')
                  .layoutWeight(1)
              }
              .width('100%')

              // ç½®ä¿¡åº¦
              Row() {
                Text('ç½®ä¿¡åº¦')
                  .fontSize(14)
                  .fontColor('#888')
                  .width(80)
                Progress({ value: this.confidenceScore * 100, total: 100, type: ProgressType.Linear })
                  .width(150)
                  .height(8)
                Text(`${(this.confidenceScore * 100).toFixed(0)}%`)
                  .fontSize(12)
                  .fontColor('#888')
                  .margin({ left: 10 })
              }
              .width('100%')
            }
            .width('100%')
            .padding(20)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .shadow({ radius: 4, color: '#1A000000', offsetX: 0, offsetY: 2 })

            // æ“ä½œæŒ‰é’®
            Row({ space: 15 }) {
              Button('é‡æ–°é€‰æ‹©')
                .type(ButtonType.Normal)
                .width('45%')
                .height(50)
                .backgroundColor('#F0F0F0')
                .fontColor('#333')
                .borderRadius(25)
                .onClick(() => this.retry())

              Button('ä½¿ç”¨ç»“æœ')
                .type(ButtonType.Normal)
                .width('45%')
                .height(50)
                .backgroundColor('#4A90E2')
                .fontColor(Color.White)
                .borderRadius(25)
                .onClick(() => this.useResult())
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .margin({ top: 30 })
          }
          .width('100%')
          .padding(20)
          .layoutWeight(1)

        } else if (this.errorMessage) {
          // é”™è¯¯çŠ¶æ€
          Column({ space: 20 }) {
            Text('ğŸ˜•')
              .fontSize(60)

            Text(this.errorMessage)
              .fontSize(16)
              .fontColor('#E74C3C')
              .textAlign(TextAlign.Center)

            Button('é‡æ–°é€‰æ‹©å›¾ç‰‡')
              .type(ButtonType.Capsule)
              .width('60%')
              .height(45)
              .backgroundColor('#4A90E2')
              .onClick(() => this.selectImage())
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)

        } else {
          // åˆå§‹çŠ¶æ€ - å¼•å¯¼é€‰æ‹©å›¾ç‰‡
          Column({ space: 30 }) {
            // å›¾æ ‡
            Text('ğŸ“·')
              .fontSize(80)

            Text('æ‰«æå°ç¥¨')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')

            Text('æ‹ç…§æˆ–é€‰æ‹©å°ç¥¨å›¾ç‰‡ï¼Œè‡ªåŠ¨è¯†åˆ«é‡‘é¢å’Œå•†å®¶ä¿¡æ¯')
              .fontSize(14)
              .fontColor('#888')
              .textAlign(TextAlign.Center)
              .padding({ left: 40, right: 40 })

            // é€‰æ‹©å›¾ç‰‡æŒ‰é’®
            Button('é€‰æ‹©å›¾ç‰‡')
              .type(ButtonType.Capsule)
              .width('70%')
              .height(50)
              .fontSize(18)
              .backgroundColor('#4A90E2')
              .margin({ top: 20 })
              .onClick(() => this.selectImage())

            // æç¤º
            Text('æ”¯æŒè¶…å¸‚å°ç¥¨ã€é¤é¥®å‘ç¥¨ç­‰å¸¸è§ç¥¨æ®')
              .fontSize(12)
              .fontColor('#AAA')
              .margin({ top: 30 })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')
    }
    .title('æ‰«æå°ç¥¨')
    .titleMode(NavigationTitleMode.Mini)
  }
}
