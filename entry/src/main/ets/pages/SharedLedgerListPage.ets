import router from '@ohos.router';
import { SharedLedgerService, CreateLedgerParams } from '../service/SharedLedgerService';
import { SharedLedger, LedgerInvitation } from '../model/SharedLedger';
import { UserSessionService } from '../service/UserSessionService';
import promptAction from '@ohos.promptAction';

@Entry
@Component
struct SharedLedgerListPage {
  @State ledgers: SharedLedger[] = [];
  @State invitations: LedgerInvitation[] = [];
  @State isLoading: boolean = false;
  
  // åˆ›å»ºè´¦æœ¬å¼¹çª—ç›¸å…³çŠ¶æ€
  @State showCreateDialog: boolean = false;
  @State newLedgerName: string = '';
  @State newLedgerType: string = 'family';
  
  // è´¦æœ¬ç±»åž‹é€‰é¡¹
  private ledgerTypes: SelectOption[] = [
    { value: 'family', label: 'å®¶åº­' },
    { value: 'couple', label: 'æƒ…ä¾£' },
    { value: 'roommate', label: 'å®¤å‹' },
    { value: 'trip', label: 'æ—…è¡Œ' },
    { value: 'team', label: 'å›¢é˜Ÿ' },
    { value: 'project', label: 'é¡¹ç›®' },
    { value: 'other', label: 'å…¶ä»–' }
  ];

  /* 
   * è‡ªå®šä¹‰å¼¹çª—æŽ§åˆ¶å™¨
   */
  createDialogController: CustomDialogController = new CustomDialogController({
    builder: CreateLedgerDialog({
      name: $newLedgerName,
      type: $newLedgerType,
      onConfirm: () => { this.handleCreateLedger(); }
    }),
    alignment: DialogAlignment.Bottom,
    customStyle: true
  });

  aboutToAppear() {
    this.loadData();
  }

  onPageShow() {
    this.loadData();
  }

  async loadData() {
    this.isLoading = true;
    try {
      const userId = UserSessionService.getCurrentUserId();
      if (!userId) {
        promptAction.showToast({ message: 'è¯·å…ˆç™»å½•' });
        return;
      }
      // Load Ledgers and Invitations in parallel
      // Load Ledgers and Invitations in parallel
      const results = await Promise.all([
        SharedLedgerService.getUserLedgers(userId),
        SharedLedgerService.getUserInvitations(userId)
      ]);
      
      const ledgers = results[0];
      const invitations = results[1];
      
      this.ledgers = ledgers;
      this.invitations = invitations;
      
    } catch (error) {
      console.error('[SharedLedgerListPage] åŠ è½½å¤±è´¥:', error);
      promptAction.showToast({ message: 'åŠ è½½å¤±è´¥' });
    } finally {
      this.isLoading = false;
    }
  }

  async handleCreateLedger() {
    if (!this.newLedgerName.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥è´¦æœ¬åç§°' });
      return;
    }

    try {
      const userId = UserSessionService.getCurrentUserId();
      if (!userId) return;
      const user = UserSessionService.getCurrentSession(); // èŽ·å–ç”¨æˆ·å

      const params: CreateLedgerParams = {
        name: this.newLedgerName,
        type: this.newLedgerType as 'family' | 'roommate' | 'couple' | 'group' | 'trip' | 'project' | 'other',
        currency: 'CNY',
        color: '#2196F3', // é»˜è®¤é¢œè‰²
        ownerId: userId,
        ownerName: user ? user.username : 'Unknown'
      };

      await SharedLedgerService.createLedger(params);
      promptAction.showToast({ message: 'åˆ›å»ºæˆåŠŸ' });
      this.loadData(); // åˆ·æ–°åˆ—è¡¨
      
    } catch (error) {
      promptAction.showToast({ message: 'åˆ›å»ºå¤±è´¥: ' + error.message });
    }
  }

  async handleAccept(invitation: LedgerInvitation) {
    try {
      await SharedLedgerService.acceptInvitation(invitation.invitationId);
      promptAction.showToast({ message: 'å·²åŠ å…¥è´¦æœ¬' });
      this.loadData();
    } catch (error) {
      promptAction.showToast({ message: 'æ“ä½œå¤±è´¥: ' + error.message });
    }
  }

  async handleDecline(invitation: LedgerInvitation) {
     try {
      await SharedLedgerService.declineInvitation(invitation.invitationId);
      promptAction.showToast({ message: 'å·²æ‹’ç»é‚€è¯·' });
      this.loadData();
    } catch (error) {
      promptAction.showToast({ message: 'æ“ä½œå¤±è´¥: ' + error.message });
    }
  }

  build() {
    Stack() {
      Column() {
        // Header
        Row() {
          Image($r('app.media.back')) // å‡è®¾æœ‰
            .width(24).height(24)
            .onClick(() => router.back())
            .margin({ right: 10 })
            
          Text('å…±äº«è´¦æœ¬')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
          
          Blank()
          
          Text('æ–°å»º') 
            .fontSize(16)
            .fontColor(Color.Blue)
            .onClick(() => {
              this.newLedgerName = '';
              this.newLedgerType = 'family';
              this.createDialogController.open();
            })
        }
        .width('100%')
        .padding(16)
        .backgroundColor(Color.White)

        if (this.isLoading) {
           Text('åŠ è½½ä¸­...').margin({ top: 50 })
        } else {
           List({ space: 12 }) {
             // 1. Invitations Section
             if (this.invitations.length > 0) {
               ListItem() {
                 Text('å¾…å¤„ç†é‚€è¯·')
                   .fontSize(14).fontColor(Color.Gray).margin({ bottom: 5, left: 5 })
               }
               ForEach(this.invitations, (invite: LedgerInvitation) => {
                 ListItem() {
                   this.InvitationCard(invite)
                 }
               })
               ListItem() {
                 Divider().strokeWidth(1).color('#E0E0E0').margin({top: 5, bottom: 5})
               }
             }

             // 2. Ledgers Section
             if (this.ledgers.length === 0 && this.invitations.length === 0) {
                 ListItem() {
                   Column() {
                     Text('ðŸ“’') 
                       .fontSize(50).margin({ bottom: 20 })
                     Text('è¿˜æ²¡æœ‰å…±äº«è´¦æœ¬\nå¿«åŽ»åˆ›å»ºä¸€ä¸ªå§')
                       .textAlign(TextAlign.Center)
                       .fontSize(16)
                       .fontColor(Color.Gray)
                     
                     Button('æ–°å»ºè´¦æœ¬')
                       .margin({ top: 30 })
                       .onClick(() => {
                          this.newLedgerName = '';
                          this.createDialogController.open();
                       })
                   }
                   .width('100%')
                   .height(300)
                   .justifyContent(FlexAlign.Center)
                 }
             } else {
                 ForEach(this.ledgers, (item: SharedLedger) => {
                   ListItem() {
                     this.LedgerCard(item)
                   }
                   .onClick(() => {
                     // è·³è½¬è¯¦æƒ…é¡µï¼Œä¼ é€’ID
                     router.pushUrl({
                       url: 'pages/SharedLedgerDetailPage',
                       params: { ledgerId: item.ledgerId }
                     });
                   })
                 })
             }
           }
           .width('100%')
           .layoutWeight(1)
           .padding(16)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F1F3F5')
    }
  }

  @Builder InvitationCard(invite: LedgerInvitation) {
    Row() {
       Column() {
         Text(`é‚€è¯·åŠ å…¥: ${invite.ledgerName}`)
           .fontSize(16).fontWeight(FontWeight.Bold)
         Text(`é‚€è¯·äºº: ${invite.inviterName}`)
           .fontSize(12).fontColor(Color.Gray).margin({top: 4})
       }
       .alignItems(HorizontalAlign.Start)
       
       Blank()
       
       Row() {
         Button('æ‹’ç»')
           .fontSize(12)
           .fontColor(Color.Red)
           .backgroundColor('#FFEBEE') // Light Red
           .height(28)
           .onClick(() => this.handleDecline(invite))
           .margin({ right: 8 })
           
         Button('æŽ¥å—')
           .fontSize(12)
           .fontColor(Color.Green)
           .backgroundColor('#E8F5E9') // Light Green
           .height(28)
           .onClick(() => this.handleAccept(invite))
       }
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(10)
    .shadow({ radius: 2, color: '#E0E0E0', offsetY: 1 })
    .border({ width: 1, color: '#FF9800', style: BorderStyle.Solid }) // Orange border for attention
  }

  @Builder LedgerCard(ledger: SharedLedger) {
    Row() {
      // Icon Placeholder
      Column() {
        Text(ledger.name.substring(0, 1))
          .fontSize(20)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Bold)
      }
      .width(50)
      .height(50)
      .borderRadius(25)
      .backgroundColor(ledger.color || '#2196F3')
      .justifyContent(FlexAlign.Center)
      .margin({ right: 15 })

      Column() {
        Text(ledger.name)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 5 })
        
        Row() {
           Text(this.getTypeLabel(ledger.type))
             .fontSize(12)
             .fontColor(Color.Gray)
             .backgroundColor('#F0F0F0')
             .padding({ left: 6, right: 6, top: 2, bottom: 2 })
             .borderRadius(4)
             .margin({ right: 10 })

           Text(`${ledger.memberCount} æˆå‘˜`)
             .fontSize(12)
             .fontColor(Color.Gray)
        }
      }
      .alignItems(HorizontalAlign.Start)
      
      Blank()
      
      // Arrow
      Text('>')
        .fontSize(18)
        .fontColor(Color.Gray)
    }
    .width('100%')
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 2, color: '#E0E0E0', offsetY: 1 })
  }

  getTypeLabel(type: string): string {
    const map: Record<string, string> = {
      'family': 'å®¶åº­', 'couple': 'æƒ…ä¾£', 'roommate': 'å®¤å‹', 
      'trip': 'æ—…è¡Œ', 'team': 'å›¢é˜Ÿ', 'project': 'é¡¹ç›®'
    };
    return map[type] || 'å…¶ä»–';
  }
}

// ç®€å•çš„ SelectOption æŽ¥å£
interface SelectOption {
  value: string;
  label: string;
}

@CustomDialog
struct CreateLedgerDialog {
  controller: CustomDialogController;
  @Link name: string;
  @Link type: string;
  onConfirm: () => void = () => {};
  
  private ledgerTypes: SelectOption[] = [
    { value: 'family', label: 'å®¶åº­' },
    { value: 'couple', label: 'æƒ…ä¾£' },
    { value: 'roommate', label: 'å®¤å‹' },
    { value: 'trip', label: 'æ—…è¡Œ' },
    { value: 'team', label: 'å›¢é˜Ÿ' },
    { value: 'project', label: 'é¡¹ç›®' },
    { value: 'other', label: 'å…¶ä»–' }
  ];

  build() {
    Column() {
      Text('åˆ›å»ºå…±äº«è´¦æœ¬')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 20, top: 10 })

      TextInput({ placeholder: 'ç»™è´¦æœ¬èµ·ä¸ªåå­—', text: this.name })
        .onChange((val) => this.name = val)
        .margin({ bottom: 15 })
        .width('90%')
      
      Text('é€‰æ‹©ç±»åž‹')
        .fontSize(14)
        .fontColor(Color.Gray)
        .width('90%')
        .margin({ bottom: 5 })

      // ç®€å•çš„ç±»åž‹é€‰æ‹© - ä½¿ç”¨ Flex æ¢è¡Œ
      Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
        ForEach(this.ledgerTypes, (item: SelectOption) => {
          Text(item.label)
            .fontSize(14)
            .fontColor(this.type === item.value ? Color.White : '#333')
            .backgroundColor(this.type === item.value ? '#2196F3' : '#F0F0F0')
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .borderRadius(15)
            .margin({ right: 8, bottom: 8 })
            .onClick(() => {
              this.type = item.value;
            })
        })
      }
      .width('90%')
      .margin({ bottom: 20 })

      Row() {
        Button('å–æ¶ˆ')
          .backgroundColor('#F0F0F0')
          .fontColor('#333')
          .width('40%')
          .onClick(() => this.controller.close())
        
        Button('åˆ›å»º')
          .width('40%')
          .onClick(() => {
            this.controller.close();
            this.onConfirm();
          })
      }
      .justifyContent(FlexAlign.SpaceBetween)
      .width('90%')
      .margin({ bottom: 10 })
    }
    .backgroundColor(Color.White)
    .borderRadius({ topLeft: 16, topRight: 16 })
    .width('100%')
    .padding(20)
  }
}
