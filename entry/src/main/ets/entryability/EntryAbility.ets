/*
 * Copyright (c) 2022 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import hilog from '@ohos.hilog'
import UIAbility from '@ohos.app.ability.UIAbility'
import Window from '@ohos.window'
import type Want  from '@ohos.app.ability.Want';
import { AccountDAO } from '../dao/AccountDAO'
import { BillDAO } from '../dao/BillDAO'
import { CategoryDAO } from '../dao/CategoryDAO'
import { BudgetDAO } from '../dao/BudgetDAO'
import { StatisticsDAO } from '../dao/StatisticsDAO'
import { UserDAO } from '../dao/UserDAO'
import { Account } from '../model/Account'
import { Category } from '../model/Category'
import { Ability, AbilityConstant } from '@kit.AbilityKit';
import { BusinessError} from '@kit.BasicServicesKit';

export default class EntryAbility extends UIAbility {
  async onCreate(want:Want, launchParam:AbilityConstant.LaunchParam) {
    hilog.isLoggable(0x0000, 'testTag', hilog.LogLevel.INFO)
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onCreate')
    hilog.info(0x0000, 'testTag', '%{public}s', 'want param:' + JSON.stringify(want) ?? '')
    hilog.info(0x0000, 'testTag', '%{public}s', 'launchParam:' + JSON.stringify(launchParam) ?? '')
  //åˆå§‹åŒ–æ‰€æœ‰çš„æ•°æ®åº“
    try{
    let context = this.context;
      await AccountDAO.initDatabase(context);
      await CategoryDAO.initDatabase(context);
      await BillDAO.initDatabase(context);
      await BudgetDAO.initDatabase(context);
      await StatisticsDAO.initDatabase(context);
      await UserDAO.initDatabase(context);

      hilog.info(0x0000, 'testTag', 'æ‰€æœ‰æ•°æ®åº“å’Œè¡¨åˆå§‹åŒ–æˆåŠŸ');

      //æ·»åŠ ä¸´æ—¶çš„å¤–é”®ä¾èµ–æ•°æ®ï¼ŒBillDAOé‡Œé¢æœ‰validateForeignKeysæ£€æŸ¥
      //æ‰€ä»¥å¿…é¡»ä¿è¯æ•°æ®åº“å½“ä¸­è‡³å°‘æœ‰ä¸€ä¸ªè´¦æˆ·å’Œåˆ†ç±»å¦åˆ™å¤±è´¥
      await this.insertMockPrerequisites();

    }catch (error){
      hilog.error(0x00,'testTag','æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: %{public}s', JSON.stringify(error));
    }
  }

  onDestroy() {
    hilog.isLoggable(0x0000, 'testTag', hilog.LogLevel.INFO)
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onDestroy')
  }

  onWindowStageCreate(windowStage: Window.WindowStage) {
    // Main window is created, set main page for this ability
    hilog.isLoggable(0x0000, 'testTag', hilog.LogLevel.INFO);
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onWindowStageCreate')

    windowStage.loadContent('pages/Index', (err, data) => {
      if (err.code) {
        hilog.isLoggable(0x0000, 'testTag', hilog.LogLevel.ERROR);
        hilog.error(0x0000, 'testTag', 'Failed to load the content. Cause: %{public}s', JSON.stringify(err) ?? '')
        return
      }
      hilog.isLoggable(0x0000, 'testTag', hilog.LogLevel.INFO)
      hilog.info(0x0000, 'testTag', 'Succeeded in loading the content. Data: %{public}s', JSON.stringify(data) ?? '')
    })
  }

  onWindowStageDestroy() {
    // Main window is destroyed, release UI related resources
    hilog.isLoggable(0x0000, 'testTag', hilog.LogLevel.INFO)
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onWindowStageDestroy')
  }

  onForeground() {
    // Ability has brought to foreground
    hilog.isLoggable(0x0000, 'testTag', hilog.LogLevel.INFO)
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onForeground')
  }

  onBackground() {
    // Ability has back to background
    hilog.isLoggable(0x0000, 'testTag', hilog.LogLevel.INFO)
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onBackground')
  }
  async insertMockPrerequisites() {
    // 1. æ’å…¥ä¸€ä¸ªæ¨¡æ‹Ÿè´¦æˆ· (Account)
    try {
      // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œé¿å…é‡å¤æ’å…¥ (ä½¿ç”¨ AccountDAO.ets ä¸­çš„ getById)
      const existingAccount = await AccountDAO.getById(1); // å‡è®¾æˆ‘ä»¬ç”¨ ID 1
      if (!existingAccount) {
        const mockAccount = new Account();
        // æ³¨æ„ï¼šDAO é‡Œçš„ account_id æ˜¯è‡ªå¢ä¸»é”®ï¼Œè¿™é‡Œä¸éœ€è¦è®¾ç½®
        mockAccount.userId = 1; // æ¨¡æ‹Ÿç”¨æˆ·1
        mockAccount.name = 'æ¨¡æ‹Ÿç°é‡‘è´¦æˆ·';
        mockAccount.type = 'cash';
        mockAccount.balance = 10000;
        mockAccount.createdAt = new Date().toISOString();
        mockAccount.updatedAt = new Date().toISOString();

        await AccountDAO.insert(mockAccount);
        hilog.info(0x0000, 'testTag', 'æ¨¡æ‹Ÿè´¦æˆ·æ’å…¥æˆåŠŸ');
      } else {
        hilog.info(0x0000, 'testTag', 'æ¨¡æ‹Ÿè´¦æˆ·å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥');
      }
    } catch (err) {
      const e = err as BusinessError;
      hilog.error(0x0000, 'testTag', 'æ’å…¥æ¨¡æ‹Ÿè´¦æˆ·å¤±è´¥: %{public}s', `code=${e.code}, msg=${e.message}`);
    }

    // 2. æ’å…¥ä¸€ä¸ªæ¨¡æ‹Ÿåˆ†ç±» (Category)
    try {
      // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ (ä½¿ç”¨ CategoryDAO.ets ä¸­çš„ getById)
      // ç­¾åæ˜¯: getById(userId: number, categoryId: number)
      const existingCategory = await CategoryDAO.getById(1, 1); // å‡è®¾ç”¨æˆ·ID 1, åˆ†ç±»ID 1
      if (!existingCategory) {
        const mockCategory = new Category();
        // category_id ä¹Ÿæ˜¯è‡ªå¢ä¸»é”®
        mockCategory.userId = 1; // æ¨¡æ‹Ÿç”¨æˆ·1
        mockCategory.name = 'æ¨¡æ‹Ÿé¤é¥®';
        mockCategory.type = 'expense';
        mockCategory.icon = 'ğŸ½ï¸';
        mockCategory.color = '#FF6B6B';
        mockCategory.parentCategoryId = 0;
        mockCategory.createdAt = new Date().toISOString();
        mockCategory.updatedAt = new Date().toISOString();

        await CategoryDAO.insert(mockCategory);
        hilog.info(0x0000, 'testTag', 'æ¨¡æ‹Ÿåˆ†ç±»æ’å…¥æˆåŠŸ');
      } else {
        hilog.info(0x0000, 'testTag', 'æ¨¡æ‹Ÿåˆ†ç±»å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥');
      }
    } catch (err) {
      let e = err as BusinessError;
      hilog.error(0x0000, 'testTag', 'æ’å…¥æ¨¡æ‹Ÿåˆ†ç±»å¤±è´¥: %{public}s', `code=${e.code}, msg=${e.message}`);
    }
  }
}
