/*
 * Copyright (c) 2022 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import hilog from '@ohos.hilog'
import UIAbility from '@ohos.app.ability.UIAbility'
import Window from '@ohos.window'
import type Want  from '@ohos.app.ability.Want';
import { DatabaseManager } from '../database/DatabaseManager'
import { AccountDAO } from '../dao/AccountDAO'
import { CategoryDAO } from '../dao/CategoryDAO'
import { Account } from '../model/Account'
import { Category } from '../model/Category'
import { AbilityConstant } from '@kit.AbilityKit';
import { BusinessError} from '@kit.BasicServicesKit';
import { LogConfig } from '../common/AppConfig';
import { BreakpointSystem } from '../common/BreakpointSystem';

export default class EntryAbility extends UIAbility {
  private breakpointSystem: BreakpointSystem = new BreakpointSystem();

  async onCreate(want:Want, launchParam:AbilityConstant.LaunchParam) {
    // Initialize PersistentStorage for API Key
    PersistentStorage.PersistProp('LLM_API_KEY', 'sk-db4d76d137084e459292cb477ccde584');

    hilog.isLoggable(LogConfig.DOMAIN, LogConfig.TAG, hilog.LogLevel.INFO)
    hilog.info(LogConfig.DOMAIN, LogConfig.TAG, '%{public}s', 'Ability onCreate')
    hilog.info(LogConfig.DOMAIN, LogConfig.TAG, '%{public}s', 'want param:' + JSON.stringify(want) ?? '')
    hilog.info(LogConfig.DOMAIN, LogConfig.TAG, '%{public}s', 'launchParam:' + JSON.stringify(launchParam) ?? '')
    
    // ç»Ÿä¸€åˆå§‹åŒ–æ•°æ®åº“ï¼ˆä½¿ç”¨DatabaseManagerï¼‰
    try {
      const context = this.context;
      
      // ä½¿ç”¨DatabaseManagerç»Ÿä¸€åˆå§‹åŒ–
      await DatabaseManager.initDatabase(context);
      
      hilog.info(LogConfig.DOMAIN, LogConfig.TAG, 'âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ');

      // æ·»åŠ ä¸´æ—¶çš„å¤–é”®ä¾èµ–æ•°æ®
      // BillDAOé‡Œé¢æœ‰validateForeignKeysæ£€æŸ¥ï¼Œéœ€è¦è‡³å°‘ä¸€ä¸ªè´¦æˆ·å’Œåˆ†ç±»
      await this.insertMockPrerequisites();

    } catch (error) {
      hilog.error(LogConfig.DOMAIN, LogConfig.TAG, 'âŒ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: %{public}s', JSON.stringify(error));
    }
  }

  onDestroy() {
    hilog.isLoggable(LogConfig.DOMAIN, LogConfig.TAG, hilog.LogLevel.INFO)
    hilog.info(LogConfig.DOMAIN, LogConfig.TAG, '%{public}s', 'Ability onDestroy')
  }

  onWindowStageCreate(windowStage: Window.WindowStage) {
    // Main window is created, set main page for this ability
    hilog.isLoggable(LogConfig.DOMAIN, LogConfig.TAG, hilog.LogLevel.INFO);
    hilog.info(LogConfig.DOMAIN, LogConfig.TAG, '%{public}s', 'Ability onWindowStageCreate')
    
    // æ³¨å†Œå“åº”å¼æ–­ç‚¹ç³»ç»Ÿ
    this.breakpointSystem.register();

    windowStage.loadContent('pages/Index', (err, data) => {
      if (err.code) {
        hilog.isLoggable(LogConfig.DOMAIN, LogConfig.TAG, hilog.LogLevel.ERROR);
        hilog.error(LogConfig.DOMAIN, LogConfig.TAG, 'Failed to load the content. Cause: %{public}s', JSON.stringify(err) ?? '')
        return
      }
      hilog.isLoggable(LogConfig.DOMAIN, LogConfig.TAG, hilog.LogLevel.INFO)
      hilog.info(LogConfig.DOMAIN, LogConfig.TAG, 'Succeeded in loading the content. Data: %{public}s', JSON.stringify(data) ?? '')
    })
  }

  onWindowStageDestroy() {
    // Main window is destroyed, release UI related resources
    hilog.isLoggable(LogConfig.DOMAIN, LogConfig.TAG, hilog.LogLevel.INFO)
    hilog.info(LogConfig.DOMAIN, LogConfig.TAG, '%{public}s', 'Ability onWindowStageDestroy')
    
    // æ³¨é”€å“åº”å¼æ–­ç‚¹ç³»ç»Ÿ
    this.breakpointSystem.unregister();
  }

  onForeground() {
    // Ability has brought to foreground
    hilog.isLoggable(LogConfig.DOMAIN, LogConfig.TAG, hilog.LogLevel.INFO)
    hilog.info(LogConfig.DOMAIN, LogConfig.TAG, '%{public}s', 'Ability onForeground')
  }

  onBackground() {
    // Ability has back to background
    hilog.isLoggable(LogConfig.DOMAIN, LogConfig.TAG, hilog.LogLevel.INFO)
    hilog.info(LogConfig.DOMAIN, LogConfig.TAG, '%{public}s', 'Ability onBackground')
  }
  /**
   * æ’å…¥æ¨¡æ‹Ÿæ•°æ®ï¼ˆç”¨äºå¼€å‘æµ‹è¯•ï¼‰
   * ç¡®ä¿æ•°æ®åº“ä¸­è‡³å°‘æœ‰ä¸€ä¸ªè´¦æˆ·å’Œåˆ†ç±»ï¼Œæ»¡è¶³å¤–é”®çº¦æŸ
   */
  private async insertMockPrerequisites(): Promise<void> {
    // 1. æ’å…¥æ¨¡æ‹Ÿè´¦æˆ·
    try {
      const existingAccount = await AccountDAO.getById(1);
      if (!existingAccount) {
        const mockAccount = new Account();
        mockAccount.userId = 1;
        mockAccount.name = 'æ¨¡æ‹Ÿç°é‡‘è´¦æˆ·';
        mockAccount.type = 'cash';
        mockAccount.balance = 10000;
        mockAccount.createdAt = new Date().toISOString();
        mockAccount.updatedAt = new Date().toISOString();

        await AccountDAO.insert(mockAccount);
        hilog.info(LogConfig.DOMAIN, LogConfig.TAG, 'âœ… æ¨¡æ‹Ÿè´¦æˆ·æ’å…¥æˆåŠŸ');
      } else {
        hilog.info(LogConfig.DOMAIN, LogConfig.TAG, 'â„¹ï¸ æ¨¡æ‹Ÿè´¦æˆ·å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥');
      }
    } catch (err) {
      const e = err as BusinessError;
      hilog.error(LogConfig.DOMAIN, LogConfig.TAG, 'âŒ æ’å…¥æ¨¡æ‹Ÿè´¦æˆ·å¤±è´¥: code=%{public}d, msg=%{public}s', e.code, e.message);
    }

    // 2. æ’å…¥æ¨¡æ‹Ÿåˆ†ç±»
    try {
      const existingCategory = await CategoryDAO.getById(1, 1);
      if (!existingCategory) {
        const mockCategory = new Category();
        mockCategory.userId = 1;
        mockCategory.name = 'æ¨¡æ‹Ÿé¤é¥®';
        mockCategory.type = 'expense';
        mockCategory.icon = 'ğŸ½ï¸';
        mockCategory.color = '#FF6B6B';
        mockCategory.parentCategoryId = 0;
        mockCategory.createdAt = new Date().toISOString();
        mockCategory.updatedAt = new Date().toISOString();

        await CategoryDAO.insert(mockCategory);
        hilog.info(LogConfig.DOMAIN, LogConfig.TAG, 'âœ… æ¨¡æ‹Ÿåˆ†ç±»æ’å…¥æˆåŠŸ');
      } else {
        hilog.info(LogConfig.DOMAIN, LogConfig.TAG, 'â„¹ï¸ æ¨¡æ‹Ÿåˆ†ç±»å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥');
      }
    } catch (err) {
      const e = err as BusinessError;
      hilog.error(LogConfig.DOMAIN, LogConfig.TAG, 'âŒ æ’å…¥æ¨¡æ‹Ÿåˆ†ç±»å¤±è´¥: code=%{public}d, msg=%{public}s', e.code, e.message);
    }
  }
}
