/**
 * æ•°æ®åº“ç®¡ç†å™¨ - ç»Ÿä¸€ç®¡ç†æ•°æ®åº“åˆå§‹åŒ–å’Œè¿æ¥
 * è§£å†³å¤šä¸ª DAO é‡å¤åˆå§‹åŒ–æ•°æ®åº“çš„é—®é¢˜
 */
import relationalStore from '@ohos.data.relationalStore';
import common from '@ohos.app.ability.common';

export class DatabaseManager {
  private static db: relationalStore.RdbStore | null = null;
  private static isInitialized: boolean = false;
  
  // æ•°æ®åº“é…ç½®å¸¸é‡
  static readonly DB_NAME: string = 'harmony_expense.db';
  static readonly DB_VERSION: number = 1;
  static readonly SECURITY_LEVEL = relationalStore.SecurityLevel.S1;

  /**
   * åˆå§‹åŒ–æ•°æ®åº“ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
   * @param context åº”ç”¨ä¸Šä¸‹æ–‡
   */
  static async initDatabase(context: common.Context): Promise<void> {
    if (DatabaseManager.isInitialized && DatabaseManager.db) {
      console.log('[DatabaseManager] æ•°æ®åº“å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
      return;
    }

    try {
      const storeConfig: relationalStore.StoreConfig = {
        name: DatabaseManager.DB_NAME,
        securityLevel: DatabaseManager.SECURITY_LEVEL
      };
      
      DatabaseManager.db = await relationalStore.getRdbStore(context, storeConfig);
      console.log('[DatabaseManager] æ•°æ®åº“è¿æ¥æˆåŠŸ');
      
      // æŒ‰é¡ºåºåˆ›å»ºæ‰€æœ‰è¡¨
      await DatabaseManager.createAllTables();
      
      DatabaseManager.isInitialized = true;
      console.log('[DatabaseManager] æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
      DatabaseManager.isInitialized = false;
      throw DatabaseManager.toError('[DatabaseManager] æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥', error);
    }
  }

  /**
   * è·å–æ•°æ®åº“å®ä¾‹
   */
  static getDatabase(): relationalStore.RdbStore {
    if (!DatabaseManager.db) {
      throw new Error('[DatabaseManager] æ•°æ®åº“æœªåˆå§‹åŒ–ï¼Œè¯·å…ˆè°ƒç”¨ initDatabase()');
    }
    return DatabaseManager.db;
  }

  /**
   * æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²åˆå§‹åŒ–
   */
  static isDbInitialized(): boolean {
    return DatabaseManager.isInitialized && DatabaseManager.db !== null;
  }

  /**
   * åˆ›å»ºæ‰€æœ‰æ•°æ®è¡¨ï¼ˆæŒ‰ä¾èµ–é¡ºåºï¼‰
   */
  private static async createAllTables(): Promise<void> {
    const store = DatabaseManager.getDatabase();
    
    try {
      // 1. åˆ›å»ºç”¨æˆ·è¡¨ï¼ˆç‹¬ç«‹è¡¨ï¼Œæ— å¤–é”®ä¾èµ–ï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS users (
          user_id INTEGER PRIMARY KEY AUTOINCREMENT,
          username TEXT NOT NULL,
          email TEXT UNIQUE NOT NULL,
          password_hash TEXT NOT NULL,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0
        );
      `);
      console.log('[DatabaseManager] è¡¨ users åˆ›å»ºæˆåŠŸ');

      // 2. åˆ›å»ºè´¦æˆ·è¡¨ï¼ˆä¾èµ– usersï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS accounts (
          account_id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          name TEXT NOT NULL,
          type TEXT NOT NULL,
          balance REAL NOT NULL DEFAULT 0,
          color TEXT NOT NULL DEFAULT '#1890FF',
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0,
          FOREIGN KEY (user_id) REFERENCES users(user_id)
        );
      `);
      console.log('[DatabaseManager] è¡¨ accounts åˆ›å»ºæˆåŠŸ');

      // 3. åˆ›å»ºåˆ†ç±»è¡¨ï¼ˆä¾èµ– usersï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS categories (
          category_id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          name TEXT NOT NULL,
          type TEXT NOT NULL CHECK (type IN ('expense', 'income')),
          icon TEXT NOT NULL DEFAULT 'ğŸ“¦',
          color TEXT NOT NULL DEFAULT '#1890FF',
          parent_category_id INTEGER DEFAULT 0,
          sort_order INTEGER DEFAULT 0,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0 CHECK (is_deleted IN (0, 1)),
          FOREIGN KEY (user_id) REFERENCES users(user_id),
          UNIQUE(user_id, name, type)
        );
      `);
      
      // åˆ›å»ºåˆ†ç±»è¡¨ç´¢å¼•
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_category_user_type 
        ON categories(user_id, type) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_category_user_parent 
        ON categories(user_id, parent_category_id) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_category_sort 
        ON categories(user_id, sort_order, category_id);
      `);
      console.log('[DatabaseManager] è¡¨ categories åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 4. åˆ›å»ºè´¦å•è¡¨ï¼ˆä¾èµ– accounts å’Œ categoriesï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS bills (
          bill_id INTEGER PRIMARY KEY AUTOINCREMENT,
          account_id INTEGER NOT NULL,
          category_id INTEGER NOT NULL,
          amount REAL NOT NULL,
          type TEXT NOT NULL,
          note TEXT,
          transaction_date TEXT NOT NULL,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0,
          FOREIGN KEY (account_id) REFERENCES accounts(account_id),
          FOREIGN KEY (category_id) REFERENCES categories(category_id)
        );
      `);
      console.log('[DatabaseManager] è¡¨ bills åˆ›å»ºæˆåŠŸ');

      // 5. åˆ›å»ºé¢„ç®—è¡¨ï¼ˆä¾èµ– users å’Œ categoriesï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS budgets (
          budget_id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          category_id INTEGER NOT NULL,
          amount REAL NOT NULL,
          period TEXT NOT NULL,
          start_date TEXT NOT NULL,
          end_date TEXT,
          is_active INTEGER DEFAULT 1,
          is_deleted INTEGER DEFAULT 0,
          created_at TEXT NOT NULL,
          FOREIGN KEY (user_id) REFERENCES users(user_id),
          FOREIGN KEY (category_id) REFERENCES categories(category_id)
        );
      `);
      console.log('[DatabaseManager] è¡¨ budgets åˆ›å»ºæˆåŠŸ');

      // 6. åˆ›å»ºæœˆåº¦ç»Ÿè®¡è¡¨
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS monthly_statistics (
          user_id INTEGER NOT NULL,
          category_id INTEGER NOT NULL,
          month TEXT NOT NULL,
          total_expense REAL DEFAULT 0,
          total_income REAL DEFAULT 0,
          transaction_count INTEGER DEFAULT 0,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0,
          PRIMARY KEY (user_id, category_id, month)
        );
      `);
      console.log('[DatabaseManager] è¡¨ monthly_statistics åˆ›å»ºæˆåŠŸ');

      // 7. åˆ›å»ºåˆ†ç±»ç»Ÿè®¡è¡¨
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS category_statistics (
          category_id INTEGER NOT NULL,
          category_name TEXT NOT NULL,
          type TEXT NOT NULL,
          total_amount REAL DEFAULT 0,
          transaction_count INTEGER DEFAULT 0,
          percentage REAL DEFAULT 0,
          icon TEXT NOT NULL DEFAULT 'ğŸ“¦',
          color TEXT NOT NULL DEFAULT '#1890FF',
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0,
          PRIMARY KEY (category_id)
        );
      `);
      console.log('[DatabaseManager] è¡¨ category_statistics åˆ›å»ºæˆåŠŸ');

      // 8. åˆ›å»ºæ ‡ç­¾è¡¨ï¼ˆä¾èµ– usersï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS tags (
          tag_id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          name TEXT NOT NULL,
          color TEXT DEFAULT '#52C41A',
          usage_count INTEGER DEFAULT 0,
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          is_deleted INTEGER DEFAULT 0 CHECK (is_deleted IN (0, 1)),
          FOREIGN KEY (user_id) REFERENCES users(user_id),
          UNIQUE (user_id, name)
        );
      `);
      
      // åˆ›å»ºæ ‡ç­¾è¡¨ç´¢å¼•
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_tags_user 
        ON tags (user_id) WHERE is_deleted = 0;
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_tags_usage 
        ON tags (user_id, usage_count DESC) WHERE is_deleted = 0;
      `);
      console.log('[DatabaseManager] è¡¨ tags åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      // 9. åˆ›å»ºè´¦å•æ ‡ç­¾å…³è”è¡¨ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰
      await store.executeSql(`
        CREATE TABLE IF NOT EXISTS bill_tags (
          bill_id INTEGER NOT NULL,
          tag_id INTEGER NOT NULL,
          created_at TEXT NOT NULL,
          PRIMARY KEY (bill_id, tag_id),
          FOREIGN KEY (bill_id) REFERENCES bills(bill_id) ON DELETE CASCADE,
          FOREIGN KEY (tag_id) REFERENCES tags(tag_id) ON DELETE CASCADE
        );
      `);
      
      // åˆ›å»ºå…³è”è¡¨ç´¢å¼•
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_bill_tags_bill 
        ON bill_tags (bill_id);
      `);
      await store.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_bill_tags_tag 
        ON bill_tags (tag_id);
      `);
      console.log('[DatabaseManager] è¡¨ bill_tags åŠç´¢å¼•åˆ›å»ºæˆåŠŸ');

      console.log('[DatabaseManager] æ‰€æœ‰æ•°æ®è¡¨åˆ›å»ºå®Œæˆ');
    } catch (error) {
      throw DatabaseManager.toError('[DatabaseManager] åˆ›å»ºæ•°æ®è¡¨å¤±è´¥', error);
    }
  }

  /**
   * å…³é—­æ•°æ®åº“è¿æ¥
   */
  static async closeDatabase(): Promise<void> {
    if (DatabaseManager.db) {
      // HarmonyOS çš„ RdbStore æ²¡æœ‰æ˜¾å¼çš„ close æ–¹æ³•
      // æ•°æ®åº“ä¼šåœ¨åº”ç”¨é€€å‡ºæ—¶è‡ªåŠ¨å…³é—­
      DatabaseManager.db = null;
      DatabaseManager.isInitialized = false;
      console.log('[DatabaseManager] æ•°æ®åº“è¿æ¥å·²æ¸…ç†');
    }
  }

  /**
   * ç»Ÿä¸€é”™è¯¯å¤„ç†
   */
  private static toError(message: string, err: Error | string | object): Error {
    let details = '';
    try {
      details = typeof err === 'string' ? err : JSON.stringify(err);
    } catch (_) {
      details = String(err);
    }
    return new Error(`${message}${details ? ' -> ' + details : ''}`);
  }

  /**
   * æ‰§è¡Œäº‹åŠ¡
   */
  static async transaction(fn: () => Promise<void>): Promise<void> {
    const store = DatabaseManager.getDatabase();
    await store.beginTransaction();
    try {
      await fn();
      await store.commit();
    } catch (error) {
      await store.rollBack();
      throw DatabaseManager.toError('[DatabaseManager] äº‹åŠ¡æ‰§è¡Œå¤±è´¥', error);
    }
  }
}
