@startuml HarmonyExpense-ClassDiagram
!theme plain
skinparam classAttributeIconSize 0
skinparam linetype ortho
skinparam packageStyle rectangle

title HarmonyOS费用管理应用-类图-2.0.0版本

' 模型层 - 核心实体模型
package "模型层 - 核心实体" <<Rectangle>> #E8F5E9 {

    class User {
        - userId: number
        - username: string
        - email: string
        - passwordHash: string
        - createdAt: string
        - updatedAt: string
        - isDeleted: number
        --
        + validate(): boolean
        + toJSON(): UserJSON
        + fromJSON(json: UserJSON): User
        + clone(): User
    }

    class Account {
        - accountId: number
        - userId: number
        - name: string
        - type: string
        - balance: number
        - currency: string
        - color: string
        - icon: string
        --
        + validate(): boolean
        + toJSON(): AccountJSON
        + fromJSON(json: AccountJSON): Account
    }

    class Category {
        - categoryId: number
        - userId: number
        - name: string
        - type: string
        - icon: string
        - color: string
        - parentCategoryId: number
        --
        + validate(): boolean
        + toJSON(): CategoryJSON
        + fromJSON(json: CategoryJSON): Category
    }

    class Bill {
        - billId: number
        - userId: number
        - accountId: number
        - categoryId: number
        - amount: number
        - type: string
        - note: string
        - transactionDate: string
        --
        + validate(): boolean
        + toJSON(): BillJSON
        + fromJSON(json: BillJSON): Bill
    }

    class Budget {
        - budgetId: number
        - userId: number
        - categoryId: number
        - amount: number
        - period: string
        - startDate: string
        - endDate: string
        --
        + validate(): boolean
        + toJSON(): BudgetJSON
        + fromJSON(json: BudgetJSON): Budget
    }

    class Tag {
        - tagId: number
        - userId: number
        - name: string
        - color: string
        - usageCount: number
        --
        + validate(): boolean
        + toJSON(): TagJSON
        + fromJSON(json: TagJSON): Tag
    }
}

' 智能分类模型
package "智能分类模块" <<Rectangle>> #E1F5FE {

    class CategoryKeyword {
        - keywordId: number
        - userId: number
        - categoryId: number
        - keyword: string
        - weight: number
        - frequency: number
        - lastUsedAt: string
        --
        + validate(): boolean
        + toJSON(): CategoryKeywordJSON
        + fromJSON(json: CategoryKeywordJSON): CategoryKeyword
        + clone(): CategoryKeyword
    }

    class UserCategoryHabit {
        - habitId: number
        - userId: number
        - categoryId: number
        - merchantPattern: string
        - amountMin: number
        - amountMax: number
        - timePattern: string
        - usageCount: number
        --
        + isAmountInRange(amount: number): boolean
        + matchesMerchant(merchantName: string): boolean
        + validate(): boolean
    }

    class SmartCategoryResult {
        - recommendations: CategoryRecommendation[]
        - topRecommendation: CategoryRecommendation
        - analysisTime: number
        - matchMethod: string
        --
        + hasHighConfidence(threshold: number): boolean
        + getRecommendationsAbove(threshold: number): CategoryRecommendation[]
    }

    class SmartCategoryUtils {
        --
        + {static} calculateSimilarity(text1: string, text2: string): number
        + {static} extractKeywords(text: string): string[]
        + {static} createRecommendation(...): CategoryRecommendation
    }
}

' 异常检测模型
package "异常检测模块" <<Rectangle>> #FFF3E0 {

    class ConsumptionAnomaly {
        - anomalyId: number
        - userId: number
        - billId: number
        - amount: number
        - anomalyType: string
        - severity: string
        - algorithm: string
        - confidence: number
        - detailsJson: string
        - isConfirmed: number
        --
        + getDetails(): DetectionDetails
        + setDetails(details: DetectionDetails): void
        + markConfirmed(isAnomaly: boolean, feedback: string): void
        + validate(): boolean
    }

    class AnomalyStatistics {
        - userId: number
        - totalDetected: number
        - confirmedAnomalies: number
        - falsePositives: number
        - bySeverity: SeverityCount[]
        - byType: TypeCount[]
        - totalAmountSaved: number
        --
        + toJSON(): AnomalyStatisticsJSON
    }

    class AnomalyDetectionUtils {
        --
        + {static} createEmptyStatistics(userId: number): AnomalyStatistics
        + {static} createDetectionDetails(...): DetectionDetails
        + {static} getSeverityFromScore(score: number): string
        + {static} calculateZScore(value: number, mean: number, stdDev: number): number
    }
}

' 智能预算规划模型
package "智能预算规划模块" <<Rectangle>> #F3E5F5 {

    class BudgetForecast {
        - forecastId: number
        - userId: number
        - categoryId: number
        - forecastMonth: string
        - predictedAmount: number
        - confidence: number
        - forecastType: string
        - historicalDataJson: string
        --
        + getHistoricalData(): number[]
        + setHistoricalData(data: number[]): void
        + validate(): boolean
    }

    class SpendingTrend {
        - userId: number
        - categoryId: number
        - periodStart: string
        - periodEnd: string
        - averageAmount: number
        - growthRate: number
        - volatility: number
        - trend: string
        - seasonalFactorsJson: string
        --
        + getSeasonalFactors(): number[]
        + setSeasonalFactors(factors: number[]): void
    }

    class BudgetForecastUtils {
        --
        + {static} simpleMovingAverage(data: number[], period: number): number
        + {static} exponentialSmoothing(data: number[], alpha: number): number
        + {static} calculateStandardDeviation(data: number[]): number
        + {static} calculateGrowthRate(data: number[]): number
        + {static} determineSpendingTrend(growthRate: number): string
    }
}

' 财务健康评分模型
package "财务健康评分模块" <<Rectangle>> #E8EAF6 {

    class FinancialHealthScore {
        - scoreId: number
        - userId: number
        - overallScore: number
        - grade: string
        - dimensionScoresJson: string
        - calculatedAt: string
        --
        + getDimensionScores(): HealthDimensions
        + setDimensionScores(scores: HealthDimensions): void
        + validate(): boolean
    }

    class HealthSuggestion {
        - suggestionId: number
        - userId: number
        - dimension: string
        - priority: string
        - title: string
        - description: string
        - actionItems: string
        - potentialSavings: number
        - status: string
        --
        + getActionItemsList(): string[]
        + setActionItemsList(items: string[]): void
        + markCompleted(): void
    }

    class HealthScoreUtils {
        --
        + {static} calculateSavingsRateScore(savingsRate: number): number
        + {static} calculateDebtRatioScore(debtRatio: number): number
        + {static} calculateEmergencyFundScore(months: number): number
        + {static} calculateBudgetAdherenceScore(adherence: number): number
        + {static} getGradeFromScore(score: number): string
        + {static} createDimensionScore(name: string, score: number, weight: number): DimensionScore
    }
}

' 协作记账模型
package "协作记账模块" <<Rectangle>> #E0F2F1 {

    class SharedLedger {
        - ledgerId: number
        - name: string
        - description: string
        - type: string
        - ownerId: number
        - ownerName: string
        - memberCount: number
        - settingsJson: string
        --
        + getSettings(): LedgerSettings
        + setSettings(settings: LedgerSettings): void
        + validate(): boolean
    }

    class LedgerMember {
        - memberId: number
        - ledgerId: number
        - userId: number
        - role: string
        - permissionsJson: string
        - contributionAmount: number
        - billCount: number
        --
        + getPermissions(): string[]
        + setPermissions(permissions: string[]): void
        + hasPermission(permission: string): boolean
        + applyRolePermissions(): void
    }

    class SharedBill {
        - billId: number
        - ledgerId: number
        - creatorId: number
        - amount: number
        - approvalStatus: string
        - syncStatus: string
        - version: number
        - splitType: string
        - splitDetailsJson: string
        --
        + getSplitDetails(): BillSplitDetail[]
        + setSplitDetails(details: BillSplitDetail[]): void
        + splitEqually(members: SplitMemberInfo[]): void
        + incrementVersion(): void
    }

    class ApprovalRecord {
        - approvalId: number
        - ledgerId: number
        - billId: number
        - requesterId: number
        - approverId: number
        - status: string
        - amount: number
        --
        + approve(approverId: number, approverName: string, comment: string): void
        + reject(approverId: number, approverName: string, comment: string): void
    }

    class SharedLedgerUtils {
        --
        + {static} getDefaultSettings(): LedgerSettings
        + {static} getPermissionsForRole(role: string): string[]
        + {static} getRoleDescription(role: string): string
        + {static} createSplitDetail(...): BillSplitDetail
        + {static} generateInvitationCode(): string
    }
}

' OCR识别模型
package "OCR识别模块" <<Rectangle>> #FBE9E7 {

    class OCRTask {
        - taskId: number
        - userId: number
        - imageUri: string
        - thumbnailUri: string
        - provider: string
        - status: string
        - resultJson: string
        - processingTime: number
        - retryCount: number
        --
        + getResult(): OCRResult
        + setResult(result: OCRResult): void
        + markFailed(errorMessage: string): void
        + markProcessing(): void
        + incrementRetry(): boolean
    }

    class OCRUtils {
        --
        + {static} extractAmount(text: string): NumberField[]
        + {static} extractDate(text: string): DateField[]
        + {static} extractMerchant(text: string): StringField[]
        + {static} detectReceiptType(text: string, merchantName: string): string
        + {static} suggestCategoryId(receiptType: string): CategorySuggestion
        + {static} generateSuggestedBill(data: StructuredReceiptData, receiptType: string): SuggestedBillData
        + {static} getConfidenceLevel(confidence: number): string
        + {static} createEmptyStructuredData(): StructuredReceiptData
    }

    class OCRConfigUtils {
        --
        + {static} getDefaultConfig(): OCRConfig
        + {static} getDefaultPreprocessingOptions(): PreprocessingOptions
    }
}

' 事件溯源模型
package "事件溯源模块(CQRS)" <<Rectangle>> #ECEFF1 {

    class DomainEvent {
        - eventId: string
        - eventType: string
        - aggregateType: string
        - aggregateId: number
        - userId: number
        - version: number
        - payloadJson: string
        - metadataJson: string
        - occurredAt: string
        --
        + getPayloadAsString(): string
        + setPayloadFromString(payload: string): void
        + getMetadata(): EventMetadata
        + setMetadata(metadata: EventMetadata): void
        + validate(): boolean
    }

    class Command {
        - commandId: string
        - commandType: string
        - aggregateType: string
        - aggregateId: number
        - userId: number
        - payloadJson: string
        - status: string
        - expectedVersion: number
        --
        + markProcessing(): void
        + markSucceeded(): void
        + markFailed(errorMessage: string): void
        + markCancelled(): void
    }

    class AggregateSnapshot {
        - snapshotId: number
        - aggregateType: string
        - aggregateId: number
        - version: number
        - stateJson: string
        --
        + getStateAsString(): string
        + setStateFromString(state: string): void
        + validate(): boolean
    }

    class ReadModel {
        - modelId: number
        - modelType: string
        - userId: number
        - dataJson: string
        - lastEventVersion: number
        --
        + getDataAsString(): string
        + setDataFromString(data: string): void
        + updateEventVersion(version: number): void
    }

    class EventSourcingUtils {
        --
        + {static} generateUUID(): string
        + {static} createDefaultMetadata(correlationId: string, userId: number): EventMetadata
        + {static} createBillCreatedEvent(userId: number, billId: number, billDataJson: string): DomainEvent
        + {static} createBillUpdatedEvent(...): DomainEvent
        + {static} createBillDeletedEvent(...): DomainEvent
        + {static} shouldCreateSnapshot(currentVersion: number, lastSnapshotVersion: number, frequency: number): boolean
        + {static} calculateStats(events: DomainEvent[]): EventStoreStats
    }
}

' DAO层
package "DAO层" <<Rectangle>> #E3F2FD {

    class UserDAO {
        + {static} getInstance(): UserDAO
        + insert(user: User): Promise<number>
        + getById(userId: number): Promise<User>
        + update(user: User): Promise<void>
        + softDelete(userId: number): Promise<void>
    }

    class AccountDAO {
        + {static} getInstance(): AccountDAO
        + insert(account: Account): Promise<number>
        + getByUserId(userId: number): Promise<Account[]>
        + update(account: Account): Promise<void>
    }

    class CategoryDAO {
        + {static} getInstance(): CategoryDAO
        + insert(category: Category): Promise<number>
        + getCategoryTree(userId: number): Promise<CategoryTreeNode[]>
        + aggregateByCategory(filters: object): Promise<CategoryAggregation[]>
    }

    class BillDAO {
        + {static} getInstance(): BillDAO
        + insert(bill: Bill): Promise<number>
        + getByPage(pageNum: number, pageSize: number, filters: object): Promise<Bill[]>
        + getTotalStats(userId: number, filters: object): Promise<object>
    }

    class BudgetDAO {
        + {static} getInstance(): BudgetDAO
        + insert(budget: Budget): Promise<number>
        + getAllActive(): Promise<Budget[]>
        + update(budget: Budget): Promise<void>
    }

    class TagDAO {
        + {static} getInstance(): TagDAO
        + insert(tag: Tag): Promise<number>
        + getTagsByBillId(billId: number): Promise<Tag[]>
        + aggregateByTag(filters: object): Promise<TagAggregation[]>
    }
}

' 工具层
package "工具层" <<Rectangle>> #F5F5F5 {

    class DatabaseManager <<Singleton>> {
        + {static} getInstance(): DatabaseManager
        + initDatabase(): Promise<void>
        + getDatabase(): relationalStore.RdbStore
        + transaction(callback: Function): Promise<any>
    }

    class CacheManager <<Singleton>> {
        + {static} getInstance(): CacheManager
        + get<T>(key: string): T
        + set<T>(key: string, value: T, ttl?: number): void
        + getOrSet<T>(key: string, factory: Function, ttl?: number): Promise<T>
        + clear(pattern?: string): void
    }

    class PerformanceMonitor <<Singleton>> {
        + {static} getInstance(): PerformanceMonitor
        + measure<T>(operation: string, fn: Function): Promise<T>
        + recordQuery(operation: string, duration: number): void
        + getStats(): Map<string, QueryStat>
    }
}

' 关系定义

' 核心实体关系
User "1" -- "0..*" Account : 拥有 >
User "1" -- "0..*" Category : 创建 >
User "1" -- "0..*" Bill : 有 >
User "1" -- "0..*" Budget : 设置 >
User "1" -- "0..*" Tag : 定义 >

Account "1" -- "0..*" Bill : 记录 >
Category "1" -- "0..*" Bill : 分类 >
Bill "0..*" -- "0..*" Tag : 标记 >

' 智能分类关系
User "1" -- "0..*" CategoryKeyword : 学习 >
User "1" -- "0..*" UserCategoryHabit : 习惯 >
Category "1" -- "0..*" CategoryKeyword : 映射 >
SmartCategoryUtils ..> SmartCategoryResult : 返回
SmartCategoryUtils ..> CategoryKeyword : 使用

' 异常检测关系
User "1" -- "0..*" ConsumptionAnomaly : 检测 >
Bill "1" -- "0..1" ConsumptionAnomaly : 关联 >
AnomalyDetectionUtils ..> ConsumptionAnomaly : 创建
AnomalyDetectionUtils ..> AnomalyStatistics : 统计

' 智能预算关系
User "1" -- "0..*" BudgetForecast : 预测 >
User "1" -- "0..*" SpendingTrend : 分析 >
Category "1" -- "0..*" BudgetForecast : 预测 >
BudgetForecastUtils ..> BudgetForecast : 计算
BudgetForecastUtils ..> SpendingTrend : 分析

' 财务健康关系
User "1" -- "0..*" FinancialHealthScore : 评分 >
User "1" -- "0..*" HealthSuggestion : 建议 >
HealthScoreUtils ..> FinancialHealthScore : 计算
HealthScoreUtils ..> HealthSuggestion : 生成

' 协作记账关系
User "1" -- "0..*" SharedLedger : 创建 >
SharedLedger "1" -- "0..*" LedgerMember : 包含 >
SharedLedger "1" -- "0..*" SharedBill : 记录 >
SharedBill "1" -- "0..*" ApprovalRecord : 审批 >
SharedLedgerUtils ..> SharedLedger : 工具
SharedLedgerUtils ..> LedgerMember : 权限

' OCR识别关系
User "1" -- "0..*" OCRTask : 创建 >
OCRUtils ..> OCRTask : 处理
OCRConfigUtils ..> OCRUtils : 配置

' 事件溯源关系
DomainEvent "0..*" -- "1" Bill : 记录变更 >
DomainEvent "0..*" -- "1" Account : 记录变更 >
Command "0..*" -- "0..1" DomainEvent : 产生 >
AggregateSnapshot "0..*" -- "1" DomainEvent : 基于 >
EventSourcingUtils ..> DomainEvent : 创建
EventSourcingUtils ..> Command : 处理
EventSourcingUtils ..> AggregateSnapshot : 管理

' DAO层依赖
UserDAO ..> User : 管理
AccountDAO ..> Account : 管理
CategoryDAO ..> Category : 管理
BillDAO ..> Bill : 管理
BudgetDAO ..> Budget : 管理
TagDAO ..> Tag : 管理

UserDAO ..> DatabaseManager : 使用
AccountDAO ..> DatabaseManager : 使用
CategoryDAO ..> DatabaseManager : 使用
BillDAO ..> DatabaseManager : 使用
BudgetDAO ..> DatabaseManager : 使用
TagDAO ..> DatabaseManager : 使用

CategoryDAO ..> CacheManager : 缓存

' 注释说明
note right of "智能分类模块"
  AI智能分类引擎
  - 基于账单备注的智能分类推荐
  - 用户行为学习和模式识别
  - 关键词-分类映射管理
end note

note right of "异常检测模块"
  消费异常检测算法
  - 3σ原则统计检测
  - Z-Score标准化检测
  - IQR四分位距检测
  - 支持用户反馈学习
end note

note right of "智能预算规划模块"
  预算预测算法
  - 简单移动平均
  - 指数平滑
  - Holt-Winters季节性
  - 线性回归
end note

note right of "财务健康评分模块"
  多维度财务健康评估
  - 储蓄率评分
  - 负债率评分
  - 应急储备评分
  - 预算执行评分
  - 消费稳定性评分
end note

note right of "协作记账模块"
  家庭/团队协作记账
  - RBAC权限模型
  - 多租户数据隔离
  - 消费审批流程
  - 账单分摊功能
end note

note right of "OCR识别模块"
  智能票据识别
  - 华为ML Kit集成
  - 结构化数据提取
  - 多种票据类型支持
  - 自动填充账单信息
end note

note right of "事件溯源模块(CQRS)"
  企业级架构
  - 完整数据变更历史
  - 支持任意时间点回滚
  - 读写分离优化
  - 审计合规支持
end note

@enduml
