@startuml HarmonyExpense-Complete-Architecture
!theme plain
skinparam linetype ortho
skinparam packageStyle rectangle
skinparam defaultFontSize 10
skinparam noteFontSize 9

title HarmonyOS Expense App设计架构图 

' 定义颜色
!define ENTRY_COLOR #FFCDD2
!define PAGE_COLOR #FFEBEE
!define MODEL_COLOR #E8F5E9
!define DAO_COLOR #E3F2FD
!define SERVICE_COLOR #FFF3E0
!define DB_COLOR #F3E5F5
!define COMMON_COLOR #FFFDE7
!define CONFIG_COLOR #E0F7FA

' 应用入口层 (Entry Point Layer)

package "应用入口层" <<Rectangle>> ENTRY_COLOR {
    [EntryAbility] as entry
    note right of entry
        HarmonyOS UIAbility生命周期
        - onCreate(): 初始化数据库
        - onWindowStageCreate(): 注册响应式系统
        - onWindowStageDestroy(): 清理资源
        - onForeground/onBackground(): 状态管理
    end note
}

' 表示层 (Presentation Layer)

package "表示层" <<Rectangle>> PAGE_COLOR {
    package "核心页面" {
        [Index] as index_page
        [AddBill] as add_bill_page
        [CategoryManagement] as category_page
    }

    note bottom of index_page
        主页面
        - 账单列表展示
        - 日期/分类筛选
        - @State响应式状态
        - BreakpointSystem响应式布局
    end note

    note bottom of add_bill_page
        添加账单
        - 收入/支出表单
        - 账户/分类选择
        - 输入验证
    end note

    note bottom of category_page
        分类管理
        - CRUD操作
        - CustomDialog编辑
        - 层级管理
    end note
}


' 业务服务层 (Service Layer)

package "业务服务层" <<Rectangle>> SERVICE_COLOR {
    package "导出服务模块" {
        [ExportService] as export_service
        [ImportService] as import_service
        [EncryptionModule] as encryption
        [FileHelper] as file_helper
        [ChecksumHelper] as checksum_helper
    }

    package "导出类型定义" {
        [ExportTypes] as export_types
    }

    note right of export_service
        导出数据编排
        - 多格式导出支持
        - 数据加密处理
        - 完整性校验
    end note

    note right of encryption
        加密模块
        - AES-256-GCM加密
        - PBKDF2密钥派生
        - 100,000次迭代
    end note

    note right of file_helper
        文件操作
        - 文件名生成
        - 读写操作
        - 路径管理
    end note
}

' 数据访问层 (Data Access Layer)


package "数据访问层 - DAO" <<Rectangle>> DAO_COLOR {
    package "核心数据访问对象" {
        [UserDAO] as user_dao
        [AccountDAO] as account_dao
        [CategoryDAO] as category_dao
        [BillDAO] as bill_dao
        [BudgetDAO] as budget_dao
    }

    package "扩展数据访问对象" {
        [TagDAO] as tag_dao
        [StatisticsDAO] as stats_dao
    }

    note right of bill_dao
        账单DAO
        - insert/update/delete
        - getBillsByFilters()
        - getBillsByDateRange()
        - 外键验证
        - 分页支持
    end note

    note right of category_dao
        分类DAO
        - bulkInsert()
        - getCategoryTree()
        - getByType()
        - 缓存集成
    end note

    note right of tag_dao
        标签DAO
        - addTagToBill()
        - removeTagFromBill()
        - getTagsByBill()
        - getAggregation()
        - 多对多关系管理
    end note

    note right of stats_dao
        统计DAO
        - insertMonthly()
        - bulkInsertMonthly()
        - getMonthly()
        - getAllMonthly()
    end note
}

' 数据模型层 (Model Layer)

package "数据模型层" <<Rectangle>> MODEL_COLOR {
    package "核心实体" {
        [User] as user_model
        [Account] as account_model
        [Category] as category_model
        [Bill] as bill_model
        [Budget] as budget_model
    }

    package "扩展实体" {
        [Tag] as tag_model
        [BillTag] as bill_tag_model
    }

    package "统计模型" {
        [MonthlyStatistics] as monthly_stats
        [CategoryStatistics] as category_stats
    }

    package "聚合类型" {
        [CategoryTreeNode] as tree_node
        [CategoryAggregation] as cat_agg
        [TagAggregation] as tag_agg
    }

    note bottom of bill_model
        账单实体
        - billId, userId, accountId
        - categoryId, amount, note
        - transactionDate, type
        - validate(), toJSON()
        - fromJSON(), clone()
    end note

    note bottom of category_model
        分类实体
        - categoryId, name, type
        - icon, color, parentCategoryId
        - sortOrder (排序)
        - 软删除支持
    end note
}

' 数据库基础设施层 (Database Layer)

package "数据库基础设施层" <<Rectangle>> DB_COLOR {
    package "核心数据库组件" {
        [DatabaseManager] as db_manager
        [QueryHelper] as query_helper
    }

    package "性能优化组件" {
        [IndexManager] as index_manager
        [CacheManager] as cache_manager
        [BatchQueryHelper] as batch_helper
        [PerformanceMonitor] as perf_monitor
    }

    package "数据库配置组件" {
        [DatabaseConfigOptimizer] as db_optimizer
    }

    note right of db_manager
        数据库管理器(单例模式)
        - 初始化RdbStore
        - 创建所有表
        - 外键约束
        - SecurityLevel.S1
    end note

    note right of cache_manager
        缓存管理器
        - TTL过期机制
        - 模式匹配清除
        - 性能提升60-80%
        - 分类数据10分钟TTL
    end note

    note right of index_manager
        索引管理器
        - 覆盖索引(3-5倍提升)
        - 部分索引(50%空间节省)
        - 复合索引
    end note

    note right of perf_monitor
        性能监控
        - 装饰器模式
        - AOP无侵入监控
        - 慢查询检测(>100ms)
    end note
}

' 公共工具层 (Common Utilities Layer)

package "公共工具层" <<Rectangle>> COMMON_COLOR {
    package "DAO工具" {
        [DAOHelper] as dao_helper
    }

    package "UI工具" {
        [BreakpointSystem] as breakpoint
        [Constants] as constants
    }

    note right of dao_helper
        DAO辅助工具
        - toError(): 统一错误处理
        - transaction(): 事务管理
        - softDelete/restore/hardDelete()
        - exists(): 记录存在检查
        - getLong/getString/getDouble()
    end note

    note right of breakpoint
        响应式断点系统
        - xs: 0px, sm: 320px
        - md: 520px, lg: 840px
        - BreakPointType<T>泛型
    end note
}

' 配置管理层 (Configuration Layer)

package "配置管理层" <<Rectangle>> CONFIG_COLOR {  
    [DatabaseConfig] as db_config
    [CacheConfig] as cache_config
    [PerformanceConfig] as perf_config
    [EncryptionConfig] as enc_config
    [PaginationConfig] as page_config
    [FileConfig] as file_config
    [BusinessConfig] as biz_config
    [LogConfig] as log_config

    note bottom of db_config
        DB_NAME, DB_VERSION
        BATCH_SIZE: 500
        MAX_SQL_PARAMS: 999
    end note

    note bottom of cache_config
        DEFAULT_TTL: 5分钟
        CATEGORY_TTL: 10分钟
        USER_TTL: 30分钟
    end note

    note bottom of enc_config
        KEY_SIZE: 256位
        PBKDF2_ITERATIONS: 100000
    end note
}

' 外部依赖 (External Dependencies)

package "鸿蒙平台" <<Rectangle>> #FFFFFF {
    database "关系型数据库" as rdb_store
    [ArkTS Framework] as arkts
    [File System] as file_sys
}

' 依赖关系 - 入口层

entry --> db_manager : 初始化数据库
entry --> breakpoint : 注册断点系统
entry --> index_page : 加载主页面

' 依赖关系 - 表示层到服务层/数据访问层

index_page --> bill_dao : 查询账单
index_page --> category_dao : 获取分类
index_page --> account_dao : 获取账户
index_page --> breakpoint : 响应式布局
index_page --> constants : 常量引用

add_bill_page --> bill_dao : 创建账单
add_bill_page --> category_dao : 加载分类
add_bill_page --> account_dao : 加载账户
add_bill_page --> breakpoint : 响应式布局

category_page --> category_dao : 分类CRUD
category_page --> breakpoint : 响应式布局

index_page --> export_service : 导出数据
index_page --> import_service : 导入数据

' 依赖关系 - 服务层

export_service --> user_dao : 查询用户
export_service --> account_dao : 查询账户
export_service --> category_dao : 查询分类
export_service --> bill_dao : 查询账单
export_service --> budget_dao : 查询预算
export_service --> tag_dao : 查询标签
export_service --> encryption : 加密数据
export_service --> file_helper : 保存文件
export_service --> checksum_helper : 生成校验和
export_service --> export_types : 类型定义

import_service --> user_dao : 导入用户
import_service --> account_dao : 导入账户
import_service --> category_dao : 导入分类
import_service --> bill_dao : 导入账单
import_service --> budget_dao : 导入预算
import_service --> tag_dao : 导入标签
import_service --> encryption : 解密数据
import_service --> file_helper : 读取文件
import_service --> checksum_helper : 验证校验和
import_service --> db_manager : 事务管理

encryption --> enc_config : 加密配置
file_helper --> file_config : 文件配置
file_helper --> file_sys : 文件操作

' 依赖关系 - 数据访问层到模型层

user_dao --> user_model : 映射实体
account_dao --> account_model : 映射实体
category_dao --> category_model : 映射实体
category_dao --> tree_node : 树形结构
category_dao --> cat_agg : 聚合结果
bill_dao --> bill_model : 映射实体
budget_dao --> budget_model : 映射实体
tag_dao --> tag_model : 映射实体
tag_dao --> bill_tag_model : 关联实体
tag_dao --> tag_agg : 聚合结果
stats_dao --> monthly_stats : 映射实体
stats_dao --> category_stats : 映射实体

' 依赖关系 - 数据访问层到数据库层

user_dao --> db_manager : 数据库连接
user_dao --> dao_helper : 工具方法

account_dao --> db_manager : 数据库连接
account_dao --> dao_helper : 工具方法

category_dao --> db_manager : 数据库连接
category_dao --> dao_helper : 工具方法
category_dao --> cache_manager : 缓存数据

bill_dao --> db_manager : 数据库连接
bill_dao --> dao_helper : 工具方法
bill_dao --> batch_helper : 批量操作
bill_dao --> query_helper : 复杂查询

budget_dao --> db_manager : 数据库连接
budget_dao --> dao_helper : 工具方法

tag_dao --> db_manager : 数据库连接
tag_dao --> dao_helper : 工具方法
tag_dao --> batch_helper : 批量操作

stats_dao --> db_manager : 数据库连接
stats_dao --> dao_helper : 工具方法

' 依赖关系 - 数据库层内部

db_manager --> rdb_store : 数据库操作
db_manager --> index_manager : 创建索引
db_manager --> db_config : 数据库配置
db_manager --> db_optimizer : 性能优化

query_helper --> db_manager : 执行查询
batch_helper --> db_manager : 批量执行
cache_manager --> cache_config : 缓存配置
perf_monitor --> perf_config : 性能配置
perf_monitor --> db_manager : 监控查询

index_manager --> db_manager : 创建索引

' 配置依赖

dao_helper --> biz_config : 业务规则

legend top left
    |= 层级 |= 职责 |= 设计模式 |
    | Entry Point | 应用生命周期管理 | UIAbility |
    | Presentation | UI渲染和用户交互 | MVVM |
    | Service | 复杂业务逻辑编排 | Service |
    | DAO | 数据持久化操作 | DAO Pattern |
    | Model | 数据实体定义 | Entity |
    | Database | 数据库基础设施 | Singleton |
    | Common | 共享工具方法 | Helper |
    | Configuration | 集中配置管理 | Config |
endlegend

note as N1 #LightBlue
    **核心设计模式**
    
    1. 单例模式: DatabaseManager, CacheManager
    2. DAO模式: 数据访问抽象
    3. MVVM模式: 页面数据绑定
    4. 装饰器模式: PerformanceMonitor
    5. 工厂模式: toJSON/fromJSON
    6. 策略模式: 缓存/索引策略
    7. 模板方法: DAOHelper通用方法
end note

note as N2 #LightGreen
    **性能优化策略**
    
    1. 覆盖索引: 查询性能提升3-5倍
    2. 部分索引: 存储空间节省50%
    3. 内存缓存: 性能提升60-80%
    4. 批量操作: 性能提升10-50倍
    5. 慢查询监控: >100ms预警
end note

note as N3 #LightYellow
    **数据完整性保障**
    
    1. 软删除: is_deleted字段
    2. 外键约束: 数据库强制执行
    3. 模型验证: validate()方法
    4. 事务支持: 自动回滚
    5. 校验和: 导出数据完整性
end note

note as N4 #LightPink
    **安全特性**
    
    1. AES-256-GCM加密
    2. PBKDF2密钥派生(100000次迭代)
    3. 参数化查询(防SQL注入)
    4. SecurityLevel.S1安全级别
end note

' 设置所有元素横向线性排列在底部
N1 -[hidden]right-> N2
N2 -[hidden]right-> N3
N3 -[hidden]right-> N4

@enduml