# 高级功能实现文档 (v1.2.0)

## 概述

本文档描述了鸿蒙记账应用v1.2.0版本新增的高级功能实现，包括：
1. **用户会话管理** - 替代单例模式，支持真实登录系统
2. **定期账单/预算提醒** - 支持多种频率的提醒功能
3. **数据云端同步** - 支持数据上传、下载和双向同步

---

## 1. 用户会话管理

### 1.1 功能说明

替代原有的单例模式 `CURRENT_USER_ID`，提供完整的用户登录、登出和会话管理功能。

### 1.2 核心文件

- **服务**: `entry/src/main/ets/service/UserSessionService.ets`
- **常量**: `entry/src/main/ets/common/Constants.ets` (已标记为废弃)

### 1.3 主要功能

#### 用户登录
```typescript
import { UserSessionService } from '../service/UserSessionService';

// 登录
const result = await UserSessionService.login('user@example.com', 'password');
if (result.success) {
  console.log('登录成功:', result.session);
}
```

#### 用户注册
```typescript
const result = await UserSessionService.register('张三', 'user@example.com', 'password');
if (result.success) {
  console.log('注册成功并自动登录');
}
```

#### 获取当前用户
```typescript
// 获取当前登录用户ID
const userId = UserSessionService.getCurrentUserId();

// 获取完整会话信息
const session = UserSessionService.getCurrentSession();

// 检查是否已登录
if (UserSessionService.isLoggedIn()) {
  // 已登录
}
```

#### 用户登出
```typescript
UserSessionService.logout();
```

### 1.4 会话管理特性

- **会话超时**: 24小时自动过期
- **自动续期**: 每次操作自动更新最后活跃时间
- **会话令牌**: 每个会话生成唯一令牌
- **密码加密**: 使用SHA-256哈希存储密码

### 1.5 迁移指南

**旧代码**:
```typescript
import { CURRENT_USER_ID } from '../common/Constants';
const userId = CURRENT_USER_ID;
```

**新代码**:
```typescript
import { UserSessionService } from '../service/UserSessionService';
const userId = UserSessionService.getCurrentUserId();

// 兼容处理（如果未登录，使用默认值1）
const userId = UserSessionService.getCurrentUserId() || 1;
```

---

## 2. 定期账单/预算提醒

### 2.1 功能说明

提供灵活的提醒功能，支持一次性、每日、每周、每月、每年等多种频率。

### 2.2 核心文件

- **模型**: `entry/src/main/ets/model/Reminder.ets`
- **DAO**: `entry/src/main/ets/dao/ReminderDAO.ets`
- **服务**: `entry/src/main/ets/service/ReminderService.ets`

### 2.3 数据库表结构

```sql
CREATE TABLE reminders (
  reminder_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('bill', 'budget')),
  title TEXT NOT NULL,
  description TEXT,
  amount REAL,
  category_id INTEGER,
  account_id INTEGER,
  budget_id INTEGER,
  frequency TEXT NOT NULL CHECK (frequency IN ('once', 'daily', 'weekly', 'monthly', 'yearly')),
  reminder_date TEXT NOT NULL,
  next_reminder_date TEXT NOT NULL,
  is_active INTEGER DEFAULT 1,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  is_deleted INTEGER DEFAULT 0,
  FOREIGN KEY (user_id) REFERENCES users(user_id),
  FOREIGN KEY (category_id) REFERENCES categories(category_id),
  FOREIGN KEY (account_id) REFERENCES accounts(account_id),
  FOREIGN KEY (budget_id) REFERENCES budgets(budget_id)
);
```

### 2.4 使用示例

#### 创建账单提醒
```typescript
import { ReminderService } from '../service/ReminderService';

const reminderId = await ReminderService.createReminder({
  userId: 1,
  type: 'bill',
  title: '房租提醒',
  description: '每月1号缴纳房租',
  amount: 3000,
  categoryId: 10,
  frequency: 'monthly',
  reminderDate: '2025-01-01T09:00:00.000Z'
});
```

#### 创建预算提醒
```typescript
const reminderId = await ReminderService.createBudgetReminder(
  userId,
  budgetId,
  '2025-01-01T09:00:00.000Z',
  'monthly'
);
```

#### 检查并触发到期提醒
```typescript
// 定期调用（如每小时检查一次）
const results = await ReminderService.checkAndTriggerDueReminders(userId);
console.log('触发了', results.length, '个提醒');
```

#### 获取活跃提醒
```typescript
const activeReminders = await ReminderService.getActiveReminders(userId);
```

#### 获取即将到期的提醒
```typescript
// 获取未来7天内的提醒
const upcomingReminders = await ReminderService.getUpcomingReminders(userId, 7);
```

#### 激活/停用提醒
```typescript
await ReminderService.toggleReminder(reminderId, false); // 停用
await ReminderService.toggleReminder(reminderId, true);  // 激活
```

### 2.5 提醒频率说明

| 频率 | 说明 | 下次提醒计算 |
|------|------|-------------|
| once | 一次性 | 触发后自动停用 |
| daily | 每日 | 当前日期 + 1天 |
| weekly | 每周 | 当前日期 + 7天 |
| monthly | 每月 | 当前日期 + 1月 |
| yearly | 每年 | 当前日期 + 1年 |

### 2.6 通知集成

提醒服务使用HarmonyOS的通知管理器发送系统通知：

```typescript
import notificationManager from '@ohos.notificationManager';

// 发送通知
await notificationManager.publish({
  id: reminderId,
  content: {
    notificationContentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
    normal: {
      title: '房租提醒',
      text: '每月1号缴纳房租',
      additionalText: '金额: 3000'
    }
  }
});
```

---

## 3. 数据云端同步

### 3.1 功能说明

提供数据云端同步功能，支持上传、下载和双向同步，支持全量和增量同步。

### 3.2 核心文件

- **模型**: `entry/src/main/ets/model/CloudSyncRecord.ets`
- **DAO**: `entry/src/main/ets/dao/CloudSyncRecordDAO.ets`
- **服务**: `entry/src/main/ets/service/CloudSyncService.ets`

### 3.3 数据库表结构

```sql
CREATE TABLE cloud_sync_records (
  sync_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  sync_type TEXT NOT NULL CHECK (sync_type IN ('full', 'incremental')),
  sync_direction TEXT NOT NULL CHECK (sync_direction IN ('upload', 'download', 'bidirectional')),
  status TEXT NOT NULL CHECK (status IN ('pending', 'in_progress', 'completed', 'failed')),
  data_types TEXT NOT NULL,
  record_count INTEGER DEFAULT 0,
  start_time TEXT NOT NULL,
  end_time TEXT,
  error_message TEXT,
  cloud_provider TEXT NOT NULL CHECK (cloud_provider IN ('huawei', 'custom')),
  last_sync_hash TEXT,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);
```

### 3.4 使用示例

#### 执行双向同步
```typescript
import { CloudSyncService } from '../service/CloudSyncService';

const result = await CloudSyncService.sync({
  userId: 1,
  syncType: 'incremental',
  syncDirection: 'bidirectional',
  dataTypes: ['accounts', 'bills', 'categories', 'budgets'],
  cloudProvider: 'huawei'
});

if (result.success) {
  console.log('同步成功，同步了', result.recordCount, '条记录');
  console.log('耗时:', result.duration, 'ms');
}
```

#### 仅上传到云端
```typescript
const result = await CloudSyncService.sync({
  userId: 1,
  syncType: 'full',
  syncDirection: 'upload',
  dataTypes: ['accounts', 'bills'],
  encryptData: true,
  password: 'encryption_password'
});
```

#### 仅从云端下载
```typescript
const result = await CloudSyncService.sync({
  userId: 1,
  syncDirection: 'download'
});
```

#### 获取同步历史
```typescript
const history = await CloudSyncService.getSyncHistory(userId, 20);
```

#### 获取最后同步时间
```typescript
const lastSyncTime = await CloudSyncService.getLastSyncTime(userId);
console.log('最后同步时间:', lastSyncTime);
```

#### 获取同步统计
```typescript
const stats = await CloudSyncService.getSyncStatistics(userId);
console.log('总同步次数:', stats.total);
console.log('成功次数:', stats.completed);
console.log('失败次数:', stats.failed);
```

#### 取消正在进行的同步
```typescript
const cancelled = await CloudSyncService.cancelSync(userId);
```

### 3.5 同步类型说明

| 类型 | 说明 |
|------|------|
| full | 全量同步，同步所有数据 |
| incremental | 增量同步，仅同步变更数据 |

### 3.6 同步方向说明

| 方向 | 说明 |
|------|------|
| upload | 仅上传本地数据到云端 |
| download | 仅从云端下载数据到本地 |
| bidirectional | 双向同步，上传和下载 |

### 3.7 云端API集成

**重要**: 当前实现使用模拟的云端API，实际部署时需要替换为真实的云服务API。

#### 需要实现的云端API端点

1. **上传端点**: `POST /sync/upload`
   ```typescript
   // 请求
   {
     userId: number,
     data: string // JSON字符串
   }
   
   // 响应
   {
     success: boolean,
     message: string
   }
   ```

2. **下载端点**: `GET /sync/download?userId={userId}`
   ```typescript
   // 响应
   {
     success: boolean,
     data: string // JSON字符串
   }
   ```

#### 替换模拟API的位置

在 `CloudSyncService.ets` 中：

```typescript
// 替换 mockCloudUpload 方法
private static async mockCloudUpload(data: string, userId: number) {
  // 替换为真实API调用
  const response = await fetch(CloudSyncService.CLOUD_API_ENDPOINT + '/upload', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId, data })
  });
  return await response.json();
}

// 替换 mockCloudDownload 方法
private static async mockCloudDownload(userId: number) {
  // 替换为真实API调用
  const response = await fetch(CloudSyncService.CLOUD_API_ENDPOINT + '/download', {
    method: 'GET',
    headers: { 'User-Id': userId.toString() }
  });
  return await response.json();
}
```

### 3.8 数据安全

- **数据加密**: 支持可选的数据加密（使用现有的EncryptionModule）
- **数据哈希**: 使用SHA-256计算数据哈希，用于验证数据完整性
- **冲突检测**: 支持检测本地和云端数据冲突（预留接口）

---

## 4. 数据库变更

### 4.1 新增表

1. **reminders** - 提醒表
2. **cloud_sync_records** - 云端同步记录表

### 4.2 索引优化

#### reminders表索引
```sql
CREATE INDEX idx_reminders_user ON reminders (user_id) WHERE is_deleted = 0;
CREATE INDEX idx_reminders_next_date ON reminders (user_id, next_reminder_date) WHERE is_active = 1 AND is_deleted = 0;
CREATE INDEX idx_reminders_type ON reminders (user_id, type) WHERE is_deleted = 0;
```

#### cloud_sync_records表索引
```sql
CREATE INDEX idx_cloud_sync_user ON cloud_sync_records (user_id);
CREATE INDEX idx_cloud_sync_status ON cloud_sync_records (user_id, status);
CREATE INDEX idx_cloud_sync_time ON cloud_sync_records (user_id, created_at DESC);
```

---

## 5. 架构设计

### 5.1 分层架构

```
┌─────────────────────────────────────────────────┐
│           Presentation Layer (表示层)            │
│              pages/ (UI组件)                     │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│          Business Logic Layer (业务层)           │
│         - UserSessionService (会话管理)          │
│         - ReminderService (提醒服务)             │
│         - CloudSyncService (云端同步)            │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│        Data Access Layer (数据访问层)             │
│         - ReminderDAO                           │
│         - CloudSyncRecordDAO                    │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│      Infrastructure Layer (基础设施层)            │
│         - DatabaseManager (数据库管理)            │
└─────────────────────────────────────────────────┘
```

### 5.2 设计原则

- **单一职责**: 每个服务专注于一个功能领域
- **依赖倒置**: 服务层依赖DAO抽象，不依赖具体实现
- **开闭原则**: 易于扩展新功能，无需修改现有代码

---

## 6. 使用建议

### 6.1 用户会话管理

1. **应用启动时**: 检查是否有有效会话
2. **每个页面**: 使用 `UserSessionService.getCurrentUserId()` 获取当前用户
3. **登录页面**: 调用 `UserSessionService.login()` 进行登录
4. **退出功能**: 调用 `UserSessionService.logout()` 登出

### 6.2 提醒功能

1. **后台任务**: 使用HarmonyOS的后台任务定期检查提醒
2. **检查频率**: 建议每小时检查一次
3. **通知权限**: 确保应用有通知权限

### 6.3 云端同步

1. **自动同步**: 建议在应用启动和退出时自动同步
2. **手动同步**: 提供手动同步按钮供用户触发
3. **网络检查**: 同步前检查网络连接状态
4. **错误处理**: 妥善处理同步失败情况

---

## 7. 待完善功能

### 7.1 用户会话管理
- [ ] 多设备登录管理
- [ ] 记住密码功能
- [ ] 第三方登录（微信、华为账号等）
- [ ] 密码找回功能

### 7.2 提醒功能
- [ ] 提醒声音和振动设置
- [ ] 提醒延后功能
- [ ] 提醒历史记录
- [ ] 智能提醒（根据用户习惯）

### 7.3 云端同步
- [ ] 真实云端API集成
- [ ] 冲突解决策略实现
- [ ] 同步进度显示
- [ ] 断点续传
- [ ] 数据压缩

---

## 8. 测试建议

### 8.1 单元测试

```typescript
// 测试用户登录
describe('UserSessionService', () => {
  it('should login successfully', async () => {
    const result = await UserSessionService.login('test@example.com', 'password');
    expect(result.success).toBe(true);
  });
});

// 测试提醒创建
describe('ReminderService', () => {
  it('should create reminder', async () => {
    const reminderId = await ReminderService.createReminder({
      userId: 1,
      type: 'bill',
      title: '测试提醒',
      description: '测试描述',
      frequency: 'once',
      reminderDate: new Date().toISOString()
    });
    expect(reminderId).toBeGreaterThan(0);
  });
});

// 测试云端同步
describe('CloudSyncService', () => {
  it('should sync successfully', async () => {
    const result = await CloudSyncService.sync({
      userId: 1,
      syncDirection: 'upload'
    });
    expect(result.success).toBe(true);
  });
});
```

---

## 9. 性能优化

### 9.1 提醒服务
- 使用索引优化到期提醒查询
- 批量处理提醒通知
- 缓存活跃提醒列表

### 9.2 云端同步
- 增量同步减少数据传输量
- 数据压缩减少网络流量
- 异步处理避免阻塞UI

---

## 10. 安全考虑

### 10.1 用户会话
- 密码使用SHA-256哈希存储
- 会话令牌随机生成
- 会话超时自动登出

### 10.2 云端同步
- 支持数据加密传输
- 数据哈希验证完整性
- HTTPS传输（需云端支持）

---

## 版本信息

- **版本**: v1.2.0
- **更新日期**: 2025-12-08
- **作者**: 开发团队
