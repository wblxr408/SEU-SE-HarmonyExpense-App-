# 高级功能快速开始指南

本指南帮助开发者快速上手v1.2.0新增的高级功能。

---

## 1. 用户会话管理

### 快速开始

```typescript
import { UserSessionService } from '../service/UserSessionService';

// 1. 用户注册
const registerResult = await UserSessionService.register(
  '张三',
  'zhangsan@example.com',
  'password123'
);

if (registerResult.success) {
  console.log('注册成功，已自动登录');
  console.log('用户ID:', registerResult.session?.userId);
}

// 2. 用户登录
const loginResult = await UserSessionService.login(
  'zhangsan@example.com',
  'password123'
);

if (loginResult.success) {
  console.log('登录成功');
}

// 3. 获取当前用户ID（替代旧的CURRENT_USER_ID）
const userId = UserSessionService.getCurrentUserId();
if (userId) {
  console.log('当前用户ID:', userId);
} else {
  console.log('用户未登录');
}

// 4. 检查登录状态
if (UserSessionService.isLoggedIn()) {
  // 用户已登录，执行业务逻辑
  const session = UserSessionService.getCurrentSession();
  console.log('用户名:', session?.username);
  console.log('邮箱:', session?.email);
}

// 5. 用户登出
UserSessionService.logout();
```

### 在现有代码中集成

**步骤1**: 替换所有使用 `CURRENT_USER_ID` 的地方

```typescript
// 旧代码
import { CURRENT_USER_ID } from '../common/Constants';
const bills = await BillDAO.getByUserId(CURRENT_USER_ID);

// 新代码
import { UserSessionService } from '../service/UserSessionService';
const userId = UserSessionService.getCurrentUserId() || 1; // 兼容处理
const bills = await BillDAO.getByUserId(userId);
```

**步骤2**: 在应用启动时初始化会话（可选）

```typescript
// 在 EntryAbility.ets 中
import { UserSessionService } from '../service/UserSessionService';

// 如果有保存的会话信息，可以恢复
// 或者默认登录测试用户
await UserSessionService.switchUser(1);
```

---

## 2. 定期提醒功能

### 快速开始

```typescript
import { ReminderService } from '../service/ReminderService';

// 1. 创建每月房租提醒
const rentReminderId = await ReminderService.createReminder({
  userId: 1,
  type: 'bill',
  title: '房租提醒',
  description: '每月1号缴纳房租',
  amount: 3000,
  categoryId: 10, // 住房分类ID
  frequency: 'monthly',
  reminderDate: '2025-01-01T09:00:00.000Z'
});

console.log('房租提醒创建成功，ID:', rentReminderId);

// 2. 创建预算提醒
const budgetReminderId = await ReminderService.createBudgetReminder(
  1,        // userId
  5,        // budgetId
  '2025-01-15T10:00:00.000Z',
  'monthly'
);

// 3. 获取所有活跃提醒
const activeReminders = await ReminderService.getActiveReminders(1);
console.log('活跃提醒数量:', activeReminders.length);

// 4. 获取即将到期的提醒（未来7天）
const upcomingReminders = await ReminderService.getUpcomingReminders(1, 7);
console.log('即将到期的提醒:', upcomingReminders.length);

// 5. 检查并触发到期提醒（应该在后台任务中定期调用）
const results = await ReminderService.checkAndTriggerDueReminders(1);
console.log('触发了', results.length, '个提醒');

// 6. 停用提醒
await ReminderService.toggleReminder(rentReminderId, false);

// 7. 删除提醒
await ReminderService.deleteReminder(1, rentReminderId);
```

### 集成到后台任务

```typescript
// 在后台任务中定期检查提醒
import backgroundTaskManager from '@ohos.resourceschedule.backgroundTaskManager';
import { ReminderService } from '../service/ReminderService';

// 每小时检查一次
setInterval(async () => {
  try {
    const userId = UserSessionService.getCurrentUserId();
    if (userId) {
      await ReminderService.checkAndTriggerDueReminders(userId);
    }
  } catch (error) {
    console.error('检查提醒失败:', error);
  }
}, 60 * 60 * 1000); // 1小时
```

### 提醒统计

```typescript
const stats = await ReminderService.getReminderStatistics(1);
console.log('总提醒数:', stats.total);
console.log('活跃提醒:', stats.active);
console.log('账单提醒:', stats.billReminders);
console.log('预算提醒:', stats.budgetReminders);
console.log('今日到期:', stats.dueToday);
```

---

## 3. 云端同步功能

### 快速开始

```typescript
import { CloudSyncService } from '../service/CloudSyncService';

// 1. 执行双向同步（最常用）
const syncResult = await CloudSyncService.sync({
  userId: 1,
  syncType: 'incremental',      // 增量同步
  syncDirection: 'bidirectional', // 双向
  dataTypes: ['accounts', 'bills', 'categories', 'budgets']
});

if (syncResult.success) {
  console.log('同步成功');
  console.log('同步记录数:', syncResult.recordCount);
  console.log('耗时:', syncResult.duration, 'ms');
} else {
  console.error('同步失败:', syncResult.message);
}

// 2. 仅上传到云端
const uploadResult = await CloudSyncService.sync({
  userId: 1,
  syncDirection: 'upload',
  encryptData: true,           // 加密数据
  password: 'my_password'
});

// 3. 仅从云端下载
const downloadResult = await CloudSyncService.sync({
  userId: 1,
  syncDirection: 'download'
});

// 4. 全量同步（首次同步或数据重置）
const fullSyncResult = await CloudSyncService.sync({
  userId: 1,
  syncType: 'full',
  syncDirection: 'bidirectional'
});

// 5. 获取最后同步时间
const lastSyncTime = await CloudSyncService.getLastSyncTime(1);
if (lastSyncTime) {
  console.log('最后同步时间:', new Date(lastSyncTime).toLocaleString());
} else {
  console.log('从未同步过');
}

// 6. 获取同步历史
const history = await CloudSyncService.getSyncHistory(1, 10);
console.log('最近10次同步记录:', history);

// 7. 获取同步统计
const stats = await CloudSyncService.getSyncStatistics(1);
console.log('总同步次数:', stats.total);
console.log('成功次数:', stats.completed);
console.log('失败次数:', stats.failed);

// 8. 取消正在进行的同步
const cancelled = await CloudSyncService.cancelSync(1);
if (cancelled) {
  console.log('同步已取消');
}
```

### 自动同步集成

```typescript
// 在应用启动时自动同步
async function onAppLaunch() {
  const userId = UserSessionService.getCurrentUserId();
  if (userId) {
    // 后台执行同步，不阻塞UI
    CloudSyncService.sync({
      userId,
      syncType: 'incremental',
      syncDirection: 'download'
    }).catch(error => {
      console.error('自动同步失败:', error);
    });
  }
}

// 在应用退出时自动同步
async function onAppExit() {
  const userId = UserSessionService.getCurrentUserId();
  if (userId) {
    await CloudSyncService.sync({
      userId,
      syncType: 'incremental',
      syncDirection: 'upload'
    });
  }
}
```

### 网络检查

```typescript
import connection from '@ohos.net.connection';

async function syncWithNetworkCheck() {
  // 检查网络连接
  const netHandle = await connection.getDefaultNet();
  const netCapabilities = await connection.getNetCapabilities(netHandle);
  
  if (netCapabilities.hasCapability(connection.NetCap.NET_CAPABILITY_INTERNET)) {
    // 有网络连接，执行同步
    await CloudSyncService.sync({ userId: 1 });
  } else {
    console.log('无网络连接，跳过同步');
  }
}
```

---

## 4. 完整示例：记账应用集成

### 应用启动流程

```typescript
// EntryAbility.ets
import { DatabaseManager } from '../database/DatabaseManager';
import { UserSessionService } from '../service/UserSessionService';
import { CloudSyncService } from '../service/CloudSyncService';

async onWindowStageCreate(windowStage: window.WindowStage) {
  // 1. 初始化数据库
  await DatabaseManager.initDatabase(this.context);
  
  // 2. 检查登录状态或自动登录测试用户
  if (!UserSessionService.isLoggedIn()) {
    await UserSessionService.switchUser(1); // 测试用户
  }
  
  // 3. 后台同步数据
  const userId = UserSessionService.getCurrentUserId();
  if (userId) {
    CloudSyncService.sync({
      userId,
      syncType: 'incremental',
      syncDirection: 'download'
    }).catch(error => {
      console.error('启动同步失败:', error);
    });
  }
  
  // 4. 启动提醒检查任务
  this.startReminderCheckTask();
  
  // 5. 加载主页面
  windowStage.loadContent('pages/Index', (err, data) => {
    // ...
  });
}

private startReminderCheckTask() {
  // 每小时检查一次提醒
  setInterval(async () => {
    const userId = UserSessionService.getCurrentUserId();
    if (userId) {
      await ReminderService.checkAndTriggerDueReminders(userId);
    }
  }, 60 * 60 * 1000);
}
```

### 页面中使用

```typescript
// pages/Index.ets
import { UserSessionService } from '../service/UserSessionService';
import { BillDAO } from '../dao/BillDAO';
import { ReminderService } from '../service/ReminderService';

@Entry
@Component
struct Index {
  @State bills: Bill[] = [];
  @State username: string = '';
  @State upcomingReminders: Reminder[] = [];
  
  async aboutToAppear() {
    // 获取当前用户
    const session = UserSessionService.getCurrentSession();
    if (session) {
      this.username = session.username;
      
      // 加载用户数据
      await this.loadUserData(session.userId);
    } else {
      // 未登录，跳转到登录页
      router.pushUrl({ url: 'pages/Login' });
    }
  }
  
  async loadUserData(userId: number) {
    // 加载账单
    this.bills = await BillDAO.getByUserId(userId);
    
    // 加载即将到期的提醒
    this.upcomingReminders = await ReminderService.getUpcomingReminders(userId, 7);
  }
  
  async onSyncButtonClick() {
    const userId = UserSessionService.getCurrentUserId();
    if (!userId) return;
    
    // 显示加载提示
    promptAction.showToast({ message: '正在同步...' });
    
    const result = await CloudSyncService.sync({
      userId,
      syncDirection: 'bidirectional'
    });
    
    if (result.success) {
      promptAction.showToast({ message: '同步成功' });
      await this.loadUserData(userId);
    } else {
      promptAction.showToast({ message: '同步失败: ' + result.message });
    }
  }
  
  build() {
    Column() {
      // 用户信息
      Text(`欢迎, ${this.username}`)
      
      // 同步按钮
      Button('同步数据')
        .onClick(() => this.onSyncButtonClick())
      
      // 提醒提示
      if (this.upcomingReminders.length > 0) {
        Text(`您有 ${this.upcomingReminders.length} 个即将到期的提醒`)
      }
      
      // 账单列表
      List() {
        ForEach(this.bills, (bill: Bill) => {
          ListItem() {
            // 账单项
          }
        })
      }
    }
  }
}
```

---

## 5. 常见问题

### Q1: 如何在现有代码中快速集成用户会话管理？

**A**: 使用兼容模式：
```typescript
const userId = UserSessionService.getCurrentUserId() || 1;
```

### Q2: 提醒通知不显示怎么办？

**A**: 检查以下几点：
1. 应用是否有通知权限
2. 是否调用了 `checkAndTriggerDueReminders`
3. 提醒是否处于活跃状态
4. 下次提醒时间是否正确

### Q3: 云端同步失败怎么办？

**A**: 
1. 检查网络连接
2. 查看同步记录的错误信息
3. 确认云端API是否正常（当前为模拟实现）

### Q4: 如何实现真实的云端API？

**A**: 参考 `README说明/高级功能实现文档.md` 第3.7节，替换 `CloudSyncService` 中的模拟方法。

---

## 6. 下一步

1. **阅读完整文档**: `README说明/高级功能实现文档.md`
2. **查看代码示例**: 参考各个服务的实现
3. **编写测试**: 为新功能编写单元测试
4. **实现UI**: 为新功能创建用户界面
5. **集成云端API**: 替换模拟的云端API为真实实现

---

## 7. 技术支持

如有问题，请查看：
- 完整文档: `README说明/高级功能实现文档.md`
- 待迭代清单: `README说明/待迭代part.md`
- 项目架构: `README说明/项目架构说明文档.md`
